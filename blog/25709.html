<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="Java technology blog.">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Java 文件上传及下载 | Keis Note
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Keis Note</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Java 文件上传及下载</h2>
  <p class="post-date">2018-03-24</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p><img src="http://ovi3ob9p4.bkt.clouddn.com/TIETU/CT0163.jpg" alt="image"></p>
<p>Java 文件上传及下载<br><a id="more"></a></p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>　　文件上传操作通常会附加一些限制，如：文件类型、上传文件总大小、每个文件的最大大小等。除此以外，作为一个通用组件还需要考虑更多的问题，如：支持自定义文件保存目录、支持相对路径和绝对路径、支持自定义保存的文件的文件名称、支持上传进度反馈和上传失败清理等。另外，本座也不想重新造车轮，本组件是基于 Commons File Upload 实现，省却了本座大量的工作 ^_^ 下面先从一个具体的使用例子讲起：</p>
<h4 id="上传请求界面及代码"><a href="#上传请求界面及代码" class="headerlink" title="上传请求界面及代码"></a>上传请求界面及代码</h4><p><img src="http://filesimg.111cn.net/2012/02/24/20120224013306316.jpg" alt="img"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"checkupload.action"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    First Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"firstName"</span> <span class="attr">value</span>=<span class="string">"丑"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Last Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"lastName"</span> <span class="attr">value</span>=<span class="string">"怪兽"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Birthday: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"birthday"</span> <span class="attr">value</span>=<span class="string">"1978-11-03"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Gender: 男 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span>" <span class="attr">name</span>=<span class="string">"gender"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">        &amp;nbsp;女 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span>" <span class="attr">name</span>=<span class="string">"gender"</span> <span class="attr">value</span>=<span class="string">"true"</span> <span class="attr">checked</span>=<span class="string">"checked"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Working age: <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">"workingAge"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"-1"</span>&gt;</span>-请选择-<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"3"</span>&gt;</span>三年<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"5"</span> <span class="attr">selected</span>=<span class="string">"selected"</span>&gt;</span>五年<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"10"</span>&gt;</span>十年<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"20"</span>&gt;</span>二十年<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Interest: 游泳 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"interest"</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">checked</span>=<span class="string">"checked"</span>&gt;</span></span><br><span class="line">        &amp;nbsp;打球 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"interest"</span> <span class="attr">value</span>=<span class="string">"2"</span> <span class="attr">checked</span>=<span class="string">"checked"</span>&gt;</span></span><br><span class="line">        &amp;nbsp;下棋 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"interest"</span> <span class="attr">value</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">        &amp;nbsp;打麻将 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"interest"</span> <span class="attr">value</span>=<span class="string">"4"</span>&gt;</span></span><br><span class="line">        &amp;nbsp;看书 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"interest"</span> <span class="attr">value</span>=<span class="string">"5"</span> <span class="attr">checked</span>=<span class="string">"checked"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Photo 1.1: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span>" <span class="attr">name</span>=<span class="string">"photo-1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Photo 1.2: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span>" <span class="attr">name</span>=<span class="string">"photo-1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Photo 2.1: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span>" <span class="attr">name</span>=<span class="string">"photo-2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"确 定"</span>&gt;</span>&amp;nbsp;&amp;nbsp;<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"reset"</span> <span class="attr">value</span>=<span class="string">"重 置"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从上面的 HTML 代码可以看出，表单有 6 个普通域和 3 个文件域，其中前两个文件域的 name 属性相同。</p>
<h4 id="上传处理代码"><a href="#上传处理代码" class="headerlink" title="上传处理代码"></a>上传处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.bruce.util.BeanHelper;</span><br><span class="line"><span class="keyword">import</span> com.bruce.util.Logger;</span><br><span class="line"><span class="keyword">import</span> com.bruce.util.http.FileUploader;</span><br><span class="line"><span class="keyword">import</span> com.bruce.util.http.FileUploader.FileInfo;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.bruce.util.http.FileUploader.*;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckUpload</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 上传路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String UPLOAD_PATH        = <span class="string">"upload"</span>;</span><br><span class="line">    <span class="comment">// 可接受的文件类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] ACCEPT_TYPES    = &#123;<span class="string">"txt"</span>, <span class="string">"pdf"</span>, <span class="string">"doc"</span>, <span class="string">".Jpg"</span>, <span class="string">"*.zip"</span>, <span class="string">"*.RAR"</span>&#125;;</span><br><span class="line">    <span class="comment">// 总上传文件大小限制</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_SIZE            = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>;</span><br><span class="line">    <span class="comment">// 单个传文件大小限制</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_FILE_SIZE        = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 FileUploader 对象</span></span><br><span class="line">        FileUploader fu = <span class="keyword">new</span> FileUploader(UPLOAD_PATH, ACCEPT_TYPES, MAX_SIZE, MAX_FILE_SIZE);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据实际情况设置对象属性（可选）</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        fu.setFileNameGenerator(new FileNameGenerator()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public String generate(FileItem item, String suffix)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                return String.format("%d_%d", item.hashCode(), item.get().hashCode());</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        fu.setServletProgressListener(new ProgressListener()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void update(long pBytesRead, long pContentLength, int pItems)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                System.out.printf("%d: length -&gt; %d, read -&gt; %d.n", pItems, pContentLength, pBytesRead);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行上传并获取操作结果</span></span><br><span class="line">        Result result = fu.upload(getRequest(), getResponse());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查操作结果</span></span><br><span class="line">        <span class="keyword">if</span>(result != FileUploader.Result.SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 设置 request attribute</span></span><br><span class="line">            setRequestAttribute(<span class="string">"error"</span>, fu.getCause());</span><br><span class="line">            <span class="comment">// 记录日志</span></span><br><span class="line">            Logger.exception(fu.getCause(), <span class="string">"upload file fail"</span>, Level.ERROR, <span class="keyword">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过非文件表单域创建 Form Bean</span></span><br><span class="line">        Persion persion = BeanHelper.createBean(Persion.class, fu.getParamFields());</span><br><span class="line">        <span class="comment">// 图片保存路径的列表</span></span><br><span class="line">        List&lt;String&gt; photos    = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 轮询文件表单域，填充 photos */</span></span><br><span class="line">        Set&lt;String&gt; keys = fu.getFileFields().keySet();</span><br><span class="line">        <span class="keyword">for</span>(String key : keys)</span><br><span class="line">        &#123;</span><br><span class="line">            FileInfo[] ffs = fu.getFileFields().get(key);</span><br><span class="line">            <span class="keyword">for</span>(FileInfo ff : ffs)</span><br><span class="line">            &#123;</span><br><span class="line">                photos.add(String.format(<span class="string">"(%s) %s%s%s"</span>, key, fu.getSavePath(), File.separator, ff.getSaveFile().getName()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置 Form Bean 的 photos 属性</span></span><br><span class="line">        persion.setPhotos(photos);</span><br><span class="line">        <span class="comment">// 设置 request attribute</span></span><br><span class="line">        setRequestAttribute(<span class="string">"persion"</span>, persion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Persion</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> gender;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> workingAge;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] interest;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; photos;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FileInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String uploadFileName;</span><br><span class="line">    <span class="keyword">private</span> File saveFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　分析下上面的 Java 代码，本例先根据保存目录、文件大小限制和文件类型限制创建一个 FileUploader 对象，然后调用该对象的 upload() 方法执行上传并返回操作结果，如果上传成功则 通过 getParamFields() 方法获取所有非文件表单域内容，并交由 BeanHelper 进行解析创建 Form Bean，再调用 getFileFields() 方法获取所有文件表单域的 FileInfo（FileInfo 包含上传文件的原始名称和被保存文件的 File 对象），最后完成 Form Bean 所有字段的填充并把 Form Bean 设置为 request 属性。</p>
<h4 id="上传结果界面及代码"><a href="#上传结果界面及代码" class="headerlink" title="上传结果界面及代码"></a>上传结果界面及代码</h4><p><img src="http://filesimg.111cn.net/2012/02/24/20120224013312738.jpg" alt="img"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">caption</span>&gt;</span>Persion Attributs<span class="tag">&lt;/<span class="name">caption</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;persion.firstName&#125; $&#123;persion.lastName&#125;"</span>/&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Brithday<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;persion.birthday&#125;"</span>/&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Gender<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;persion.gender&#125;"</span>/&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Working Age<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;persion.workingAge&#125;"</span>/&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Interest<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">var</span>=<span class="string">"its"</span> <span class="attr">items</span>=<span class="string">"$&#123;persion.interest&#125;"</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;its&#125;"</span> /&gt;</span> &amp;nbsp;</span><br><span class="line">                          <span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Photos<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">var</span>=<span class="string">"p"</span> <span class="attr">items</span>=<span class="string">"$&#123;persion.photos&#125;"</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;p&#125;"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span>&amp;nbsp;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 　　从上面的处理结果可以看出，文件上传组件 FileUploader 正确地处理了表单的所有文件域和非文件域名，并且，整个文件上传操作过程非常简单，无需用户过多参与。下面我们来详细看看组件的主要实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    / 不限制文件上传总大小的 Size Max 常量 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> NO_LIMIT_SIZE_MAX        = -<span class="number">1</span>;</span><br><span class="line">    / 不限制文件上传单个文件大小的 File Size Max 常量 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> NO_LIMIT_FILE_SIZE_MAX    = -<span class="number">1</span>;</span><br><span class="line">    / 默认的写文件阀值 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SIZE_THRESHOLD    = DiskFileItemFactory.DEFAULT_SIZE_THRESHOLD;</span><br><span class="line">    / 默认的文件名生成器 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FileNameGenerator DEFAULT_FILE_NAME_GENERATOR = <span class="keyword">new</span> CommonFileNameGenerator();</span><br><span class="line">    </span><br><span class="line">    / 设置上传文件的保存路径（不包含文件名）</span><br><span class="line">     * </span><br><span class="line">     * 文件路径，可能是绝对路径或相对路径&lt;br&gt;</span><br><span class="line">     *     <span class="number">1</span>) 绝对路径：以根目录符开始（如：<span class="string">'/'</span>、<span class="string">'D:'</span>），是服务器文件系统的路径&lt;br&gt;</span><br><span class="line">     *     <span class="number">2</span>) 相对路径：不以根目录符开始，是相对于 WEB 应用程序 Context 的路径，（如：mydir 是指</span><br><span class="line">     *         <span class="string">'$&#123;WEB-APP-DIR&#125;/mydir'</span>）&lt;br&gt;</span><br><span class="line">     *     <span class="number">3</span>) 规则：上传文件前会检查该路径是否存在，如果不存在则会尝试生成该路径，如果生成失败则</span><br><span class="line">     *         上传失败并返回 &#123;@link Result#INVALID_SAVE_PATH&#125;</span><br><span class="line">     * </span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">private</span> String savePath;</span><br><span class="line">    / 文件上传的总文件大小限制 */</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sizeMax                        = NO_LIMIT_SIZE_MAX;</span><br><span class="line">    / 文件上传的单个文件大小限制 */</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> fileSizeMax                    = NO_LIMIT_FILE_SIZE_MAX;</span><br><span class="line">    / 可接受的上传文件类型集合，默认：不限制 */</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; acceptTypes                = <span class="keyword">new</span> LStrSet();</span><br><span class="line">    / 非文件表单域的映射 */</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String[]&gt; paramFields    = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</span><br><span class="line">    / 文件表单域的映射 */</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, FileInfo[]&gt; fileFields    = <span class="keyword">new</span> HashMap&lt;String, FileInfo[]&gt;();</span><br><span class="line">    / 文件名生成器 */</span><br><span class="line">    <span class="keyword">private</span> FileNameGenerator fileNameGenerator    = DEFAULT_FILE_NAME_GENERATOR;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// commons file upload 相关属性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> factorySizeThreshold            = DEFAULT_SIZE_THRESHOLD;</span><br><span class="line">    <span class="keyword">private</span> String factoryRepository;</span><br><span class="line">    <span class="keyword">private</span> FileCleaningTracker factoryCleaningTracker;</span><br><span class="line">    <span class="keyword">private</span> String servletHeaderencoding;</span><br><span class="line">    <span class="keyword">private</span> ProgressListener servletProgressListener;</span><br><span class="line">    </span><br><span class="line">    / 文件上传失败的原因（文件上传失败时使用） */</span><br><span class="line">    <span class="keyword">private</span> Throwable cause;</span><br><span class="line">    </span><br><span class="line">    / 执行上传</span><br><span class="line">     * </span><br><span class="line">     * <span class="meta">@param</span> request    : &#123;<span class="meta">@link</span> HttpServletRequest&#125; 对象</span><br><span class="line">     * <span class="meta">@param</span> response    : &#123;<span class="meta">@link</span> HttpServletResponse&#125; 对象</span><br><span class="line">     * </span><br><span class="line">     * @return            : 成功：返回 &#123;@link Result#SUCCESS&#125; ，失败：返回其他结果，</span><br><span class="line">     *                       失败原因通过 &#123;@link FileUploader#getCause()&#125; 获取</span><br><span class="line">     * </span><br><span class="line">     */</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">upload</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        reset();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上传目录绝对路径</span></span><br><span class="line">        String absolutePath     = getAbsoluteSavePath(request);</span><br><span class="line">        <span class="keyword">if</span>(absolutePath == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cause = <span class="keyword">new</span> FileNotFoundException(String.format(<span class="string">"path '%s' not found or is not directory"</span>, savePath));</span><br><span class="line">            <span class="keyword">return</span> Result.INVALID_SAVE_PATH;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ServletFileUpload sfu    = getFileUploadComponent();</span><br><span class="line">        List&lt;FileItemInfo&gt; fiis    = <span class="keyword">new</span> ArrayList&lt;FileItemInfo&gt;();</span><br><span class="line">        </span><br><span class="line">        List&lt;FileItem&gt; items    = <span class="keyword">null</span>;</span><br><span class="line">        Result result            = Result.SUCCESS;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取文件名生成器</span></span><br><span class="line">        String encoding                    = servletHeaderencoding != <span class="keyword">null</span> ? servletHeaderencoding : request.getCharacterEncoding();</span><br><span class="line">        FileNameGenerator fnGenerator    = fileNameGenerator != <span class="keyword">null</span> ? fileNameGenerator : DEFAULT_FILE_NAME_GENERATOR;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 执行上传操作</span></span><br><span class="line">            items = (List&lt;FileItem&gt;)sfu.parseRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (FileUploadException e)</span><br><span class="line">        &#123;</span><br><span class="line">            cause = e;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(e <span class="keyword">instanceof</span> FileSizeLimitExceededException)        result = Result.FILE_SIZE_EXCEEDED;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> SizeLimitExceededException)    result = Result.SIZE_EXCEEDED;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> InvalidContentTypeException)    result = Result.INVALID_CONTENT_TYPE;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> IOFileUploadException)            result = Result.FILE_UPLOAD_IO_EXCEPTION;</span><br><span class="line">            <span class="keyword">else</span>                                                result = Result.OTHER_PARSE_REQUEST_EXCEPTION;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(result == Result.SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 解析所有表单域</span></span><br><span class="line">            result = parseFileItems(items, fnGenerator, absolutePath, encoding, fiis);    </span><br><span class="line">            <span class="keyword">if</span>(result == Result.SUCCESS)</span><br><span class="line">                <span class="comment">// 保存文件</span></span><br><span class="line">                result = writeFiles(fiis);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析所有表单域</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Result <span class="title">parseFileItems</span><span class="params">(List&lt;FileItem&gt; items, FileNameGenerator fnGenerator, String absolutePath, String encoding, List&lt;FileItemInfo&gt; fiis)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(FileItem item : items)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(item.isFormField())</span><br><span class="line">                <span class="comment">// 解析非文件表单域</span></span><br><span class="line">                parseFormField(item, encoding);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(item.getSize() == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 解析文件表单域</span></span><br><span class="line">                Result result = parseFileField(item, absolutePath, fnGenerator, fiis);</span><br><span class="line">                <span class="keyword">if</span>(result != Result.SUCCESS)</span><br><span class="line">                &#123;</span><br><span class="line">                    reset();</span><br><span class="line">                    </span><br><span class="line">                    cause = <span class="keyword">new</span> InvalidParameterException(String.format(<span class="string">"file '%s' not accepted"</span>, item.getName()));</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析文件表单域</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Result <span class="title">parseFileField</span><span class="params">(FileItem item, String absolutePath, FileNameGenerator fnGenerator, List&lt;FileItemInfo&gt; fiis)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String suffix            = <span class="keyword">null</span>;</span><br><span class="line">        String uploadFileName    = item.getName();</span><br><span class="line">        <span class="keyword">boolean</span> isAcceptType    = acceptTypes.isEmpty();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!isAcceptType)</span><br><span class="line">        &#123;</span><br><span class="line">            suffix = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> stuffPos = uploadFileName.lastIndexOf(<span class="string">"."</span>);</span><br><span class="line">            <span class="keyword">if</span>(stuffPos != -<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                suffix = uploadFileName.substring(stuffPos, uploadFileName.length()).toLowerCase();</span><br><span class="line">                isAcceptType = acceptTypes.contains(suffix);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!isAcceptType)</span><br><span class="line">            <span class="keyword">return</span> Result.INVALID_FILE_TYPE;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过文件名生成器获取文件名</span></span><br><span class="line">        String saveFileName = fnGenerator.generate(item, suffix);</span><br><span class="line">        <span class="keyword">if</span>(!saveFileName.endsWith(suffix))</span><br><span class="line">            saveFileName += suffix;</span><br><span class="line">        </span><br><span class="line">        String fullFileName    = absolutePath + File.separator + saveFileName;</span><br><span class="line">        File saveFile        = <span class="keyword">new</span> File(fullFileName);</span><br><span class="line">        FileInfo info        = <span class="keyword">new</span> FileInfo(uploadFileName, saveFile);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加表单域文件信息</span></span><br><span class="line">        fiis.add(<span class="keyword">new</span> FileItemInfo(item, saveFile));</span><br><span class="line">        addFileField(item.getFieldName(), info);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseFormField</span><span class="params">(FileItem item, String encoding)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String name = item.getFieldName();</span><br><span class="line">        String value = item.getString();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 字符串编码转换</span></span><br><span class="line">        <span class="keyword">if</span>(!GeneralHelper.isStrEmpty(value) &amp;&amp; encoding != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                value = <span class="keyword">new</span> String(value.getBytes(<span class="string">"ISO-8859-1"</span>), encoding);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(UnsupportedEncodingException e)</span><br><span class="line">            &#123;</span><br><span class="line">    </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加表单域名/值映射</span></span><br><span class="line">        addParamField(name, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    / 文件名生成器接口</span><br><span class="line">     * </span><br><span class="line">     * 每次保存一个上传文件前都需要调用该接口的 &#123;@link FileNameGenerator#generate&#125; 方法生成要保存的文件名</span><br><span class="line">     *  </span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileNameGenerator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        / 文件名生成方法</span><br><span class="line">         * </span><br><span class="line">         * <span class="meta">@param</span> item        : 上传文件对应的 &#123;<span class="meta">@link</span> FileItem&#125; 对象</span><br><span class="line">         * <span class="meta">@param</span> suffix    : 上传文件的后缀名</span><br><span class="line">         * </span><br><span class="line">         */</span><br><span class="line">        <span class="function">String <span class="title">generate</span><span class="params">(FileItem item, String suffix)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    / 默认通用文件名生成器</span><br><span class="line">     * </span><br><span class="line">     * 实现 &#123;<span class="meta">@link</span> FileNameGenerator&#125; 接口，根据序列值和时间生成唯一文件名</span><br><span class="line">     *  </span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonFileNameGenerator</span> <span class="keyword">implements</span> <span class="title">FileNameGenerator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_SERIAL            = <span class="number">999999</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger atomic = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNextInteger</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> value = atomic.incrementAndGet();</span><br><span class="line">            <span class="keyword">if</span>(value &gt;= MAX_SERIAL)</span><br><span class="line">                atomic.set(<span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        / 根据序列值和时间生成 <span class="string">'XXXXXX_YYYYYYYYYYYYY'</span> 格式的唯一文件名 */</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">generate</span><span class="params">(FileItem item, String suffix)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> serial        = getNextInteger();</span><br><span class="line">            <span class="keyword">long</span> millsec    = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">"%06d_%013d"</span>, serial, millsec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    / 上传文件信息结构体 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FileInfo</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String uploadFileName;</span><br><span class="line">        <span class="keyword">private</span> File saveFile;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// getters and setters ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FileItemInfo</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        FileItem item;</span><br><span class="line">        File file;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// getters and setters ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    / 文件上传结果枚举值 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> Result</span><br><span class="line">    &#123;</span><br><span class="line">        / 成功 */</span><br><span class="line">        SUCCESS,</span><br><span class="line">        / 失败：文件总大小超过限制 */</span><br><span class="line">        SIZE_EXCEEDED,</span><br><span class="line">        / 失败：单个文件大小超过限制 */</span><br><span class="line">        FILE_SIZE_EXCEEDED,</span><br><span class="line">        / 失败：请求表单类型不正确 */</span><br><span class="line">        INVALID_CONTENT_TYPE,</span><br><span class="line">        / 失败：文件上传 IO 错误 */</span><br><span class="line">        FILE_UPLOAD_IO_EXCEPTION,</span><br><span class="line">        / 失败：解析上传请求其他异常 */</span><br><span class="line">        OTHER_PARSE_REQUEST_EXCEPTION,</span><br><span class="line">        / 失败：文件类型不正确 */</span><br><span class="line">        INVALID_FILE_TYPE,</span><br><span class="line">        / 失败：文件写入失败 */</span><br><span class="line">        WRITE_FILE_FAIL,</span><br><span class="line">        / 失败：文件的保存路径不正确 */</span><br><span class="line">        INVALID_SAVE_PATH;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>应用可以实现自己的 FileNameGenerator 类替代默认的文件名生成器。</p>
</li>
<li><p>上传操作通过 FileUploader.Result 返回结果，并没有采用抛出异常的方式，因为本座认为在这里采用异常方式报告结果其实并不方便使用；另一方面，程序可以通过 getCause() 获取详细的错误信息。</p>
</li>
</ul>
<h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><p>　　相对于文件上传，文件下载则简单很多，主要实现流程是根据文件名找到实际文件，并利用 Java 的相关类对 I/O 流进行读写。下面先看看一个使用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.bruce.util.http.FileDownloader.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDownload</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 绝对路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ABSOLUTE_PATH    = <span class="string">"/Server/apache-tomcat-6.0.32/webapps/portal/download/下载测试 - 文本文件.txt"</span>;</span><br><span class="line">    <span class="comment">// 相对路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RELATE_PATH        = <span class="string">"download/下载测试 - 项目框架.jpg"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> type            = getIntParam(<span class="string">"type"</span>, <span class="number">1</span>);</span><br><span class="line">        String filePath        = (type == <span class="number">1</span> ? ABSOLUTE_PATH : RELATE_PATH);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 FileDownloader 对象</span></span><br><span class="line">        FileDownloader fdl    = <span class="keyword">new</span> FileDownloader(filePath);</span><br><span class="line">        <span class="comment">// 执行下载</span></span><br><span class="line">        Result result = fdl.downLoad(getRequest(), getResponse());</span><br><span class="line">        <span class="comment">// 检查下载结果</span></span><br><span class="line">        <span class="keyword">if</span>(result != Result.SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录日志</span></span><br><span class="line">            Logger.exception(fdl.getCause(), String.format(<span class="string">"download file '%s' fail"</span>, fdl.getFilePath()), Level.ERROR, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> NONE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这个示例可以看出，文件下载组件的使用方法更简单，因为它不需要对下载结果进行很多处理。可以看出该组件也支持相对路径和绝对路径。下面我们来详细看看组件的主要实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">/ 文件下载器 */</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDownloader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    / 默认字节交换缓冲区大小 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_BUFFER_SIZE        = <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">    / 下载文件的默认 Mime Type */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTENT_TYPE    = <span class="string">"application/force-download"</span>;</span><br><span class="line">    </span><br><span class="line">    / 设置下载文件的路径（包含文件名） </span><br><span class="line">     * </span><br><span class="line">     * filePath    : 文件路径，可能是绝对路径或相对路径&lt;br&gt;</span><br><span class="line">     *                 <span class="number">1</span>) 绝对路径：以根目录符开始（如：<span class="string">'/'</span>、<span class="string">'D:'</span>），是服务器文件系统的路径&lt;br&gt;</span><br><span class="line">     *                 <span class="number">2</span>) 相对路径：不以根目录符开始，是相对于 WEB 应用程序 Context 的路径，（如：mydir/myfile 是指 <span class="string">'$&#123;WEB-APP-DIR&#125;/mydir/myfile'</span>）</span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">private</span> String filePath;</span><br><span class="line">    / 显示在浏览器的下载对话框中的文件名称，默认与  filePath 参数中的文件名一致 */</span><br><span class="line">    <span class="keyword">private</span> String saveFileName;</span><br><span class="line">    / 下载文件的 Mime Type，默认：&#123;@link FileDownloader#DEFAULT_CONTENT_TYPE&#125; */</span><br><span class="line">    <span class="keyword">private</span> String contentType        = DEFAULT_CONTENT_TYPE;</span><br><span class="line">    / 字节缓冲区大小，默认：&#123;@link FileDownloader#DEFAULT_CONTENT_TYPE&#125; */</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bufferSize            = DEFAULT_BUFFER_SIZE;</span><br><span class="line">    / 获取文件下载失败的原因（文件下载失败时使用） */</span><br><span class="line">    <span class="keyword">private</span> Throwable cause;</span><br><span class="line">    </span><br><span class="line">    / 执行下载</span><br><span class="line">     * </span><br><span class="line">     * <span class="meta">@param</span> request    : &#123;<span class="meta">@link</span> HttpServletRequest&#125; 对象</span><br><span class="line">     * <span class="meta">@param</span> response    : &#123;<span class="meta">@link</span> HttpServletResponse&#125; 对象</span><br><span class="line">     * </span><br><span class="line">     * @return            : 成功：返回 &#123;@link Result#SUCCESS&#125; ，失败：返回其他结果，</span><br><span class="line">     *                       失败原因通过 &#123;@link FileDownloader#getCause()&#125; 获取</span><br><span class="line">     * </span><br><span class="line">     */</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">downLoad</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        reset();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取要下载的文件的 File 对象</span></span><br><span class="line">            File file = getFile(request);</span><br><span class="line">            <span class="comment">// 执行下载操作</span></span><br><span class="line">            downLoadFile(request, response, file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            cause = e;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(e <span class="keyword">instanceof</span> FileNotFoundException)    <span class="keyword">return</span> Result.FILE_NOT_FOUND;</span><br><span class="line">            <span class="keyword">if</span>(e <span class="keyword">instanceof</span> IOException)            <span class="keyword">return</span> Result.READ_WRITE_FAIL;</span><br><span class="line">                                                    <span class="keyword">return</span> Result.UNKNOWN_EXCEPTION;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行下载操作</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">downLoadFile</span><span class="params">(HttpServletRequest request, HttpServletResponse response, File file)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String fileName            = <span class="keyword">new</span> String(saveFileName.getBytes(), <span class="string">"ISO-8859-1"</span>);</span><br><span class="line">        <span class="comment">// 解析 HTTP 请求头，获取文件的读取范围</span></span><br><span class="line">        Range&lt;Integer&gt; range    = parseDownloadRange(request);    </span><br><span class="line">        <span class="keyword">int</span> length                = (<span class="keyword">int</span>)file.length();</span><br><span class="line">        <span class="keyword">int</span> begin                = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end                    = length - <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置 HTTP 响应头</span></span><br><span class="line">        response.setContentType(contentType);</span><br><span class="line">        response.setContentLength(length);</span><br><span class="line">        response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确定文件的读取范围（用于断点续传）</span></span><br><span class="line">        <span class="keyword">if</span>(range != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(range.getBegin()    != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                begin = range.getBegin();</span><br><span class="line">                <span class="keyword">if</span>(range.getEnd() != <span class="keyword">null</span>)</span><br><span class="line">                    end = range.getEnd();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(range.getEnd() != <span class="keyword">null</span>)</span><br><span class="line">                    begin = end + range.getEnd() + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            String contentRange = String.format(<span class="string">"bytes %d-%d/%d"</span>, begin, end, length);</span><br><span class="line">            response.setHeader(<span class="string">"Accept-Ranges"</span>, <span class="string">"bytes"</span>);</span><br><span class="line">            response.setHeader(<span class="string">"Content-Range"</span>, contentRange);</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_PARTIAL_CONTENT);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 实际执行下载操作</span></span><br><span class="line">        doDownloadFile(response, file, begin, end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际执行下载操作</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDownloadFile</span><span class="params">(HttpServletResponse response, File file, <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        InputStream is    = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream os    = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] b    = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferSize];</span><br><span class="line">            is            = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">            os            = <span class="keyword">new</span> BufferedOutputStream(response.getOutputStream());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳过已下载的文件内容</span></span><br><span class="line">            is.skip(begin);</span><br><span class="line">            <span class="comment">// I/O 读写</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i, left = end - begin + <span class="number">1</span>; left &gt; <span class="number">0</span> &amp;&amp; ((i = is.read(b, <span class="number">0</span>, Math.min(b.length, left))) != -<span class="number">1</span>); left -= i)</span><br><span class="line">                os.write(b, <span class="number">0</span>, i);</span><br><span class="line">            </span><br><span class="line">            os.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(is != <span class="keyword">null</span>) &#123;<span class="keyword">try</span>&#123;is.close();&#125; <span class="keyword">catch</span>(IOException e) &#123;&#125;&#125;</span><br><span class="line">            <span class="keyword">if</span>(os != <span class="keyword">null</span>) &#123;<span class="keyword">try</span>&#123;os.close();&#125; <span class="keyword">catch</span>(IOException e) &#123;&#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    / 文件下载结果枚举值 */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> Result</span><br><span class="line">    &#123;</span><br><span class="line">        / 成功 */</span><br><span class="line">        SUCCESS,</span><br><span class="line">        / 失败：文件不存在 */</span><br><span class="line">        FILE_NOT_FOUND,</span><br><span class="line">        / 失败：读写操作失败 */</span><br><span class="line">        READ_WRITE_FAIL,</span><br><span class="line">        / 失败：未知异常 */</span><br><span class="line">        UNKNOWN_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#fileupload" >
    <span class="tag-code">fileupload</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/blog/58642.html">
        <span class="nav-arrow">← </span>
        
          Java NIO Path and Files
        
      </a>
    
    
      <a class="nav-right" href="/blog/44283.html">
        
          maven项目操作技巧
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#文件上传"><span class="toc-nav-text">文件上传</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#上传请求界面及代码"><span class="toc-nav-text">上传请求界面及代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#上传处理代码"><span class="toc-nav-text">上传处理代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#上传结果界面及代码"><span class="toc-nav-text">上传结果界面及代码</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#文件下载"><span class="toc-nav-text">文件下载</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://m.iskei.cn/blog/25709.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "imcco";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Java 文件上传及下载",
        owner: "imcco",
        repo: "m.github.io",
        oauth: {
          client_id: "ee7ec372a862879e3f2c",
          client_secret: "00a58ccb1a0555f87a87dc3a1b779ee8d12ded80"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2018 | Proudly powered by <a href="https://vuejs.io" target="_blank">vueJs</a>
    <br>
    Theme by <a href="https://github.com/imcco">Imcco</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>

  </body>
</html>