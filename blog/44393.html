<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="Java technology blog.">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Java技术重点回顾 | Keis Note
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Keis Note</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Java技术重点回顾</h2>
  <p class="post-date">2018-01-11</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p><img src="http://ovi3ob9p4.bkt.clouddn.com/TIETU/CT0089.jpg" alt="image"></p>
<p>Java技术重点回顾<br><a id="more"></a></p>
<h1 id="JavaI-O"><a href="#JavaI-O" class="headerlink" title="JavaI/O"></a>JavaI/O</h1><p>　　Java中和I/O操作相关的内容，I/O也是编程语言的一个基础特性，Java中的I/O分为两种类型，一种是顺序读取，一种是随机读取。</p>
<p>　　我们先来看顺序读取，有两种方式可以进行顺序读取，一种是InputStream/OutputStream，它是针对字节进行操作的输入输出流；另外一种是Reader/Writer，它是针对字符进行操作的输入输出流。</p>
<h2 id="InputStream的结构"><a href="#InputStream的结构" class="headerlink" title="InputStream的结构"></a>InputStream的结构</h2><ul>
<li>FileInputStream：操作文件，经常和BufferedInputStream一起使用</li>
<li>PipedInputStream：可用于线程间通信</li>
<li>ObjectInputStream：可用于对象序列化</li>
<li>ByteArrayInputStream：用于处理字节数组的输入</li>
<li>LineNumberInputStream：可输出当前行数，并且可以在程序中进行修改</li>
</ul>
<h2 id="OutputStream的结构"><a href="#OutputStream的结构" class="headerlink" title="OutputStream的结构"></a>OutputStream的结构</h2><p>PrintStream：提供了类似print和println的接口去输出数据<br>　　下面我们来看如何使用Stream的方式来操作输入输出</p>
<h3 id="使用InputStream读取文件"><a href="#使用InputStream读取文件" class="headerlink" title="使用InputStream读取文件"></a>使用InputStream读取文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">使用FileInputStream读取文件信息</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] readFileByFileInputStream(File file) <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    ByteArrayOutputStream output = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytesRead = fis.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            output.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during reading "</span> + file.getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis !=<span class="keyword">null</span>) fis.close();</span><br><span class="line">        <span class="keyword">if</span> (output !=<span class="keyword">null</span>) output.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> output.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用BufferedInputStream读取文件"><a href="#使用BufferedInputStream读取文件" class="headerlink" title="使用BufferedInputStream读取文件"></a>使用BufferedInputStream读取文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] readFileByBufferedInputStream(File file) <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    BufferedInputStream bis = <span class="keyword">null</span>;</span><br><span class="line">    ByteArrayOutputStream output = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        bis = <span class="keyword">new</span> BufferedInputStream(fis);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytesRead = bis.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            output.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during reading "</span> + file.getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) fis.close();</span><br><span class="line">        <span class="keyword">if</span> (bis != <span class="keyword">null</span>) bis.close();</span><br><span class="line">        <span class="keyword">if</span> (output != <span class="keyword">null</span>) output.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> output.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用OutputStream复制文件"><a href="#使用OutputStream复制文件" class="headerlink" title="使用OutputStream复制文件"></a>使用OutputStream复制文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFileByFileOutputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(file.getName() + <span class="string">".bak"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytesRead = fis.read(buffer,<span class="number">0</span>,buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            fos.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during copying "</span> + file.getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) fis.close();</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="keyword">null</span>) fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用BufferedOutputStream复制文件"><a href="#使用BufferedOutputStream复制文件" class="headerlink" title="使用BufferedOutputStream复制文件"></a>使用BufferedOutputStream复制文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFilebyBufferedOutputStream</span><span class="params">(File file)</span><span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    BufferedInputStream bis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    BufferedOutputStream bos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        bis = <span class="keyword">new</span> BufferedInputStream(fis);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(file.getName() + <span class="string">".bak"</span>);</span><br><span class="line">        bos = <span class="keyword">new</span> BufferedOutputStream(fos);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytesRead = bis.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bos.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">        bos.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during copying "</span> + file.getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) fis.close();</span><br><span class="line">        <span class="keyword">if</span> (bis != <span class="keyword">null</span>) bis.close();</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="keyword">null</span>) fos.close();</span><br><span class="line">        <span class="keyword">if</span> (bos != <span class="keyword">null</span>) bos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码对异常的处理非常不完整，稍后我们会给出完整严谨的代码。</p>
<h2 id="Reader的结构"><a href="#Reader的结构" class="headerlink" title="Reader的结构"></a>Reader的结构</h2><p>这里的Reader基本上和InputStream能够对应上。　　</p>
<h2 id="Writer的结构"><a href="#Writer的结构" class="headerlink" title="Writer的结构"></a>Writer的结构</h2><p>下面我们来看一些使用Reader或者Writer的例子</p>
<p>使用Reader读取文件内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readFile</span><span class="params">(String file)</span><span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during reading "</span> + file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (br != <span class="keyword">null</span>) br.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用Writer复制文件"><a href="#使用Writer复制文件" class="headerlink" title="使用Writer复制文件"></a>使用Writer复制文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String file)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">    BufferedWriter bw = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">        bw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(file + <span class="string">".bak"</span>));</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine())!= <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bw.write(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during copying "</span> + file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (br != <span class="keyword">null</span>) br.close();</span><br><span class="line">        <span class="keyword">if</span> (bw != <span class="keyword">null</span>) bw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来看如何对文件进行随机访问，Java中主要使用RandomAccessFile来对文件进行随机操作。</p>
<h3 id="创建一个大小固定的文件"><a href="#创建一个大小固定的文件" class="headerlink" title="创建一个大小固定的文件"></a>创建一个大小固定的文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createFile</span><span class="params">(String file, <span class="keyword">int</span> size)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File temp = <span class="keyword">new</span> File(file);</span><br><span class="line">    RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(temp, <span class="string">"rw"</span>);</span><br><span class="line">    raf.setLength(size);</span><br><span class="line">    raf.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="向文件中随机写入数据"><a href="#向文件中随机写入数据" class="headerlink" title="向文件中随机写入数据"></a>向文件中随机写入数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeFile</span><span class="params">(String file, <span class="keyword">byte</span>[] content, <span class="keyword">int</span> startPos, <span class="keyword">int</span> contentLength)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(<span class="keyword">new</span> File(file), <span class="string">"rw"</span>);</span><br><span class="line">    raf.seek(startPos);</span><br><span class="line">    raf.write(content, <span class="number">0</span>, contentLength);</span><br><span class="line">    raf.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下里，我们来看一些其他的常用操作</p>
<h3 id="移动文件"><a href="#移动文件" class="headerlink" title="移动文件"></a>移动文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">moveFile</span><span class="params">(String sourceFile, String destFile)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File source = <span class="keyword">new</span> File(sourceFile);</span><br><span class="line">    <span class="keyword">if</span> (!source.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"source file does not exist."</span>);</span><br><span class="line">    File dest = <span class="keyword">new</span> File(destFile);</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">new</span> File(dest.getPath()).exists())) <span class="keyword">new</span> File(dest.getParent()).mkdirs();</span><br><span class="line">    <span class="keyword">return</span> source.renameTo(dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String sourceFile, String destFile)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File source = <span class="keyword">new</span> File(sourceFile);</span><br><span class="line">    <span class="keyword">if</span> (!source.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"File does not exist."</span>);</span><br><span class="line">    <span class="keyword">if</span> (!source.isFile()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"It is not file."</span>);</span><br><span class="line">    <span class="keyword">if</span> (!source.canRead()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"File cound not be read."</span>);</span><br><span class="line">    File dest = <span class="keyword">new</span> File(destFile);</span><br><span class="line">    <span class="keyword">if</span> (dest.exists())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dest.isDirectory()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Destination is a folder."</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            dest.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        File parentFolder = <span class="keyword">new</span> File(dest.getParent());</span><br><span class="line">        <span class="keyword">if</span> (!parentFolder.exists()) parentFolder.mkdirs();</span><br><span class="line">        <span class="keyword">if</span> (!parentFolder.canWrite()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Destination can not be written."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(source);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(dest);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((bytesRead = fis.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            fos.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(IOException ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Error occurs during copying "</span> + sourceFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="keyword">null</span>) fis.close();</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="keyword">null</span>) fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="复制文件夹"><a href="#复制文件夹" class="headerlink" title="复制文件夹"></a>复制文件夹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyDir</span><span class="params">(String sourceDir, String destDir)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    File source = <span class="keyword">new</span> File(sourceDir);</span><br><span class="line">    <span class="keyword">if</span> (!source.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Source does not exist."</span>);</span><br><span class="line">    <span class="keyword">if</span> (!source.canRead()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Source could not be read."</span>);</span><br><span class="line">    File dest = <span class="keyword">new</span> File(destDir);</span><br><span class="line">    <span class="keyword">if</span> (!dest.exists()) dest.mkdirs();</span><br><span class="line">    </span><br><span class="line">    File[] arrFiles = source.listFiles();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrFiles.length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (arrFiles[i].isFile())</span><br><span class="line">        &#123;</span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(arrFiles[i]));</span><br><span class="line">            BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(destDir + <span class="string">"/"</span> + arrFiles[i].getName()));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) writer.write(line);</span><br><span class="line">            writer.flush();</span><br><span class="line">            reader.close();</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            copyDir(sourceDir + <span class="string">"/"</span> + arrFiles[i].getName(), destDir + <span class="string">"/"</span> + arrFiles[i].getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除文件夹"><a href="#删除文件夹" class="headerlink" title="删除文件夹"></a>删除文件夹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(String filePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="keyword">null</span> || !file.exists()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (file.isFile())</span><br><span class="line">    &#123;</span><br><span class="line">        file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        File[] arrFiles = file.listFiles();</span><br><span class="line">        <span class="keyword">if</span> (arrFiles.length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrFiles.length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                del(arrFiles[i].getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取文件夹大小"><a href="#获取文件夹大小" class="headerlink" title="获取文件夹大小"></a>获取文件夹大小</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getFolderSize</span><span class="params">(String dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> size = <span class="number">0</span>;</span><br><span class="line">    File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"dir does not exist."</span>);</span><br><span class="line">    <span class="keyword">if</span> (file.isFile()) <span class="keyword">return</span> file.length();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        String[] arrFileName = file.list();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrFileName.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            size += getFolderSize(dir + <span class="string">"/"</span> + arrFileName[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将大文件切分成多个小文件"><a href="#将大文件切分成多个小文件" class="headerlink" title="将大文件切分成多个小文件"></a>将大文件切分成多个小文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">splitFile</span><span class="params">(String filePath, <span class="keyword">long</span> unit)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"file does not exist."</span>);</span><br><span class="line">    <span class="keyword">long</span> size = file.length();</span><br><span class="line">    <span class="keyword">if</span> (unit &gt;= size) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> count = size % unit == <span class="number">0</span> ? (<span class="keyword">int</span>)(size/unit) : (<span class="keyword">int</span>)(size/unit) + <span class="number">1</span>;</span><br><span class="line">    String newFile = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    FileInputStream fis =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)unit];</span><br><span class="line">    fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">    <span class="keyword">long</span> startPos = <span class="number">0</span>;</span><br><span class="line">    String countFile = filePath + <span class="string">"_Count"</span>;</span><br><span class="line">    PrintWriter writer = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileWriter( <span class="keyword">new</span> File(countFile)));</span><br><span class="line">    writer.println(filePath + <span class="string">"\t"</span> + size);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        newFile = filePath + <span class="string">"_"</span> + i;</span><br><span class="line">        startPos = (i - <span class="number">1</span>) * unit;</span><br><span class="line">        System.out.println(<span class="string">"Creating "</span> + newFile);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(newFile));</span><br><span class="line">        <span class="keyword">int</span> bytesRead = fis.read(buffer, <span class="number">0</span>, buffer.length);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead != -<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            fos.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">            writer.println(newFile + <span class="string">"\t"</span> + startPos + <span class="string">"\t"</span> + bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">        fos.close();</span><br><span class="line">        System.out.println(<span class="string">"StartPos:"</span> + i*unit + <span class="string">"; EndPos:"</span> + (i*unit + bytesRead));</span><br><span class="line">    &#125;</span><br><span class="line">    writer.flush();</span><br><span class="line">    writer.close();</span><br><span class="line">    fis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将多个小文件合并成一个大文件"><a href="#将多个小文件合并成一个大文件" class="headerlink" title="将多个小文件合并成一个大文件"></a>将多个小文件合并成一个大文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">linkFiles</span><span class="params">(String countFile)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(countFile);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Count file does not exist."</span>);</span><br><span class="line">    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">    String line = reader.readLine();</span><br><span class="line">    String newFile = line.split(<span class="string">"\t"</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">long</span> size = Long.parseLong(line.split(<span class="string">"\t"</span>)[<span class="number">1</span>]);</span><br><span class="line">    RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(newFile, <span class="string">"rw"</span>);</span><br><span class="line">    raf.setLength(size);</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        String[] arrInfo = line.split(<span class="string">"\t"</span>);</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(arrInfo[<span class="number">0</span>]));</span><br><span class="line">        buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[Integer.parseInt(arrInfo[<span class="number">2</span>])];</span><br><span class="line">        <span class="keyword">long</span> startPos = Long.parseLong(arrInfo[<span class="number">1</span>]);</span><br><span class="line">        fis.read(buffer, <span class="number">0</span>, Integer.parseInt(arrInfo[<span class="number">2</span>]));</span><br><span class="line">        raf.seek(startPos);</span><br><span class="line">        raf.write(buffer, <span class="number">0</span>, Integer.parseInt(arrInfo[<span class="number">2</span>]));</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">    raf.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="执行外部命令"><a href="#执行外部命令" class="headerlink" title="执行外部命令"></a>执行外部命令</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execExternalCommand</span><span class="params">(String command, String argument)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Process process = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        process = Runtime.getRuntime().exec(command + <span class="string">" "</span> + argument);</span><br><span class="line">        InputStream is = process.getInputStream();</span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        System.err.println(ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (process != <span class="keyword">null</span>) process.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Java网络通信"><a href="#Java网络通信" class="headerlink" title="Java网络通信"></a>Java网络通信</h1><p>Java实现网络通信，包括TCP通信、UDP通信、多播以及NIO。</p>
<h2 id="TCP连接"><a href="#TCP连接" class="headerlink" title="TCP连接"></a>TCP连接</h2><p>TCP的基础是Socket，在TCP连接中，我们会使用ServerSocket和Socket，当客户端和服务器建立连接以后，剩下的基本就是对I/O的控制了。</p>
<p>我们先来看一个简单的TCP通信，它分为客户端和服务器端。</p>
<p>客户端代码如下：</p>
<h3 id="简单的TCP客户端"><a href="#简单的TCP客户端" class="headerlink" title="简单的TCP客户端"></a>简单的TCP客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleTcpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        PrintWriter pw = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader brTemp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> Socket(InetAddress.getLocalHost(), <span class="number">5678</span>);</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">            pw = <span class="keyword">new</span> PrintWriter(socket.getOutputStream());</span><br><span class="line">            brTemp = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                String line = brTemp.readLine();</span><br><span class="line">                pw.println(line);</span><br><span class="line">                pw.flush();</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                System.out.println(br.readLine());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) socket.close();</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) br.close();</span><br><span class="line">            <span class="keyword">if</span> (brTemp != <span class="keyword">null</span>) brTemp.close();</span><br><span class="line">            <span class="keyword">if</span> (pw != <span class="keyword">null</span>) pw.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务器端代码如下：</p>
<h3 id="简单版本TCP服务器端"><a href="#简单版本TCP服务器端" class="headerlink" title="简单版本TCP服务器端"></a>简单版本TCP服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleTcpServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ServerSocket server = <span class="keyword">null</span>;</span><br><span class="line">        Socket client = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        PrintWriter pw = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            server = <span class="keyword">new</span> ServerSocket(<span class="number">5678</span>);</span><br><span class="line">            client = server.accept();</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(client.getInputStream()));</span><br><span class="line">            pw = <span class="keyword">new</span> PrintWriter(client.getOutputStream());</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                pw.println(<span class="string">"Response:"</span> + line);</span><br><span class="line">                pw.flush();</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (server != <span class="keyword">null</span>) server.close();</span><br><span class="line">            <span class="keyword">if</span> (client != <span class="keyword">null</span>) client.close();</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) br.close();</span><br><span class="line">            <span class="keyword">if</span> (pw != <span class="keyword">null</span>) pw.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的服务器的功能非常简单，它接收客户端发来的消息，然后将消息“原封不动”的返回给客户端。当客户端发送“end”时，通信结束。</p>
<p>上面的代码基本上勾勒了TCP通信过程中，客户端和服务器端的主要框架，我们可以发现，上述的代码中，服务器端在任何时刻，都只能处理来自客户端的一个请求，它是串行处理的，不能并行，这和我们印象里的服务器处理方式不太相同，我们可以为服务器添加多线程，当一个客户端的请求进入后，我们就创建一个线程，来处理对应的请求。</p>
<p>改善后的服务器端代码如下：</p>
<h3 id="多线程版本的TCP服务器端"><a href="#多线程版本的TCP服务器端" class="headerlink" title="多线程版本的TCP服务器端"></a>多线程版本的TCP服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmartTcpServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ServerSocket server = <span class="keyword">new</span> ServerSocket(<span class="number">5678</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Socket client = server.accept();</span><br><span class="line">            Thread thread = <span class="keyword">new</span> ServerThread(client);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerThread</span><span class="params">(Socket socket)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        PrintWriter pw = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">            pw = <span class="keyword">new</span> PrintWriter(socket.getOutputStream());</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                pw.println(<span class="string">"Response:"</span> + line);</span><br><span class="line">                pw.flush();</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    e1.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">if</span> (pw != <span class="keyword">null</span>) pw.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改后的服务器端，就可以同时处理来自客户端的多个请求了。</p>
<p>在编程的过程中，我们会有“资源”的概念，例如数据库连接就是一个典型的资源，为了提升性能，我们通常不会直接销毁数据库连接，而是使用数据库连接池的方式来对多个数据库连接进行管理，已实现重用的目的。对于Socket连接来说，它也是一种资源，当我们的程序需要大量的Socket连接时，如果每个连接都需要重新建立，那么将会是一件非常没有效率的做法。</p>
<p>　　和数据库连接池类似，我们也可以设计TCP连接池，这里的思路是我们用一个数组来维持多个Socket连接，另外一个状态数组来描述每个Socket连接是否正在使用，当程序需要Socket连接时，我们遍历状态数组，取出第一个没被使用的Socket连接，如果所有连接都在使用，抛出异常。这是一种很直观简单的“调度策略”，在很多开源或者商业的框架中（Apache/Tomcat），都会有类似的“资源池”。</p>
<p>TCP连接池的代码如下：</p>
<h3 id="一个简单的TCP连接池"><a href="#一个简单的TCP连接池" class="headerlink" title="一个简单的TCP连接池"></a>一个简单的TCP连接池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpConnectionPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InetAddress address = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> Socket[] arrSockets = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] arrStatus = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TcpConnectionPool</span><span class="params">(InetAddress address, <span class="keyword">int</span> port, <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">        <span class="keyword">this</span> .count = count;</span><br><span class="line">        arrSockets = <span class="keyword">new</span> Socket[count];</span><br><span class="line">        arrStatus = <span class="keyword">new</span> <span class="keyword">boolean</span>[count];</span><br><span class="line">        </span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                arrSockets[i] = <span class="keyword">new</span> Socket(address.getHostAddress(), port);</span><br><span class="line">                arrStatus[i] = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Socket <span class="title">getConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arrSockets == <span class="keyword">null</span>) init();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (arrStatus[i] == <span class="keyword">false</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                arrStatus[i] = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == count) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"have no connection availiable for now."</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> arrSockets[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseConnection</span><span class="params">(Socket socket)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arrSockets == <span class="keyword">null</span>) init();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (arrSockets[i] == socket)</span><br><span class="line">            &#123;</span><br><span class="line">                arrStatus[i] = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reBuild</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arrSockets == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                arrSockets[i].close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                System.err.println(ex.getMessage());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="UDP连接"><a href="#UDP连接" class="headerlink" title="UDP连接"></a>UDP连接</h2><p>UDP是一种和TCP不同的连接方式，它通常应用在对实时性要求很高，对准确定要求不高的场合，例如在线视频。UDP会有“丢包”的情况发生，在TCP中，如果Server没有启动，Client发消息时，会报出异常，但对UDP来说，不会产生任何异常。</p>
<p>UDP通信使用的两个类时DatagramSocket和DatagramPacket，后者存放了通信的内容。</p>
<p>下面是一个简单的UDP通信例子，同TCP一样，也分为Client和Server两部分，Client端代码如下：</p>
<h3 id="UDP通信客户端"><a href="#UDP通信客户端" class="headerlink" title="UDP通信客户端"></a>UDP通信客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            InetAddress host = InetAddress.getLocalHost();</span><br><span class="line">            <span class="keyword">int</span> port = <span class="number">5678</span>;</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                <span class="keyword">byte</span>[] message = line.getBytes();</span><br><span class="line">                DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(message, message.length, host, port);</span><br><span class="line">                DatagramSocket socket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">                socket.send(packet);</span><br><span class="line">                socket.close();</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            br.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Server端代码如下：</p>
<h3 id="UDP通信服务器端"><a href="#UDP通信服务器端" class="headerlink" title="UDP通信服务器端"></a>UDP通信服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdpServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> port = <span class="number">5678</span>;</span><br><span class="line">            DatagramSocket dsSocket = <span class="keyword">new</span> DatagramSocket(port);</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length);</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dsSocket.receive(packet);</span><br><span class="line">                String message = <span class="keyword">new</span> String(buffer, <span class="number">0</span>, packet.getLength());</span><br><span class="line">                System.out.println(packet.getAddress().getHostName() + <span class="string">":"</span> + message);</span><br><span class="line">                <span class="keyword">if</span> (message.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                packet.setLength(buffer.length);</span><br><span class="line">            &#125;</span><br><span class="line">            dsSocket.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们也假设和TCP一样，当Client发出“end”消息时，认为通信结束，但其实这样的设计不是必要的，Client端可以随时断开，并不需要关心Server端状态。</p>
<h2 id="多播（Multicast）"><a href="#多播（Multicast）" class="headerlink" title="多播（Multicast）"></a>多播（Multicast）</h2><p>多播采用和UDP类似的方式，它会使用D类IP地址和标准的UDP端口号，D类IP地址是指224.0.0.0到239.255.255.255之间的地址，不包括224.0.0.0。</p>
<p>多播会使用到的类是MulticastSocket，它有两个方法需要关注：joinGroup和leaveGroup。</p>
<p>下面是一个多播的例子，Client端代码如下：</p>
<h3 id="多播通信客户端"><a href="#多播通信客户端" class="headerlink" title="多播通信客户端"></a>多播通信客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulticastClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            InetAddress address = InetAddress.getByName(<span class="string">"230.0.0.1"</span>);</span><br><span class="line">            <span class="keyword">int</span> port = <span class="number">5678</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                String line = br.readLine();</span><br><span class="line">                <span class="keyword">byte</span>[] message = line.getBytes();</span><br><span class="line">                DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(message, message.length, address, port);</span><br><span class="line">                MulticastSocket multicastSocket = <span class="keyword">new</span> MulticastSocket();</span><br><span class="line">                multicastSocket.send(packet);</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            br.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务器端代码如下：</p>
<h3 id="多播通信服务器端"><a href="#多播通信服务器端" class="headerlink" title="多播通信服务器端"></a>多播通信服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulticastServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">5678</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            MulticastSocket multicastSocket = <span class="keyword">new</span> MulticastSocket(port);</span><br><span class="line">            InetAddress address = InetAddress.getByName(<span class="string">"230.0.0.1"</span>);</span><br><span class="line">            multicastSocket.joinGroup(address);</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length);</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                multicastSocket.receive(packet);</span><br><span class="line">                String message = <span class="keyword">new</span> String(buffer, packet.getLength());</span><br><span class="line">                System.out.println(packet.getAddress().getHostName() + <span class="string">":"</span> + message);</span><br><span class="line">                <span class="keyword">if</span> (message.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                packet.setLength(buffer.length);</span><br><span class="line">            &#125;</span><br><span class="line">            multicastSocket.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NIO（New-IO）"><a href="#NIO（New-IO）" class="headerlink" title="NIO（New IO）"></a>NIO（New IO）</h2><p>NIO是JDK1.4引入的一套新的IO API，它在缓冲区管理、网络通信、文件存取以及字符集操作方面有了新的设计。对于网络通信来说，NIO使用了缓冲区和通道的概念。</p>
<p>下面是一个NIO的例子，和我们上面提到的代码风格有很大的不同。</p>
<h3 id="NIO例子"><a href="#NIO例子" class="headerlink" title="NIO例子"></a>NIO例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewIOSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String host=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">5678</span>;</span><br><span class="line">        SocketChannel channel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            InetSocketAddress address = <span class="keyword">new</span> InetSocketAddress(host,port);</span><br><span class="line">            Charset charset = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line">            CharsetDecoder decoder = charset.newDecoder();</span><br><span class="line">            CharsetEncoder encoder = charset.newEncoder();</span><br><span class="line">            </span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            CharBuffer charBuffer = CharBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            </span><br><span class="line">            channel = SocketChannel.open();</span><br><span class="line">            channel.connect(address);</span><br><span class="line">            </span><br><span class="line">            String request = <span class="string">"GET / \r\n\r\n"</span>;</span><br><span class="line">            channel.write(encoder.encode(CharBuffer.wrap(request)));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span>((channel.read(buffer)) != -<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                buffer.flip();</span><br><span class="line">                decoder.decode(buffer, charBuffer, <span class="keyword">false</span>);</span><br><span class="line">                charBuffer.flip();</span><br><span class="line">                System.out.println(charBuffer);</span><br><span class="line">                buffer.clear();</span><br><span class="line">                charBuffer.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码会试图访问一个本地的网址，然后将其内容打印出来。</p>
<h1 id="Java多线程"><a href="#Java多线程" class="headerlink" title="Java多线程"></a>Java多线程</h1><p>多线程是一个复杂的话题，包含了很多内容，文章主要关注线程的基本属性、如何创建线程、线程的状态切换以及线程通信，我们把线程同步的话题留到下一篇文章中。</p>
<p>线程是操作系统运行的基本单位，它被封装在进程中，一个进程可以包含多个线程。即使我们不手动创造线程，进程也会有一个默认的线程在运行。</p>
<p>对于JVM来说，当我们编写一个单线程的程序去运行时，JVM中也是有至少两个线程在运行，一个是我们创建的程序，一个是垃圾回收。</p>
<h2 id="线程基本信息"><a href="#线程基本信息" class="headerlink" title="线程基本信息"></a>线程基本信息</h2><p>我们可以通过Thread.currentThread()方法获取当前线程的一些信息，并对其进行修改。</p>
<p>我们来看以下代码：</p>
<h3 id="查看并修改当前线程的属性"><a href="#查看并修改当前线程的属性" class="headerlink" title="查看并修改当前线程的属性"></a>查看并修改当前线程的属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">String name = Thread.currentThread().getName();</span><br><span class="line">        <span class="keyword">int</span> priority = Thread.currentThread().getPriority();</span><br><span class="line">        String groupName = Thread.currentThread().getThreadGroup().getName();</span><br><span class="line">        <span class="keyword">boolean</span> isDaemon = Thread.currentThread().isDaemon();</span><br><span class="line">        System.out.println(<span class="string">"Thread Name:"</span> + name);</span><br><span class="line">        System.out.println(<span class="string">"Priority:"</span> + priority);</span><br><span class="line">        System.out.println(<span class="string">"Group Name:"</span> + groupName);</span><br><span class="line">        System.out.println(<span class="string">"IsDaemon:"</span> + isDaemon);</span><br><span class="line">        </span><br><span class="line">        Thread.currentThread().setName(<span class="string">"Test"</span>);</span><br><span class="line">        Thread.currentThread().setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">        name = Thread.currentThread().getName();</span><br><span class="line">        priority = Thread.currentThread().getPriority();</span><br><span class="line">        groupName = Thread.currentThread().getThreadGroup().getName();</span><br><span class="line">        isDaemon = Thread.currentThread().isDaemon();</span><br><span class="line">        System.out.println(<span class="string">"Thread Name:"</span> + name);</span><br><span class="line">        System.out.println(<span class="string">"Priority:"</span> + priority);</span><br></pre></td></tr></table></figure>
<p>其中列出的属性说明如下：</p>
<ul>
<li><p>GroupName，每个线程都会默认在一个线程组里，我们也可以显式的创建线程组，一个线程组中也可以包含子线程组，这样线程和线程组，就构成了一个树状结构。</p>
</li>
<li><p>Name，每个线程都会有一个名字，如果不显式指定，那么名字的规则是“Thread-xxx”。</p>
</li>
<li><p>Priority，每个线程都会有自己的优先级，JVM对优先级的处理方式是“抢占式”的。当JVM发现优先级高的线程时，马上运行该线程；对于多个优先级相等的线程，JVM对其进行轮询处理。Java的线程优先级从1到10，默认是5，Thread类定义了2个常量：MIN_PRIORITY和MAX_PRIORITY来表示最高和最低优先级。</p>
</li>
</ul>
<p>我们可以看下面的代码，它定义了两个不同优先级的线程：</p>
<h3 id="线程优先级示例"><a href="#线程优先级示例" class="headerlink" title="线程优先级示例"></a>线程优先级示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">priorityTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(<span class="string">"low"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">"Thread 1 is running."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(<span class="string">"high"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">"Thread 2 is running."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    thread1.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">    thread2.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从运行结果可以看出，是高优先级线程运行完成后，低优先级线程才运行。<br>isDaemon，这个属性用来控制父子线程的关系，如果设置为true，当父线程结束后，其下所有子线程也结束，反之，子线程的生命周期不受父线程影响。</p>
<p>我们来看下面的例子：</p>
<h3 id="IsDaemon-示例"><a href="#IsDaemon-示例" class="headerlink" title="IsDaemon 示例"></a>IsDaemon 示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">daemonTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(<span class="string">"daemon"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Thread subThread = <span class="keyword">new</span> Thread(<span class="string">"sub"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(<span class="string">"Sub Thread Running "</span> + i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            subThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            subThread.start();</span><br><span class="line">            System.out.println(<span class="string">"Main Thread end."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    thread1.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的运行结果，在和删除subThread.setDaemon(true);后对比，可以发现后者运行过程中子线程会完成执行后再结束，而前者中，子线程很快就结束了。</p>
<h2 id="如何创建线程"><a href="#如何创建线程" class="headerlink" title="如何创建线程"></a>如何创建线程</h2><p>上面的内容，都是演示默认线程中的一些信息，那么应该如何创建线程呢？在Java中，我们有3种方式可以用来创建线程。</p>
<p>Java中的线程要么继承Thread类，要么实现Runnable接口，我们一一道来。</p>
<h3 id="使用内部类来创建线程"><a href="#使用内部类来创建线程" class="headerlink" title="使用内部类来创建线程"></a>使用内部类来创建线程</h3><p>我们可以使用内部类的方式来创建线程，过程是声明一个Thread类型的变量，并重写run方法。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createThreadByNestClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is running."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is finished."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="继承Thread以创建线程"><a href="#继承Thread以创建线程" class="headerlink" title="继承Thread以创建线程"></a>继承Thread以创建线程</h3><p>我们可以从Thread中派生一个类，重写其run方法，这种方式和上面相似。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is running."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is finished."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createThreadBySubClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyThread thread = <span class="keyword">new</span> MyThread();</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现Runnable接口以创建线程"><a href="#实现Runnable接口以创建线程" class="headerlink" title="实现Runnable接口以创建线程"></a>实现Runnable接口以创建线程</h3><p>我们可以定义一个类，使其实现Runnable接口，然后将该类的实例作为构建Thread变量构造函数的参数。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is running."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">" is finished."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createThreadByRunnable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyRunnable runnable = <span class="keyword">new</span> MyRunnable();</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(runnable);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述3种方式都可以创建线程，而且从示例代码上看，线程执行的功能是一样的，那么这三种创建方式有什么不同呢？</p>
<p>这涉及到Java中多线程的运行模式，对于Java来说，多线程在运行时，有“多对象多线程”和“单对象多线程”的区别：</p>
<ul>
<li>多对象多线程，程序在运行过程中创建多个线程对象，每个对象上运行一个线程。</li>
<li>单对象多线程，程序在运行过程中创建一个线程对象，在其上运行多个线程。</li>
</ul>
<p>显然，从线程同步和调度的角度来看，多对象多线程要简单一些。上述3种线程创建方式，前两种都属于“多对象多线程”，第三种既可以使用“多对象多线程”，也可以使用“单对象单线程”。</p>
<p>我们来看下面的示例代码，里面会用到Object.notify方法，这个方法会唤醒对象上的一个线程；而Object.notifyAll方法，则会唤醒对象上的所有线程。</p>
<h3 id="notify示例"><a href="#notify示例" class="headerlink" title="notify示例"></a>notify示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifySample</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        notifyTest();</span><br><span class="line">        notifyTest2();</span><br><span class="line">        notifyTest3();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyThread[] arrThreads = <span class="keyword">new</span> MyThread[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrThreads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arrThreads[i] = <span class="keyword">new</span> MyThread();</span><br><span class="line">            arrThreads[i].id = i;</span><br><span class="line">            arrThreads[i].setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            arrThreads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrThreads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(arrThreads[i])</span><br><span class="line">            &#123;</span><br><span class="line">                arrThreads[i].notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyTest2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyRunner[] arrMyRunners = <span class="keyword">new</span> MyRunner[<span class="number">3</span>];</span><br><span class="line">        Thread[] arrThreads = <span class="keyword">new</span> Thread[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrThreads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arrMyRunners[i] = <span class="keyword">new</span> MyRunner();</span><br><span class="line">            arrMyRunners[i].id = i;</span><br><span class="line">            arrThreads[i] = <span class="keyword">new</span> Thread(arrMyRunners[i]);</span><br><span class="line">            arrThreads[i].setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            arrThreads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrMyRunners.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(arrMyRunners[i])</span><br><span class="line">            &#123;</span><br><span class="line">                arrMyRunners[i].notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyTest3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyRunner runner = <span class="keyword">new</span> MyRunner();</span><br><span class="line">        Thread[] arrThreads = <span class="keyword">new</span> Thread[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrThreads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arrThreads[i] = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">            arrThreads[i].setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            arrThreads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(runner)</span><br><span class="line">        &#123;</span><br><span class="line">            runner.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"第"</span> + id + <span class="string">"个线程准备休眠5分钟。"</span>);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait(<span class="number">5</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"第"</span> + id + <span class="string">"个线程被唤醒。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"第"</span> + id + <span class="string">"个线程准备休眠5分钟。"</span>);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait(<span class="number">5</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"第"</span> + id + <span class="string">"个线程被唤醒。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例代码中，notifyTest()和notifyTest2()是“多对象多线程”，尽管notifyTest2()中的线程实现了Runnable接口，但是它里面定义Thread数组时，每个元素都使用了一个新的Runnable实例。notifyTest3()属于“单对象多线程”，因为我们只定义了一个Runnable实例，所有的线程都会使用这个实例。</p>
<p>notifyAll方法适用于“单对象多线程”的情景，因为notify方法只会随机唤醒对象上的一个线程。</p>
<h2 id="线程的状态切换"><a href="#线程的状态切换" class="headerlink" title="线程的状态切换"></a>线程的状态切换</h2><p>对于线程来讲，从我们创建它一直到线程运行结束，在这个过程中，线程的状态可能是这样的：</p>
<ul>
<li>创建：已经有Thread实例了， 但是CPU还有为其分配资源和时间片。</li>
<li>就绪：线程已经获得了运行所需的所有资源，只等CPU进行时间调度。</li>
<li>运行：线程位于当前CPU时间片中，正在执行相关逻辑。</li>
<li>休眠：一般是调用Thread.sleep后的状态，这时线程依然持有运行所需的各种资源，但是不会被CPU调度。</li>
<li>挂起：一般是调用Thread.suspend后的状态，和休眠类似，CPU不会调度该线程，不同的是，这种状态下，线程会释放所有资源。</li>
<li>死亡：线程运行结束或者调用了Thread.stop方法。
　　</li>
</ul>
<p>下面我们来演示如何进行线程状态切换，首先我们会用到下面方法：</p>
<ul>
<li>Thread()或者Thread(Runnable)：构造线程。</li>
<li>Thread.start：启动线程。</li>
<li>Thread.sleep：将线程切换至休眠状态。</li>
<li>Thread.interrupt：中断线程的执行。</li>
<li>Thread.join：等待某线程结束。</li>
<li>Thread.yield：剥夺线程在CPU上的执行时间片，等待下一次调度。</li>
<li>Object.wait：将Object上所有线程锁定，直到notify方法才继续运行。</li>
<li>Object.notify：随机唤醒Object上的1个线程。</li>
<li>Object.notifyAll：唤醒Object上的所有线程。<br>　　下面，就是演示时间啦！！！</li>
</ul>
<h2 id="线程等待与唤醒"><a href="#线程等待与唤醒" class="headerlink" title="线程等待与唤醒"></a>线程等待与唤醒</h2><p>这里主要使用Object.wait和Object.notify方法，请参见上面的notify实例。需要注意的是，wait和notify都必须针对同一个对象，当我们使用实现Runnable接口的方式来创建线程时，应该是在Runnable对象而非Thread对象上使用这两个方法。</p>
<h2 id="线程的休眠与唤醒"><a href="#线程的休眠与唤醒" class="headerlink" title="线程的休眠与唤醒"></a>线程的休眠与唤醒</h2><p>Thread.sleep实例<br>线程在休眠过程中，我们可以使用Thread.interrupt将其唤醒，这时线程会抛出InterruptedException。</p>
<h3 id="Thread-sleep实例"><a href="#Thread-sleep实例" class="headerlink" title="Thread.sleep实例"></a>Thread.sleep实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepSample</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sleepTest();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleepTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"线程 "</span> + Thread.currentThread().getName() + <span class="string">"将要休眠5分钟。"</span>);</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">"线程 "</span> + Thread.currentThread().getName() + <span class="string">"休眠被中断。"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"线程 "</span> + Thread.currentThread().getName() + <span class="string">"休眠结束。"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="线程的终止"><a href="#线程的终止" class="headerlink" title="线程的终止"></a>线程的终止</h2><p>虽然有Thread.stop方法，但该方法是不被推荐使用的，我们可以利用上面休眠与唤醒的机制，让线程在处理IterruptedException时，结束线程。</p>
<h3 id="Thread-interrupt示例"><a href="#Thread-interrupt示例" class="headerlink" title="Thread.interrupt示例"></a>Thread.interrupt示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopThreadSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        stopTest();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stopTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"线程运行中。"</span>);</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">"线程中断，结束线程"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"线程正常结束。"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="线程的同步等待"><a href="#线程的同步等待" class="headerlink" title="线程的同步等待"></a>线程的同步等待</h2><p>当我们在主线程中创建了10个子线程，然后我们期望10个子线程全部结束后，主线程在执行接下来的逻辑，这时，就该Thread.join登场了。</p>
<h3 id="Thread-join示例"><a href="#Thread-join示例" class="headerlink" title="Thread.join示例"></a>Thread.join示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        joinTest();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">joinTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(<span class="string">"线程在运行。"</span>);</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread.join();</span><br><span class="line">        System.out.println(<span class="string">"主线程正常结束。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以试着将thread.join();注释或者删除，再次运行程序，就可以发现不同了。</p>
<h2 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h2><p>我们知道，一个进程下面的所有线程是共享内存空间的，那么我们如何在不同的线程之间传递消息呢？在回顾 Java I/O时，我们谈到了PipedStream和PipedReader，这里，就是它们发挥作用的地方了。</p>
<p>下面的两个示例，功能完全一样，不同的是一个使用Stream，一个使用Reader/Writer。</p>
<h3 id="PipeInputStream-PipedOutpueStream-示例"><a href="#PipeInputStream-PipedOutpueStream-示例" class="headerlink" title="PipeInputStream/PipedOutpueStream 示例"></a>PipeInputStream/PipedOutpueStream 示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">communicationTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PipedOutputStream pos = <span class="keyword">new</span> PipedOutputStream();</span><br><span class="line">    <span class="keyword">final</span> PipedInputStream pis = <span class="keyword">new</span> PipedInputStream(pos);</span><br><span class="line">    </span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    String message = br.readLine();</span><br><span class="line">                    pos.write(message.getBytes());</span><br><span class="line">                    <span class="keyword">if</span> (message.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                br.close();</span><br><span class="line">                pos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>((bytesRead = pis.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> String(buffer));</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">new</span> String(buffer).equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                    buffer = <span class="keyword">null</span>;</span><br><span class="line">                    buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                pis.close();</span><br><span class="line">                buffer = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PipedReader-PipedWriter-示例"><a href="#PipedReader-PipedWriter-示例" class="headerlink" title="PipedReader/PipedWriter 示例"></a>PipedReader/PipedWriter 示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">communicationTest2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PipedWriter pw = <span class="keyword">new</span> PipedWriter();</span><br><span class="line">    <span class="keyword">final</span> PipedReader pr = <span class="keyword">new</span> PipedReader(pw);</span><br><span class="line">    <span class="keyword">final</span> BufferedWriter bw = <span class="keyword">new</span> BufferedWriter(pw);</span><br><span class="line">    <span class="keyword">final</span> BufferedReader br = <span class="keyword">new</span> BufferedReader(pr);</span><br><span class="line">    </span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            </span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    String message = br.readLine();</span><br><span class="line">                    bw.write(message);</span><br><span class="line">                    bw.newLine();</span><br><span class="line">                    bw.flush();</span><br><span class="line">                    <span class="keyword">if</span> (message.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                br.close();</span><br><span class="line">                pw.close();</span><br><span class="line">                bw.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            </span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(line);</span><br><span class="line">                    <span class="keyword">if</span> (line.equals(<span class="string">"end"</span>)) <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                br.close();</span><br><span class="line">                pr.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Java多线程同步"><a href="#Java多线程同步" class="headerlink" title="Java多线程同步"></a>Java多线程同步</h1><p>线程同步话题。这是比多线程更复杂，稍不留意，我们就会“掉到坑里”，而且和单线程程序不同，多线程的错误是否每次都出现，也是不固定的，这给调试也带来了很大的挑战。</p>
<p>我们首先阐述什么是同步，不同步有什么问题，然后讨论可以采取哪些措施控制同步，接下来我们会仿照回顾网络通信时那样，构建一个服务器端的“线程池”，JDK为我们提供了一个很大的concurrent工具包，最后我们会对里面的内容进行探索。</p>
<h2 id="为什么要线程同步？"><a href="#为什么要线程同步？" class="headerlink" title="为什么要线程同步？"></a>为什么要线程同步？</h2><p>说到线程同步，大部分情况下，我们是在针对“单对象多线程”的情况进行讨论，一般会将其分成两部分，一部分是关于“共享变量”，一部分关于“执行步骤”。</p>
<h3 id="共享变量"><a href="#共享变量" class="headerlink" title="共享变量"></a>共享变量</h3><p>当我们在线程对象（Runnable）中定义了全局变量，run方法会修改该变量时，如果有多个线程同时使用该线程对象，那么就会造成全局变量的值被同时修改，造成错误。我们来看下面的代码：</p>
<h4 id="共享变量造成同步问题"><a href="#共享变量造成同步问题" class="headerlink" title="共享变量造成同步问题"></a>共享变量造成同步问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" --- The value of sum is "</span> + sum);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sharedVaribleTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyRunner runner = <span class="keyword">new</span> MyRunner();</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例中，线程用来计算1到100的和是多少，我们知道正确结果是5050（好像是高斯小时候玩过这个？），但是上述程序返回的结果是10100，原因是两个线程同时对sum进行操作。</p>
<h3 id="执行步骤"><a href="#执行步骤" class="headerlink" title="执行步骤"></a>执行步骤</h3><p>我们在多个线程运行时，可能需要某些操作合在一起作为“原子操作”，即在这些操作可以看做是“单线程”的，例如我们可能希望输出结果的样子是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 线程1：步骤1</span><br><span class="line">2 线程1：步骤2</span><br><span class="line">3 线程1：步骤3</span><br><span class="line">4 线程2：步骤1</span><br><span class="line">5 线程2：步骤2</span><br><span class="line">6 线程2：步骤3</span><br></pre></td></tr></table></figure>
<p>　　如果同步控制不好，出来的样子可能是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">线程1：步骤1</span><br><span class="line">线程2：步骤1</span><br><span class="line">线程1：步骤2</span><br><span class="line">线程2：步骤2</span><br><span class="line">线程1：步骤3</span><br><span class="line">线程2：步骤3</span><br></pre></td></tr></table></figure>
<p>这里我们也给出一个示例代码：</p>
<h3 id="执行步骤混乱带来的同步问题"><a href="#执行步骤混乱带来的同步问题" class="headerlink" title="执行步骤混乱带来的同步问题"></a>执行步骤混乱带来的同步问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyNonSyncRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Running step "</span> + i);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">syncTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyNonSyncRunner runner = <span class="keyword">new</span> MyNonSyncRunner();</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何控制线程同步"><a href="#如何控制线程同步" class="headerlink" title="如何控制线程同步"></a>如何控制线程同步</h2><p>既然线程同步有上述问题，那么我们应该如何去解决呢？针对不同原因造成的同步问题，我们可以采取不同的策略。</p>
<h3 id="控制共享变量"><a href="#控制共享变量" class="headerlink" title="控制共享变量"></a>控制共享变量</h3><p>我们可以采取3种方式来控制共享变量。</p>
<h4 id="将“单对象多线程”修改成“多对象多线程”"><a href="#将“单对象多线程”修改成“多对象多线程”" class="headerlink" title="将“单对象多线程”修改成“多对象多线程”　　"></a>将“单对象多线程”修改成“多对象多线程”　　</h4><p>上文提及，同步问题一般发生在“单对象多线程”的场景中，那么最简单的处理方式就是将运行模型修改成“多对象多线程”的样子，针对上面示例中的同步问题，修改后的代码如下：</p>
<h4 id="解决共享变量问题方案一"><a href="#解决共享变量问题方案一" class="headerlink" title="解决共享变量问题方案一"></a>解决共享变量问题方案一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sharedVaribleTest2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> MyRunner());</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> MyRunner());</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，上述代码中两个线程使用了两个不同的Runnable实例，它们在运行过程中，就不会去访问同一个全局变量。</p>
<h4 id="将“全局变量”降级为“局部变量”"><a href="#将“全局变量”降级为“局部变量”" class="headerlink" title="将“全局变量”降级为“局部变量”"></a>将“全局变量”降级为“局部变量”</h4><p>既然是共享变量造成的问题，那么我们可以将共享变量改为“不共享”，即将其修改为局部变量。这样也可以解决问题，同样针对上面的示例，这种解决方式的代码如下：</p>
<h4 id="解决共享变量问题方案二"><a href="#解决共享变量问题方案二" class="headerlink" title="解决共享变量问题方案二"></a>解决共享变量问题方案二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner2</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" --- The value of sum is "</span> + sum);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sharedVaribleTest3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyRunner2 runner = <span class="keyword">new</span> MyRunner2();</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看出，sum变量已经由全局变量变为run方法内部的局部变量了。</p>
<h4 id="使用ThreadLocal机制"><a href="#使用ThreadLocal机制" class="headerlink" title="使用ThreadLocal机制"></a>使用ThreadLocal机制</h4><p>ThreadLocal是JDK引入的一种机制，它用于解决线程间共享变量，使用ThreadLocal声明的变量，即使在线程中属于全局变量，针对每个线程来讲，这个变量也是独立的。</p>
<p>我们可以用这种方式来改造上面的代码，如下所示：</p>
<h4 id="解决共享变量问题方案三"><a href="#解决共享变量问题方案三" class="headerlink" title="解决共享变量问题方案三"></a>解决共享变量问题方案三</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner3</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> ThreadLocal&lt;Integer&gt; tl = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tl.get() == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                tl.set(<span class="keyword">new</span> Integer(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> sum = ((Integer)tl.get()).intValue();</span><br><span class="line">            sum+= i;</span><br><span class="line">            tl.set(<span class="keyword">new</span> Integer(sum));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" --- The value of sum is "</span> + ((Integer)tl.get()).intValue());</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sharedVaribleTest4</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyRunner3 runner = <span class="keyword">new</span> MyRunner3();</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上三种方案，第一种方案会降低多线程执行的效率，因此，我们推荐使用第二种或者第三种方案。</p>
<h3 id="控制执行步骤"><a href="#控制执行步骤" class="headerlink" title="控制执行步骤"></a>控制执行步骤</h3><p>说到执行步骤，我们可以使用synchronized关键字来解决它。</p>
<h4 id="执行步骤问题解决方案"><a href="#执行步骤问题解决方案" class="headerlink" title="执行步骤问题解决方案"></a>执行步骤问题解决方案</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySyncRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" Running step "</span> + i);</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">syncTest2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MySyncRunner runner = <span class="keyword">new</span> MySyncRunner();</span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">    thread1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在线程同步的话题上，synchronized是一个非常重要的关键字。它的原理和数据库中事务锁的原理类似。我们在使用过程中，应该尽量缩减synchronized覆盖的范围,原因有二：</p>
<ol>
<li>被它覆盖的范围是串行的，效率低；</li>
<li>容易产生死锁。</li>
</ol>
<p>我们来看下面的示例：</p>
<h4 id="synchronized示例"><a href="#synchronized示例" class="headerlink" title="synchronized示例"></a>synchronized示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">syncTest3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">    </span><br><span class="line">    Thread thread1 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">            Random r = <span class="keyword">new</span> Random(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">synchronized</span>(list)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    list.add(<span class="keyword">new</span> Integer(r.nextInt()));</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"The size of list is "</span> + list.size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Start."</span>);</span><br><span class="line">            Random r = <span class="keyword">new</span> Random(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">synchronized</span>(list)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    list.add(<span class="keyword">new</span> Integer(r.nextInt()));</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"The size of list is "</span> + list.size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(InterruptedException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" End."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们应该把需要同步的内容集中在一起，尽量不包含其他不相关的、消耗大量资源的操作，示例中线程休眠的操作显然不应该包括在里面。</p>
<h2 id="构造线程池"><a href="#构造线程池" class="headerlink" title="构造线程池"></a>构造线程池</h2><p>我们在Java网络通信中，已经构建了一个Socket连接池，这里我们在此基础上，构建一个线程池，完成基本的启动、休眠、唤醒、停止操作。</p>
<p>基本思路还是以数组的形式保持一系列线程，通过Socket通信，客户端向服务器端发送命令，当服务器端接收到命令后，根据收到的命令对线程数组中的线程进行操作。</p>
<p>Socket客户端的代码保持不变，依然采用构建Socket连接池时的代码，我们主要针对服务器端进行改造。</p>
<p>首先，我们需要定义一个线程对象，它用来执行我们的业务操作，这里简化起见，只让线程进行休眠。</p>
<h3 id="定义线程对象"><a href="#定义线程对象" class="headerlink" title="定义线程对象"></a>定义线程对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ThreadStatus</span><br><span class="line">&#123;</span><br><span class="line">    Initial,</span><br><span class="line">    Running,</span><br><span class="line">    Sleeping,</span><br><span class="line">    Stopped</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ThreadTask</span><br><span class="line">&#123;</span><br><span class="line">    Start,</span><br><span class="line">    Stop,</span><br><span class="line">    Sleep,</span><br><span class="line">    Wakeup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> ThreadStatus status = ThreadStatus.Initial;</span><br><span class="line">    <span class="keyword">public</span> ThreadTask task;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        status = ThreadStatus.Running;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                <span class="keyword">if</span> (status == ThreadStatus.Sleeping)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" 进入休眠状态。"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" 运行过程中出现错误。"</span>);</span><br><span class="line">                status = ThreadStatus.Stopped;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们需要定义一个线程管理器，它用来对线程池中的线程进行管理，代码如下：</p>
<h3 id="定义线程池管理对象"><a href="#定义线程池管理对象" class="headerlink" title="定义线程池管理对象"></a>定义线程池管理对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">manageThread</span><span class="params">(MyThread[] threads, ThreadTask task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(threads[i])</span><br><span class="line">            &#123;</span><br><span class="line">                manageThread(threads[i], task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(getThreadStatus(threads));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">manageThread</span><span class="params">(MyThread thread, ThreadTask task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (task == ThreadTask.Start)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread.status == ThreadStatus.Running)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (thread.status == ThreadStatus.Stopped)</span><br><span class="line">            &#123;</span><br><span class="line">                thread = <span class="keyword">new</span> MyThread();</span><br><span class="line">            &#125;</span><br><span class="line">            thread.status = ThreadStatus.Running;</span><br><span class="line">            thread.start();</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (task == ThreadTask.Stop)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread.status != ThreadStatus.Stopped)</span><br><span class="line">            &#123;</span><br><span class="line">                thread.interrupt();</span><br><span class="line">                thread.status = ThreadStatus.Stopped;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (task == ThreadTask.Sleep)</span><br><span class="line">        &#123;</span><br><span class="line">            thread.status = ThreadStatus.Sleeping;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (task == ThreadTask.Wakeup)</span><br><span class="line">        &#123;</span><br><span class="line">            thread.notify();</span><br><span class="line">            thread.status = ThreadStatus.Running;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getThreadStatus</span><span class="params">(MyThread[] threads)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.append(threads[i].getName() + <span class="string">"的状态："</span> + threads[i].status).append(<span class="string">"\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，是我们的服务器端，它不断接受客户端的请求，每收到一个连接请求，服务器端会新开一个线程，来处理后续客户端发来的各种操作指令。</p>
<h3 id="定义服务器端线程池对象"><a href="#定义服务器端线程池对象" class="headerlink" title="定义服务器端线程池对象"></a>定义服务器端线程池对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThreadPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MyThreadPool pool = <span class="keyword">new</span> MyThreadPool(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> threadCount;</span><br><span class="line">    <span class="keyword">private</span> MyThread[] threads = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span><span class="params">(<span class="keyword">int</span> count)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.threadCount = count;</span><br><span class="line">        threads = <span class="keyword">new</span> MyThread[count];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> MyThread();</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">5678</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">final</span> Socket socket = serverSocket.accept();</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(<span class="string">"检测到一个新的Socket连接。"</span>);</span><br><span class="line">                        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">                        PrintStream ps = <span class="keyword">new</span> PrintStream(socket.getOutputStream());</span><br><span class="line">                        String line = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            System.out.println(line);</span><br><span class="line">                            <span class="keyword">if</span> (line.equals(<span class="string">"Count"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                System.out.println(<span class="string">"线程池中有5个线程"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"Status"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                String status = MyThreadManager.getThreadStatus(threads);</span><br><span class="line">                                System.out.println(status);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"StartAll"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                MyThreadManager.manageThread(threads, ThreadTask.Start);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"StopAll"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                MyThreadManager.manageThread(threads, ThreadTask.Stop);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"SleepAll"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                MyThreadManager.manageThread(threads, ThreadTask.Sleep);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"WakeupAll"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                MyThreadManager.manageThread(threads, ThreadTask.Wakeup);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (line.equals(<span class="string">"End"</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                System.out.println(<span class="string">"Command:"</span> + line);</span><br><span class="line">                            &#125;</span><br><span class="line">                            ps.println(<span class="string">"OK"</span>);</span><br><span class="line">                            ps.flush();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="探索JDK中的concurrent工具包"><a href="#探索JDK中的concurrent工具包" class="headerlink" title="探索JDK中的concurrent工具包"></a>探索JDK中的concurrent工具包</h2><p>为了简化开发人员在进行多线程开发时的工作量，并减少程序中的bug，JDK提供了一套concurrent工具包，我们可以用它来方便的开发多线程程序。</p>
<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池　　"></a>线程池　　</h3><p>我们在上面实现了一个非常“简陋”的线程池，concurrent工具包中也提供了线程池，而且使用非常方便。</p>
<p>concurrent工具包中的线程池分为3类：ScheduledThreadPool、FixedThreadPool和CachedThreadPool。</p>
<p>首先我们来定义一个Runnable的对象</p>
<h4 id="定义Runnable对象"><a href="#定义Runnable对象" class="headerlink" title="定义Runnable对象"></a>定义Runnable对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"运行开始"</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"正在运行"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"运行结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，它的功能非常简单，只是输出了线程的执行过程。</p>
<h4 id="ScheduledThreadPool"><a href="#ScheduledThreadPool" class="headerlink" title="ScheduledThreadPool"></a>ScheduledThreadPool</h4><p>这和我们平时使用的ScheduledTask比较类似，或者说很像Timer，它可以使得一个线程在指定的一段时间内开始运行，并且在间隔另外一段时间后再次运行，直到线程池关闭。</p>
<h5 id="ScheduledThreadPool示例"><a href="#ScheduledThreadPool示例" class="headerlink" title="ScheduledThreadPool示例"></a>ScheduledThreadPool示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ScheduledThreadPool示例</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scheduledThreadPoolTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    MyRunner runner = <span class="keyword">new</span> MyRunner();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> ScheduledFuture&lt;?&gt; handler1 = scheduler.scheduleAtFixedRate(runner, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">final</span> ScheduledFuture&lt;?&gt; handler2 = scheduler.scheduleWithFixedDelay(runner, <span class="number">2</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    </span><br><span class="line">    scheduler.schedule(<span class="keyword">new</span> Runnable()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            handler1.cancel(<span class="keyword">true</span>);</span><br><span class="line">            handler2.cancel(<span class="keyword">true</span>);</span><br><span class="line">            scheduler.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">30</span>, TimeUnit.SECONDS</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FixedThreadPool"><a href="#FixedThreadPool" class="headerlink" title="FixedThreadPool"></a>FixedThreadPool</h4><p>这是一个指定容量的线程池，即我们可以指定在同一时间，线程池中最多有多个线程在运行，超出的线程，需要等线程池中有空闲线程时，才能有机会运行。</p>
<h5 id="FixedThreadPool示例"><a href="#FixedThreadPool示例" class="headerlink" title="FixedThreadPool示例"></a>FixedThreadPool示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixedThreadPoolTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        MyRunner runner = <span class="keyword">new</span> MyRunner();</span><br><span class="line">        exec.execute(runner);</span><br><span class="line">    &#125;</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意它的输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1运行开始</span><br><span class="line">pool-1-thread-1正在运行</span><br><span class="line">pool-1-thread-2运行开始</span><br><span class="line">pool-1-thread-2正在运行</span><br><span class="line">pool-1-thread-3运行开始</span><br><span class="line">pool-1-thread-3正在运行</span><br><span class="line">pool-1-thread-1运行结束</span><br><span class="line">pool-1-thread-1运行开始</span><br><span class="line">pool-1-thread-1正在运行</span><br><span class="line">pool-1-thread-2运行结束</span><br><span class="line">pool-1-thread-2运行开始</span><br><span class="line">pool-1-thread-2正在运行</span><br><span class="line">pool-1-thread-3运行结束</span><br><span class="line">pool-1-thread-1运行结束</span><br><span class="line">pool-1-thread-2运行结束</span><br></pre></td></tr></table></figure>
<p>可以看到从始至终，最多有3个线程在同时运行。</p>
<h4 id="CachedThreadPool"><a href="#CachedThreadPool" class="headerlink" title="CachedThreadPool"></a>CachedThreadPool</h4><p>这是另外一种线程池，它不需要指定容量，只要有需要，它就会创建新的线程。</p>
<p>它的使用方式和FixedThreadPool非常像，来看下面的代码：</p>
<h5 id="CachedThreadPool示例"><a href="#CachedThreadPool示例" class="headerlink" title="CachedThreadPool示例"></a>CachedThreadPool示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cachedThreadPoolTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        MyRunner runner = <span class="keyword">new</span> MyRunner();</span><br><span class="line">        exec.execute(runner);</span><br><span class="line">    &#125;</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　它的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1运行开始</span><br><span class="line">pool-1-thread-1正在运行</span><br><span class="line">pool-1-thread-2运行开始</span><br><span class="line">pool-1-thread-2正在运行</span><br><span class="line">pool-1-thread-3运行开始</span><br><span class="line">pool-1-thread-3正在运行</span><br><span class="line">pool-1-thread-4运行开始</span><br><span class="line">pool-1-thread-4正在运行</span><br><span class="line">pool-1-thread-5运行开始</span><br><span class="line">pool-1-thread-5正在运行</span><br><span class="line">pool-1-thread-1运行结束</span><br><span class="line">pool-1-thread-2运行结束</span><br><span class="line">pool-1-thread-3运行结束</span><br><span class="line">pool-1-thread-4运行结束</span><br><span class="line">pool-1-thread-5运行结束</span><br></pre></td></tr></table></figure>
<p>可以看到，它创建了5个线程。</p>
<h4 id="处理线程返回值"><a href="#处理线程返回值" class="headerlink" title="处理线程返回值"></a>处理线程返回值</h4><p>在有些情况下，我们需要使用线程的返回值，在上述的所有代码中，线程这是执行了某些操作，没有任何返回值。</p>
<p>如何做到这一点呢？我们可以使用JDK中的Callable<t>和CompletionService<t>，前者返回单个线程的结果，后者返回一组线程的结果。</t></t></p>
<h4 id="返回单个线程的结果"><a href="#返回单个线程的结果" class="headerlink" title="返回单个线程的结果"></a>返回单个线程的结果</h4><p>　　还是直接看代码吧：</p>
<h5 id="Callable示例"><a href="#Callable示例" class="headerlink" title="Callable示例"></a>Callable示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">callableTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    Callable&lt;String&gt; call = <span class="keyword">new</span> Callable&lt;String&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello World."</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Future&lt;String&gt; result = exec.submit(call);</span><br><span class="line">    System.out.println(<span class="string">"线程的返回值是"</span> + result.get());</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>线程的返回值是Hello World.</p>
<p>返回线程池中每个线程的结果</p>
<p>这里需要使用CompletionService<t>，代码如下：</t></p>
<h5 id="CompletionService示例"><a href="#CompletionService示例" class="headerlink" title="CompletionService示例"></a>CompletionService示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">completionServiceTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    CompletionService&lt;String&gt; service = <span class="keyword">new</span> ExecutorCompletionService&lt;String&gt;(exec);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Callable&lt;String&gt; call = <span class="keyword">new</span> Callable&lt;String&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        service.submit(call);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Future&lt;String&gt; result = service.take();</span><br><span class="line">        System.out.println(<span class="string">"线程的返回值是"</span> + result.get());</span><br><span class="line">    &#125;</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">线程的返回值是pool-2-thread-1</span><br><span class="line">线程的返回值是pool-2-thread-2</span><br><span class="line">线程的返回值是pool-2-thread-3</span><br><span class="line">线程的返回值是pool-2-thread-5</span><br><span class="line">线程的返回值是pool-2-thread-4</span><br><span class="line">线程的返回值是pool-2-thread-6</span><br><span class="line">线程的返回值是pool-2-thread-8</span><br><span class="line">线程的返回值是pool-2-thread-7</span><br><span class="line">线程的返回值是pool-2-thread-9</span><br><span class="line">线程的返回值是pool-2-thread-10</span><br></pre></td></tr></table></figure>
<h4 id="实现生产者-消费者模型"><a href="#实现生产者-消费者模型" class="headerlink" title="实现生产者-消费者模型"></a>实现生产者-消费者模型</h4><p>对于生产者-消费者模型来说，我们应该都不会陌生，通常我们都会使用某种数据结构来实现它。在concurrent工具包中，我们可以使用BlockingQueue来实现生产者-消费者模型，如下：</p>
<h5 id="BlockingQueue示例"><a href="#BlockingQueue示例" class="headerlink" title="BlockingQueue示例"></a>BlockingQueue示例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">public class BlockingQueueSample &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        blockingQueueTest();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void blockingQueueTest()</span><br><span class="line">    &#123;</span><br><span class="line">        final BlockingQueue&lt;Integer&gt; queue = new LinkedBlockingQueue&lt;Integer&gt;();</span><br><span class="line">        final int maxSleepTimeForSetter = 10;</span><br><span class="line">        final int maxSleepTimerForGetter = 10;</span><br><span class="line">        </span><br><span class="line">        Runnable setter = new Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            public void run()</span><br><span class="line">            &#123;</span><br><span class="line">                Random r = new Random();</span><br><span class="line">                while(true)</span><br><span class="line">                &#123;</span><br><span class="line">                    int value = r.nextInt(100);</span><br><span class="line">                    try</span><br><span class="line">                    &#123;</span><br><span class="line">                        queue.put(new Integer(value));</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + &quot;---向队列中插入值&quot; + value);</span><br><span class="line">                        Thread.sleep(r.nextInt(maxSleepTimeForSetter) * 1000);</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch(Exception ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        Runnable getter = new Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            public void run()</span><br><span class="line">            &#123;</span><br><span class="line">                Random r = new Random();</span><br><span class="line">                while(true)</span><br><span class="line">                &#123;</span><br><span class="line">                    try</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (queue.size() == 0)</span><br><span class="line">                        &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + &quot;---队列为空&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            int value = queue.take().intValue();</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + &quot;---从队列中获取值&quot; + value);</span><br><span class="line">                        &#125;</span><br><span class="line">                        Thread.sleep(r.nextInt(maxSleepTimerForGetter) * 1000);</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch(Exception ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        ExecutorService exec = Executors.newFixedThreadPool(2);</span><br><span class="line">        exec.execute(setter);</span><br><span class="line">        exec.execute(getter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们定义了两个线程，一个线程向Queue中添加数据，一个线程从Queue中取数据。我们可以通过控制maxSleepTimeForSetter和maxSleepTimerForGetter的值，来使得程序得出不同的结果。</p>
<p>可能的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1---向队列中插入值88</span><br><span class="line">pool-1-thread-2---从队列中获取值88</span><br><span class="line">pool-1-thread-1---向队列中插入值75</span><br><span class="line">pool-1-thread-2---从队列中获取值75</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-1---向队列中插入值50</span><br><span class="line">pool-1-thread-2---从队列中获取值50</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-2---队列为空</span><br><span class="line">pool-1-thread-1---向队列中插入值51</span><br><span class="line">pool-1-thread-1---向队列中插入值92</span><br><span class="line">pool-1-thread-2---从队列中获取值51</span><br><span class="line">pool-1-thread-2---从队列中获取值92</span><br></pre></td></tr></table></figure>
<p>因为Queue中的值和Thread的休眠时间都是随机的，所以执行结果也不是固定的。</p>
<h4 id="使用信号量来控制线程"><a href="#使用信号量来控制线程" class="headerlink" title="使用信号量来控制线程"></a>使用信号量来控制线程</h4><p>JDK提供了Semaphore来实现“信号量”的功能，它提供了两个方法分别用于获取和释放信号量：acquire和release，示例代码如下：</p>
<h5 id="SemaPhore示例"><a href="#SemaPhore示例" class="headerlink" title="SemaPhore示例"></a>SemaPhore示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">semaphoreTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">final</span> Semaphore semp = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Runnable runner = <span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    semp.acquire();</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> Date() + <span class="string">" "</span> + Thread.currentThread().getName() + <span class="string">"正在执行。"</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                    semp.release();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        exec.execute(runner);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Tue May 07 11:22:11 CST 2013 pool-1-thread-1正在执行。</span><br><span class="line">Tue May 07 11:22:11 CST 2013 pool-1-thread-2正在执行。</span><br><span class="line">Tue May 07 11:22:17 CST 2013 pool-1-thread-3正在执行。</span><br><span class="line">Tue May 07 11:22:17 CST 2013 pool-1-thread-4正在执行。</span><br><span class="line">Tue May 07 11:22:22 CST 2013 pool-1-thread-5正在执行。</span><br><span class="line">Tue May 07 11:22:22 CST 2013 pool-1-thread-6正在执行。</span><br><span class="line">Tue May 07 11:22:27 CST 2013 pool-1-thread-7正在执行。</span><br><span class="line">Tue May 07 11:22:27 CST 2013 pool-1-thread-8正在执行。</span><br><span class="line">Tue May 07 11:22:32 CST 2013 pool-1-thread-10正在执行。</span><br><span class="line">Tue May 07 11:22:32 CST 2013 pool-1-thread-9正在执行。</span><br></pre></td></tr></table></figure>
<p>可以看出，尽管线程池中创建了10个线程，但是同时运行的，只有2个线程。</p>
<h4 id="控制线程池中所有线程的执行步骤"><a href="#控制线程池中所有线程的执行步骤" class="headerlink" title="控制线程池中所有线程的执行步骤"></a>控制线程池中所有线程的执行步骤</h4><p>在前面，我们已经提到，可以用synchronized关键字来控制单个线程中的执行步骤，那么如果我们想要对线程池中的所有线程的执行步骤进行控制的话，应该如何实现呢？</p>
<p>我们有两种方式，一种是使用CyclicBarrier，一种是使用CountDownLatch。</p>
<p>CyclicBarrier使用了类似于Object.wait的机制，它的构造函数中需要接收一个整型数字，用来说明它需要控制的线程数目，当在线程的run方法中调用它的await方法时，它会保证所有的线程都执行到这一步，才会继续执行后面的步骤。</p>
<p>示例代码如下：</p>
<h5 id="CyclicBarrier示例"><a href="#CyclicBarrier示例" class="headerlink" title="CyclicBarrier示例"></a>CyclicBarrier示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRunner2</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CyclicBarrier barrier = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRunner2</span><span class="params">(CyclicBarrier barrier)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.barrier = barrier;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random r = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Thread.sleep(r.nextInt(<span class="number">10</span>) * <span class="number">1000</span>);</span><br><span class="line">                System.out.println(<span class="keyword">new</span> Date() + <span class="string">"--"</span> + Thread.currentThread().getName() + <span class="string">"--第"</span> + (i + <span class="number">1</span>) + <span class="string">"次等待。"</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cyclicBarrierTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        exec.execute(<span class="keyword">new</span> MyRunner2(barrier));</span><br><span class="line">    &#125;</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Tue May 07 11:31:20 CST 2013--pool-1-thread-2--第1次等待。</span><br><span class="line">Tue May 07 11:31:21 CST 2013--pool-1-thread-3--第1次等待。</span><br><span class="line">Tue May 07 11:31:24 CST 2013--pool-1-thread-1--第1次等待。</span><br><span class="line">Tue May 07 11:31:24 CST 2013--pool-1-thread-1--第2次等待。</span><br><span class="line">Tue May 07 11:31:26 CST 2013--pool-1-thread-3--第2次等待。</span><br><span class="line">Tue May 07 11:31:30 CST 2013--pool-1-thread-2--第2次等待。</span><br><span class="line">Tue May 07 11:31:32 CST 2013--pool-1-thread-1--第3次等待。</span><br><span class="line">Tue May 07 11:31:33 CST 2013--pool-1-thread-3--第3次等待。</span><br><span class="line">Tue May 07 11:31:33 CST 2013--pool-1-thread-2--第3次等待。</span><br></pre></td></tr></table></figure>
<p>可以看出，thread-2到第1次等待点时，一直等到thread-1到达后才继续执行。</p>
<p>CountDownLatch则是采取类似”倒计时计数器”的机制来控制线程池中的线程，它有CountDown和Await两个方法。示例代码如下：</p>
<h5 id="CountDownLatch示例"><a href="#CountDownLatch示例" class="headerlink" title="CountDownLatch示例"></a>CountDownLatch示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">countdownLatchTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> CountDownLatch begin = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">final</span> CountDownLatch end = <span class="keyword">new</span> CountDownLatch(<span class="number">5</span>);</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Runnable runner = <span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                Random r = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    begin.await();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"运行开始"</span>);</span><br><span class="line">                    Thread.sleep(r.nextInt(<span class="number">10</span>)*<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"运行结束"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span></span><br><span class="line">                &#123;</span><br><span class="line">                    end.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        exec.execute(runner);</span><br><span class="line">    &#125;</span><br><span class="line">    begin.countDown();</span><br><span class="line">    end.await();</span><br><span class="line">    System.out.println(Thread.currentThread().getName() + <span class="string">"运行结束"</span>);</span><br><span class="line">    exec.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1运行开始</span><br><span class="line">pool-1-thread-5运行开始</span><br><span class="line">pool-1-thread-2运行开始</span><br><span class="line">pool-1-thread-3运行开始</span><br><span class="line">pool-1-thread-4运行开始</span><br><span class="line">pool-1-thread-2运行结束</span><br><span class="line">pool-1-thread-1运行结束</span><br><span class="line">pool-1-thread-3运行结束</span><br><span class="line">pool-1-thread-5运行结束</span><br><span class="line">pool-1-thread-4运行结束</span><br><span class="line">main运行结束</span><br></pre></td></tr></table></figure>
<h1 id="Java集合"><a href="#Java集合" class="headerlink" title="Java集合"></a>Java集合</h1><p>Java中的集合（Collection）。集合是编程语言中基础的一部分，Java自JDK早期，就引入了Java Collection Framework。设计JCF的那个人，后来还写了一本书，叫《Effective Java》。</p>
<p>Java中的集合主要集中在2部分，一部分是java.util包中，一部分是java.util.concurrent中，后者是在前者的基础上，定义了一些实现了同步功能的集合。</p>
<p>这篇文章主要关注java.util下的各种集合对象。Java中的集合对象可以粗略的分为3类：List、Set和Map。</p>
<p>完整清晰版图片请参见：<a href="http://files.cnblogs.com/wing011203/java_collection_structure.zip，解压缩后就可以看到未经缩放的版本。" target="_blank" rel="noopener">http://files.cnblogs.com/wing011203/java_collection_structure.zip，解压缩后就可以看到未经缩放的版本。</a></p>
<h2 id="Collection概述"><a href="#Collection概述" class="headerlink" title="Collection概述"></a>Collection概述</h2><p>Java集合中的List和Set都从Collection出来，它是一个学习集合很不错的入口，它包含了集合中通常需要有的操作：</p>
<ul>
<li>添加元素：add/addAll</li>
<li>清空集合：clear</li>
<li>删除元素：remove/removeAll</li>
<li>判断集合中是否包含某元素：contains/containsAll</li>
<li>判断集合是否为空：isEmpty</li>
<li>计算集合中元素的个数：size</li>
<li>将集合转换为数组：toArray</li>
<li>获取迭代器：iterator
　　</li>
</ul>
<p>我们来看一个简单的例子，下面的代码会返回一个集合，集合中的元素是随机生成的整数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Collection <span class="title">initCollection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Collection&lt;Integer&gt; collection = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">    Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        collection.add(<span class="keyword">new</span> Integer(r.nextInt(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> collection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在对集合进行操作的过程中，遍历是一个经常使用的操作，我们可以使用两种方式对集合进行遍历：</p>
<ol>
<li>使用迭代器对集合进行遍历。正如上面描述Collection接口时所说，所有集合都会有一个迭代器，我们可以用它来遍历集合。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">accessCollectionByIterator</span><span class="params">(Collection&lt;Integer&gt; collection)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Iterator&lt;Integer&gt; iterator = collection.iterator();</span><br><span class="line">    System.out.println(<span class="string">"The value in the list:"</span>);</span><br><span class="line">    <span class="keyword">while</span>(iterator.hasNext())</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(iterator.next());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用foreach遍历集合。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">accessCollectionByFor</span><span class="params">(Collection&lt;Integer&gt; collection)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"The value in the list:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(Integer value : collection)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>　　Java中的List是对数组的有效扩展，它是这样一种结构，如果不使用泛型，它可以容纳任何类型的元素，如果使用泛型，那么它只能容纳泛型指定的类型的元素。和数组相比，List的容量是可以动态扩展的。</p>
<p>　　List中的元素是可以重复的，里面的元素是“有序”的，这里的“有序”，并不是排序的意思，而是说我们可以对某个元素在集合中的位置进行指定。</p>
<p>　　List中常用的集合对象包括：ArrayList、Vector和LinkedList，其中前两者是基于数组来进行存储，后者是基于链表进行存储。其中Vector是线程安全的，其余两个不是线程安全的。</p>
<p>　　List中是可以包括null的，即使是使用了泛型。</p>
<p>　　ArrayList可能是我们平时用到的最多的集合对象了，在上述的示例代码中，我们也是使用它来实例化一个Collection对象，在此不再赘述。</p>
<h2 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h2><p>　　Vector的示例如下，首先我们看如何生成和输出Vector：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vectorTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> Vector&lt;Integer&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> Integer(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    list.add(<span class="keyword">null</span>);</span><br><span class="line">    System.out.println(<span class="string">"size of vector is "</span> + list.size());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的元素中，既包括了重复元素，也包括了null，输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size of vector is 6</span><br><span class="line">[100, 100, 100, 100, 100, null]</span><br></pre></td></tr></table></figure>
<p>下面的示例，演示了Vector中的一些常用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vectorTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector&lt;Integer&gt; list = <span class="keyword">new</span> Vector&lt;Integer&gt;();</span><br><span class="line">    Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> Integer(r.nextInt(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"size of vector is "</span> + list.size());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">    System.out.println(list.firstElement());</span><br><span class="line">    System.out.println(list.lastElement());</span><br><span class="line">    System.out.println(list.subList(<span class="number">3</span>, <span class="number">8</span>));</span><br><span class="line">    List&lt;Integer&gt; temp = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">4</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp.add(list.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    list.retainAll(temp);</span><br><span class="line">    System.out.println(<span class="string">"size of vector is "</span> + list.size());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">size of vector is 10</span><br><span class="line">[39, 41, 20, 9, 29, 32, 54, 12, 94, 82]</span><br><span class="line">39</span><br><span class="line">82</span><br><span class="line">[9, 29, 32, 54, 12]</span><br><span class="line">size of vector is 3</span><br><span class="line">[29, 32, 54]</span><br></pre></td></tr></table></figure>
<h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><p>　　LinkedList使用链表来存储数据，它的示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">linkedListTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LinkedList&lt;Integer&gt; list = <span class="keyword">new</span> LinkedList&lt;Integer&gt;();</span><br><span class="line">    Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> Integer(r.nextInt(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    list.add(<span class="keyword">null</span>);</span><br><span class="line">    System.out.println(<span class="string">"size of linked list is "</span> + list.size());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">    System.out.println(list.element());</span><br><span class="line">    System.out.println(list.getFirst());</span><br><span class="line">    System.out.println(list.getLast());</span><br><span class="line">    System.out.println(list.peek());</span><br><span class="line">    System.out.println(list.peekFirst());</span><br><span class="line">    System.out.println(list.peekLast());</span><br><span class="line">    System.out.println(list.poll());</span><br><span class="line">    System.out.println(list.pollFirst());</span><br><span class="line">    System.out.println(list.pollLast());</span><br><span class="line">    System.out.println(list.pop());</span><br><span class="line">    list.push(<span class="keyword">new</span> Integer(<span class="number">100</span>));</span><br><span class="line">    System.out.println(<span class="string">"size of linked list is "</span> + list.size());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里列出了LinkedList常用的各个方法，从方法名可以看出，LinkedList也可以用来实现栈和队列。</p>
<p>　　输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">size of linked list is 11</span><br><span class="line">[17, 21, 5, 84, 19, 57, 68, 26, 27, 47, null]</span><br><span class="line">17</span><br><span class="line">null</span><br><span class="line">17</span><br><span class="line">null</span><br><span class="line">21</span><br><span class="line">null</span><br><span class="line">size of linked list is 8</span><br><span class="line">[100, 84, 19, 57, 68, 26, 27, 47]</span><br></pre></td></tr></table></figure>
<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>　　Set 和List类似，都是用来存储单个元素，单个元素的数量不确定。但Set不能包含重复元素，如果向Set中插入两个相同元素，那么后一个元素不会被插入。</p>
<p>　　Set可以大致分为两类：不排序Set和排序Set，不排序Set包括HashSet和LinkedHashSet，排序Set主要指TreeSet。其中HashSet和LinkedHashSet可以包含null。</p>
<h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h3><p>　　<strong>HashSet是由Hash表支持的一种集合，它不是线程安全的。</strong></p>
<p>　　我们来看下面的示例，它和Vector的第一个示例基本上是相同的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashSetTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;Integer&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        set.add(<span class="keyword">new</span> Integer(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    set.add(<span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">"size of set is "</span> + set.size());</span><br><span class="line">    System.out.println(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　这里，<strong>HashSet中没有包含重复元素，但包含了null，和Vector不同，</strong>这里的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size of set is 2</span><br><span class="line">[null, 100]</span><br></pre></td></tr></table></figure>
<p>　　对于HashSet是如何判断两个元素是否是重复的，我们可以深入考察一下。Object中也定义了equals方法，对于HashSet中的元素，它是根据equals方法来判断元素是否相等的，为了证明这一点，我们可以定义个“不正常”的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInteger</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyInteger</span><span class="params">(Integer value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　可以看到，对于MyInteger来说，对于任意两个实例，我们都认为它是不相等的。</p>
<p>　　下面是对应的测试方法：
　　</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashSetTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Set&lt;MyInteger&gt; set = <span class="keyword">new</span> HashSet&lt;MyInteger&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        set.add(<span class="keyword">new</span> MyInteger(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">"size of set is "</span> + set.size());</span><br><span class="line">    System.out.println(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size of set is 3</span><br><span class="line">[100, 100, 100]</span><br></pre></td></tr></table></figure>
<p>　　可以看到，现在HashSet里有“重复”元素了，但对于MyInteger来说，它们不是“相同”的。</p>
<h3 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h3><p>TreeSet是支持排序的一种Set，它的父接口是SortedSet。</p>
<p>　　我们首先来看一下TreeSet都有哪些基本操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">treeSetTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TreeSet&lt;Integer&gt; set = <span class="keyword">new</span> TreeSet&lt;Integer&gt;();</span><br><span class="line">    </span><br><span class="line">    Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        set.add(<span class="keyword">new</span> Integer(r.nextInt(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(set);</span><br><span class="line">    System.out.println(set.first());</span><br><span class="line">    System.out.println(set.last());</span><br><span class="line">    System.out.println(set.descendingSet());</span><br><span class="line">    System.out.println(set.headSet(<span class="keyword">new</span> Integer(<span class="number">50</span>)));</span><br><span class="line">    System.out.println(set.tailSet(<span class="keyword">new</span> Integer(<span class="number">50</span>)));</span><br><span class="line">    System.out.println(set.subSet(<span class="number">30</span>, <span class="number">60</span>));</span><br><span class="line">    System.out.println(set.floor(<span class="number">50</span>));</span><br><span class="line">    System.out.println(set.ceiling(<span class="number">50</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[8, 42, 48, 49, 53]</span><br><span class="line">8</span><br><span class="line">53</span><br><span class="line">[53, 49, 48, 42, 8]</span><br><span class="line">[8, 42, 48, 49]</span><br><span class="line">[53]</span><br><span class="line">[42, 48, 49, 53]</span><br><span class="line">49</span><br><span class="line">53</span><br></pre></td></tr></table></figure>
<p>　　TreeSet中的元素，一般都实现了Comparable接口，默认情况下，对于Integer来说，SortedList是采用升序来存储的，我们也可以自定义Compare方式，例如以降序的方式来存储。</p>
<p>　　下面，我们首先重新定义Integer：</p>
<h4 id="定义MyInteger2对象"><a href="#定义MyInteger2对象" class="headerlink" title="定义MyInteger2对象"></a>定义MyInteger2对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInteger2</span> <span class="keyword">implements</span> <span class="title">Comparable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> value;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyInteger2</span><span class="params">(<span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object arg0)</span>  </span>&#123;</span><br><span class="line">        MyInteger2 temp = (MyInteger2)arg0;</span><br><span class="line">        <span class="keyword">if</span> (temp == <span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (temp.value &gt; <span class="keyword">this</span>.value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (temp.value &lt; <span class="keyword">this</span>.value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> compareTo(obj) == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">treeSetTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TreeSet&lt;Integer&gt; set1 = <span class="keyword">new</span> TreeSet&lt;Integer&gt;();</span><br><span class="line">    TreeSet&lt;MyInteger2&gt; set2 = <span class="keyword">new</span> TreeSet&lt;MyInteger2&gt;();</span><br><span class="line">    Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> value = r.nextInt(<span class="number">100</span>);</span><br><span class="line">        set1.add(<span class="keyword">new</span> Integer(value));</span><br><span class="line">        set2.add(<span class="keyword">new</span> MyInteger2(value));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"Set1 as below:"</span>);</span><br><span class="line">    System.out.println(set1);</span><br><span class="line">    System.out.println(<span class="string">"Set2 as below:"</span>);</span><br><span class="line">    System.out.println(set2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码的运行结果如我们所预期的那样，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Set1 as below:</span><br><span class="line">[13, 41, 42, 45, 61]</span><br><span class="line">Set2 as below:</span><br><span class="line">[61, 45, 42, 41, 13]</span><br></pre></td></tr></table></figure>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>　　Map中存储的是“键值对”，和Set类似，Java中的Map也有两种：排序的和不排序的，不排序的包括HashMap、Hashtable和LinkedHashMap，排序的包括TreeMap。</p>
<h3 id="非排序Map"><a href="#非排序Map" class="headerlink" title="非排序Map"></a>非排序Map</h3><p>　　HashMap和Hashtable都是采取Hash表的方式进行存储，HashMap不是线程安全的，Hashtable是线程安全的，我们可以把HashMap看做是“简化”版的Hashtable。</p>
<p>　　HashMap是可以存储null的，无论是对Key还是对Value。Hashtable是不可以存储null的。</p>
<p>　　无论HashMap还是Hashtable，我们观察它的构造函数，就会发现它可以有两个参数：initialCapacity和loadFactor，默认情况下，initialCapacity等于16，loadFactor等于0.75。这和Hash表中可以存放的元素数目有关系，当元素数目超过initialCapacity*loadFactor时，会触发rehash方法，对hash表进行扩容。如果我们需要向其中插入过多元素，需要适当调整这两个参数。</p>
<p>　　我们首先来看HashMap的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashMapTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; map = <span class="keyword">new</span> HashMap&lt;Integer, String&gt;();</span><br><span class="line">    </span><br><span class="line">    map.put(<span class="keyword">new</span> Integer(<span class="number">1</span>), <span class="string">"a"</span>);</span><br><span class="line">    map.put(<span class="keyword">new</span> Integer(<span class="number">2</span>), <span class="string">"b"</span>);</span><br><span class="line">    map.put(<span class="keyword">new</span> Integer(<span class="number">3</span>), <span class="string">"c"</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(map);</span><br><span class="line">    System.out.println(map.entrySet());</span><br><span class="line">    System.out.println(map.keySet());</span><br><span class="line">    System.out.println(map.values());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　这会输出HashMap里的元素信息，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;1=a, 2=b, 3=c&#125;</span><br><span class="line">[1=a, 2=b, 3=c]</span><br><span class="line">[1, 2, 3]</span><br><span class="line">[a, b, c]</span><br></pre></td></tr></table></figure>
<p>　　下面的示例是对null的演示：<br>　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashMapTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; map = <span class="keyword">new</span> HashMap&lt;Integer, String&gt;();</span><br><span class="line">    </span><br><span class="line">    map.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    map.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    map.put(<span class="keyword">new</span> Integer(<span class="number">4</span>), <span class="keyword">null</span>);</span><br><span class="line">    map.put(<span class="keyword">new</span> Integer(<span class="number">5</span>), <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(map);</span><br><span class="line">    System.out.println(map.entrySet());</span><br><span class="line">    System.out.println(map.keySet());</span><br><span class="line">    System.out.println(map.values());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;null=null, 4=null, 5=null&#125;</span><br><span class="line">[null=null, 4=null, 5=null]</span><br><span class="line">[null, 4, 5]</span><br><span class="line">[null, null, null]</span><br></pre></td></tr></table></figure>
<p>接下来我们演示Hashtable，和上述两个示例基本上完全一样（代码不再展开）：</p>
<h4 id="Hashtable示例"><a href="#Hashtable示例" class="headerlink" title="Hashtable示例"></a>Hashtable示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashTableTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; table = <span class="keyword">new</span> Hashtable&lt;Integer, String&gt;();</span><br><span class="line">    </span><br><span class="line">    table.put(<span class="keyword">new</span> Integer(<span class="number">1</span>), <span class="string">"a"</span>);</span><br><span class="line">    table.put(<span class="keyword">new</span> Integer(<span class="number">2</span>), <span class="string">"b"</span>);</span><br><span class="line">    table.put(<span class="keyword">new</span> Integer(<span class="number">3</span>), <span class="string">"c"</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(table);</span><br><span class="line">    System.out.println(table.entrySet());</span><br><span class="line">    System.out.println(table.keySet());</span><br><span class="line">    System.out.println(table.values());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashTableTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; table = <span class="keyword">new</span> Hashtable&lt;Integer, String&gt;();</span><br><span class="line">    </span><br><span class="line">    table.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    table.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    table.put(<span class="keyword">new</span> Integer(<span class="number">4</span>), <span class="keyword">null</span>);</span><br><span class="line">    table.put(<span class="keyword">new</span> Integer(<span class="number">5</span>), <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(table);</span><br><span class="line">    System.out.println(table.entrySet());</span><br><span class="line">    System.out.println(table.keySet());</span><br><span class="line">    System.out.println(table.values());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;3=c, 2=b, 1=a&#125;</span><br><span class="line">[3=c, 2=b, 1=a]</span><br><span class="line">[3, 2, 1]</span><br><span class="line">[c, b, a]</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class="line">    at java.util.Hashtable.put(Unknown Source)</span><br><span class="line">    at sample.collections.MapSample.hashTableTest2(MapSample.java:61)</span><br><span class="line">    at sample.collections.MapSample.main(MapSample.java:11)</span><br></pre></td></tr></table></figure>
<p>可以很清楚的看到，当我们试图将null插入到hashtable中时，报出了空指针异常。</p>
<h3 id="排序Map"><a href="#排序Map" class="headerlink" title="排序Map"></a>排序Map</h3><p>排序Map主要是指TreeMap，它对元素增、删、查操作时的时间复杂度都是O（log（n））。它不是线程安全的。</p>
<p>它的特点和TreeSet非常像，这里不再赘述。</p>
<h1 id="Java序列化"><a href="#Java序列化" class="headerlink" title="Java序列化"></a>Java序列化</h1><p>对象序列化。</p>
<p>　　首先，我们来讨论一下什么是序列化以及序列化的原理；然后给出一个简单的示例来演示序列化和反序列化；有时有些信息是不应该被序列化的，我们应该如何控制；我们如何去自定义序列化内容；最后我们讨论一下在继承结构的场景中，序列化需要注意哪些内容。</p>
<h2 id="序列化概述"><a href="#序列化概述" class="headerlink" title="序列化概述"></a>序列化概述</h2><p>　　序列化，简单来讲，就是以“流”的方式来保存对象，至于保存的目标地址，可以是文件，可以是数据库，也可以是网络，即通过网络将对象从一个节点传递到另一个节点。</p>
<p>　　我们知道在Java的I/O结构中，有ObjectOutputStream和ObjectInputStream，它们可以实现将对象输出为二进制流，并从二进制流中获取对象，那为什么还需要序列化呢？这需要从Java变量的存储结构谈起，我们知道对Java来说，基础类型存储在栈上，复杂类型（引用类型）存储在堆中，对于基础类型来说，上述的操作时可行的，但对复杂类型来说，上述操作过程中，可能会产生重复的对象，造成错误。</p>
<p>而序列化的工作流程如下：</p>
<p>　　1. 输出流保存的对象都有一个唯一的序列号。</p>
<p>　　2. 个对象需要保存时，先对其序列号进行检查。</p>
<p>　　3. 当保存的对象中已包含该序列号时，不需要再次保存，否则，进入正常保存的流程。</p>
<p>　　正是通过序列号的机制，序列化才可以完整准确的保存对象的各个状态。</p>
<p>　　序列化保存的是对象中的各个属性的值，而不是方法或者方法签名之类的信息。对于方法或者方法签名，只要JVM能够找到正确的ClassLoader，那么就可以invoke方法。</p>
<p>　　序列化不会保存类的静态变量，因为静态变量是作用于类型，而序列化作用于对象。</p>
<h2 id="简单的序列化示例"><a href="#简单的序列化示例" class="headerlink" title="简单的序列化示例"></a>简单的序列化示例</h2><p>　　序列化的完整过程包括两部分：</p>
<p>　　1. 使用ObjectOutputStream将对象保存为二进制流，这一步叫做“序列化”。</p>
<p>　　2. 使用ObjectInputStream将二进制流转换成对象，这一步叫做“反序列化”。</p>
<p>　　下面我们来演示一个简单的示例，首先定义一个Person对象，它包含name和age两个信息。</p>
<p>定义Person对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后是两个公共方法，用来完成读、写对象的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object obj, String filePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(filePath);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">        os.flush();</span><br><span class="line">        fos.flush();</span><br><span class="line">        os.close();</span><br><span class="line">        fos.close();</span><br><span class="line">        System.out.println(<span class="string">"序列化成功。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">readObject</span><span class="params">(String filePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">        ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        Object temp = is.readObject();</span><br><span class="line">        </span><br><span class="line">        fis.close();</span><br><span class="line">        is.close();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (temp != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"反序列化成功。"</span>);</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们将对象保存的二进制流输出到磁盘文件中。</p>
<p>　　接下来，我们首先来看“序列化”的方法：<br>　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Person person = <span class="keyword">new</span> Person();</span><br><span class="line">    person.setName(<span class="string">"Zhang San"</span>);</span><br><span class="line">    person.setAge(<span class="number">30</span>);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">    writeObject(person, <span class="string">"d:\\temp\\test\\person.obj"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　我们定义了一个Person实例，然后将其保存到d:\temp\test\person.obj中。</p>
<p>　　最后，是“反序列化”的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Person temp = (Person)readObject(<span class="string">"d:\\temp\\test\\person.obj"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (temp != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　它从d:\temp\test\person.obj中读取对象，然后进行输出。</p>
<p>　　上述两个方法的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name:Zhang San; Age:30</span><br><span class="line">序列化成功。</span><br><span class="line">反序列化成功。</span><br><span class="line">Name:Zhang San; Age:30</span><br></pre></td></tr></table></figure>
<p>　　可以看出，读取的对象和保存的对象是完全一致的。</p>
<h2 id="隐藏非序列化信息"><a href="#隐藏非序列化信息" class="headerlink" title="隐藏非序列化信息"></a>隐藏非序列化信息</h2><p>　　有时，我们的业务对象中会包含很多属性，而有些属性是比较隐私的，例如年龄、银行卡号等，这些信息是不太适合进行序列化的，特别是在需要通过网络来传输对象信息时，这些敏感信息很容易被窃取。</p>
<p>　　Java使用transient关键字来处理这种情况，针对那些敏感的属性，我们只需使用该关键字进行修饰，那么在序列化时，对应的属性值就不会被保存。</p>
<p>　　我们还是看一个实例，这次我们定义一个新的Person2，其中age信息是我们不希望序列化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person2</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意age的声明语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private transient int age;</span><br></pre></td></tr></table></figure>
<p>　　下面是“序列化”和“反序列化”的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Person2 person = <span class="keyword">new</span> Person2();</span><br><span class="line">    person.setName(<span class="string">"Zhang San"</span>);</span><br><span class="line">    person.setAge(<span class="number">30</span>);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">    writeObject(person, <span class="string">"d:\\temp\\test\\person2.obj"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Person2 temp = (Person2)readObject(<span class="string">"d:\\temp\\test\\person2.obj"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (temp != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name:Zhang San; Age:30</span><br><span class="line">序列化成功。</span><br><span class="line">反序列化成功。</span><br><span class="line">Name:Zhang San; Age:0</span><br></pre></td></tr></table></figure>
<p>　　可以看到经过反序列化的对象，age的信息变成了Integer的默认值0。</p>
<h3 id="自定义序列化过程"><a href="#自定义序列化过程" class="headerlink" title="自定义序列化过程"></a>自定义序列化过程</h3><p>　　我们可以对序列化的过程进行定制，进行更细粒度的控制。</p>
<p>　　思路是在业务模型中添加readObject和writeObject方法。下面看一个实例，我们新建一个类型，叫Person3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person3</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream os)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            os.defaultWriteObject();</span><br><span class="line">            os.writeObject(<span class="keyword">this</span>.age);</span><br><span class="line">            System.out.println(<span class="keyword">this</span>);</span><br><span class="line">            System.out.println(<span class="string">"序列化成功。"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream is)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            is.defaultReadObject();</span><br><span class="line">            <span class="keyword">this</span>.setAge(((Integer)is.readObject()).intValue() - <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">"反序列化成功。"</span>);</span><br><span class="line">            System.out.println(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　请注意观察readObject和writeObject方法，它们都是private的，接受的参数是ObjectStream，然后在方法体内调用了defaultReadObject或者defaultWriteObject方法。</p>
<p>　　这里age同样是transient的，但是在保存对象的过程中，我们单独对其进行了保存，在读取时，我们将age信息读取出来，并进行了减1处理。</p>
<p>　　下面是测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeTest3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Person3 person = <span class="keyword">new</span> Person3();</span><br><span class="line">    person.setName(<span class="string">"Zhang San"</span>);</span><br><span class="line">    person.setAge(<span class="number">30</span>);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"d:\\temp\\test\\person3.obj"</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(person);</span><br><span class="line">        fos.close();</span><br><span class="line">        os.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeTest3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"d:\\temp\\test\\person3.obj"</span>);</span><br><span class="line">        ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        is.readObject();</span><br><span class="line">        fis.close();</span><br><span class="line">        is.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name:Zhang San; Age:30</span><br><span class="line">序列化成功。</span><br><span class="line">反序列化成功。</span><br><span class="line">Name:Zhang San; Age:29</span><br></pre></td></tr></table></figure>
<p>　　可以看到，经过反序列化得到的对象，其age属性已经减1。</p>
<h3 id="探讨serialVersionUID"><a href="#探讨serialVersionUID" class="headerlink" title="探讨serialVersionUID"></a>探讨serialVersionUID</h3><p>　　在上文中，我们描述序列化原理时，曾经提及每个对象都会有一个唯一的序列号，这个序列号，就是serialVersionUID。</p>
<p>　　当我们的对象实现Serializable接口时，该接口可以为我们生成serialVersionUID。</p>
<p>　　有两种方式来生成serialVersionUID，一种是固定值：1L，一种是经过JVM计算，不同的JVM采取的计算算法可能不同。</p>
<p>　　下面就是两个serialVersionUID的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private static final long serialVersionUID = 1L;</span><br><span class="line">private static final long serialVersionUID = -2380764581294638541L;</span><br></pre></td></tr></table></figure>
<p>　　第一行是采用固定值生成的；第二行是JVM经过计算得出的。</p>
<p>　　那么serialVersionUID还有其他用途吗？</p>
<p>　　我们可以使用它来控制版本兼容。如果采用JVM生成的方式，我们可以看到，当我们业务对象的代码保持不变时，多次生成的serialVersionUID也是不变的，当我们对属性进行修改时，重新生成的serialVersionUID会发生变化，当我们对方法进行修改时，serialVersionUID不变。这也从另一个侧面说明，序列化是作用于对象属性上的。</p>
<p>　　当我们先定义了业务对象，然后对其示例进行了“序列化”，这时根据业务需求，我们修改了业务对象，那么之前“序列化”后的内容还能经过“反序列化”返回到系统中吗？这取决于业务对象是否定义了serialVersionUID，如果定义了，那么是可以返回的，如果没有定义，会抛出异常。</p>
<p>　　来看下面的示例，定义新的类型Person4：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person4</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">xxx</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后运行下面的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeTest4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Person4 person = <span class="keyword">new</span> Person4();</span><br><span class="line">    person.setName(<span class="string">"Zhang San"</span>);</span><br><span class="line">    person.setAge(<span class="number">30</span>);</span><br><span class="line">    </span><br><span class="line">    writeObject(person, <span class="string">"d:\\temp\\test\\person4.obj"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来修改Person4，追加address属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person4</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">xxx</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddress</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　然后运行“反序列化”方法：<br>　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeTest4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Person4 temp = (Person4)readObject(<span class="string">"d:\\temp\\test\\person4.obj"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (temp != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.io.InvalidClassException: sample.serialization.Person4; local class incompatible: stream classdesc serialVersionUID = -2380764581294638541, local class serialVersionUID = -473458100724786987</span><br><span class="line">    at java.io.ObjectStreamClass.initNonProxy(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readNonProxyDesc(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readClassDesc(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readOrdinaryObject(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readObject0(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readObject(Unknown Source)</span><br><span class="line">    at sample.serialization.Sample.readObject(Sample.java:158)</span><br><span class="line">    at sample.serialization.Sample.deserializeTest4(Sample.java:105)</span><br><span class="line">    at sample.serialization.Sample.main(Sample.java:16)</span><br></pre></td></tr></table></figure>
<p>但是当我们在Person4中添加serialVersionUID后，再次执行上述各步骤，得出的运行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">反序列化成功。</span><br><span class="line">Name:Zhang San; Age:30</span><br></pre></td></tr></table></figure>
<h3 id="有继承结构的序列化"><a href="#有继承结构的序列化" class="headerlink" title="有继承结构的序列化"></a>有继承结构的序列化</h3><p>　　业务对象会产生继承，这在管理系统中是经常看到的，如果我们有下面的业务对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person5</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + name + <span class="string">"; Age:"</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person5</span><span class="params">(String name, <span class="keyword">int</span> age)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">extends</span> <span class="title">Person5</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompanyName</span><span class="params">(String companyName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.companyName = companyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCompanyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> companyName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Name:"</span> + <span class="keyword">super</span>.getName() + <span class="string">"; Age:"</span> + <span class="keyword">super</span>.getAge() + <span class="string">"; Company:"</span> + <span class="keyword">this</span>.companyName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Employee继承在Person5，Employee实现了Serializable接口，Person5没有实现，那么运行下面的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeTest5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Employee emp = <span class="keyword">new</span> Employee(<span class="string">"Zhang San"</span>, <span class="number">30</span>);</span><br><span class="line">    emp.setCompanyName(<span class="string">"XXX"</span>);</span><br><span class="line">    </span><br><span class="line">    writeObject(emp, <span class="string">"d:\\temp\\test\\employee.obj"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeTest5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Employee temp = (Employee)readObject(<span class="string">"d:\\temp\\test\\employee.obj"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (temp != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会正常运行吗？事实上不会，它会抛出如下异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.io.InvalidClassException: sample.serialization.Employee; no valid constructor</span><br><span class="line">    at java.io.ObjectStreamClass$ExceptionInfo.newInvalidClassException(Unknown Source)</span><br><span class="line">    at java.io.ObjectStreamClass.checkDeserialize(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readOrdinaryObject(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readObject0(Unknown Source)</span><br><span class="line">    at java.io.ObjectInputStream.readObject(Unknown Source)</span><br><span class="line">    at sample.serialization.Sample.readObject(Sample.java:158)</span><br><span class="line">    at sample.serialization.Sample.deserializeTest5(Sample.java:123)</span><br><span class="line">    at sample.serialization.Sample.main(Sample.java:18)</span><br></pre></td></tr></table></figure>
<p>原因：<strong>在有继承层次的业务对象，进行序列化时，如果父类没有实现Serializable接口，那么父类必须提供默认构造函数。</strong></p>
<p>　　我们为Person5添加如下默认构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Person5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"Test"</span>;</span><br><span class="line">     <span class="keyword">this</span>.age = <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>　　再次运行上述代码，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name:Zhang San; Age:30; Company:XXX</span><br><span class="line">序列化成功。</span><br><span class="line">反序列化成功。</span><br><span class="line">Name:Test; Age:1; Company:XXX</span><br></pre></td></tr></table></figure>
<p>　　可以看到，反序列化后的结果，父类中的属性，已经被父类构造函数中的赋值代替了！</p>
<p>　　因此，我们推荐在有继承层次的业务对象进行序列化时，父类也应该实现Serializable接口。我们对Person5进行修改，使其实现Serializable接口，执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Name:Zhang San; Age:30; Company:XXX</span><br><span class="line">序列化成功。</span><br><span class="line">反序列化成功。</span><br><span class="line">Name:Zhang San; Age:30; Company:XXX</span><br></pre></td></tr></table></figure>
<p>这正是我们期望的结果。</p>
<h1 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h1><p>关注反射及其相关话题。</p>
<p>　　反射可以帮助我们查看指定类型中的信息、创建类型的实例，调用类型的方法。我们平时使用框架，例如Spring、EJB、Hibernate等都大量的使用了反射技术。</p>
<h2 id="反射简单示例"><a href="#反射简单示例" class="headerlink" title="反射简单示例"></a>反射简单示例</h2><p>　　下面来演示反射相关的基本操作</p>
<p>　　首先是基础代码，我们定义一个接口及其实现，作为我们反射操作的目标：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HelloWorldService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> <span class="keyword">implements</span> <span class="title">HelloWorldService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello "</span> + name + <span class="string">"."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取方法及字段信息"><a href="#获取方法及字段信息" class="headerlink" title="获取方法及字段信息　　"></a>获取方法及字段信息　　</h3><p>　　下面的代码会输出给定类型中的方法和字段的声明信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printClassTypeInfo</span><span class="params">(String type)</span> <span class="keyword">throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class classType = Class.forName(type);</span><br><span class="line">    Method[] methods = classType.getDeclaredMethods();</span><br><span class="line">    System.out.println(<span class="string">"Methods info as below:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(Method method : methods)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(method.toGenericString());</span><br><span class="line">    &#125;</span><br><span class="line">    Field[] fields = classType.getFields();</span><br><span class="line">    System.out.println(<span class="string">"Fields info as below:"</span>);</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(field.toGenericString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在使用反射时，我们一般会使用java.lang.reflect包中的内容。</p>
<p>　　然后我们调用下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printClassTypeInfo(&quot;sample.reflection.MyHelloWorld&quot;);</span><br></pre></td></tr></table></figure>
<p>　　输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Methods info as below:</span><br><span class="line">public void sample.reflection.MyHelloWorld.sayHello(java.lang.String)</span><br><span class="line">public java.lang.String sample.reflection.MyHelloWorld.getName()</span><br><span class="line">public void sample.reflection.MyHelloWorld.setName(java.lang.String)</span><br><span class="line">Fields info as below:</span><br><span class="line">public java.lang.String sample.reflection.MyHelloWorld.name</span><br></pre></td></tr></table></figure>
<h3 id="实例化对象"><a href="#实例化对象" class="headerlink" title="实例化对象"></a>实例化对象</h3><p>　　我们可以使用class.netInstance的方式来创建一个对象，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createInstanceTest</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class classType = Class.forName(<span class="string">"sample.reflection.MyHelloWorld"</span>);</span><br><span class="line">    MyHelloWorld hello = (MyHelloWorld)classType.newInstance();</span><br><span class="line">    hello.sayHello(<span class="string">"Zhang San"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Zhang San.</span><br></pre></td></tr></table></figure>
<h3 id="调用对象的方法"><a href="#调用对象的方法" class="headerlink" title="调用对象的方法"></a>调用对象的方法</h3><p>　　我们可以通过方法的名称以及参数类型构建一个Method实例，然后调用Method的invoke方法，来触发方法。</p>
<p>　　示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeMethodTest</span><span class="params">()</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException, NoSuchMethodException, SecurityException, IllegalArgumentException, InvocationTargetException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class classType = Class.forName(<span class="string">"sample.reflection.MyHelloWorld"</span>);</span><br><span class="line">    MyHelloWorld hello = (MyHelloWorld)classType.newInstance();</span><br><span class="line">    Method method = classType.getMethod(<span class="string">"sayHello"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;);</span><br><span class="line">    method.invoke(hello, <span class="keyword">new</span> Object[]&#123;<span class="string">"Zhang San"</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果同上。</p>
<h3 id="修改字段的值"><a href="#修改字段的值" class="headerlink" title="修改字段的值"></a>修改字段的值</h3><p>　　和C#不同，Java中一般使用setxxx和getxxx显示为属性赋值，因此Java中并没有Property类型，而是有Field类型。</p>
<p>　　我们可以对Field的值进行修改，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldTest</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, SecurityException, InstantiationException, IllegalAccessException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class classType = Class.forName(<span class="string">"sample.reflection.MyHelloWorld"</span>);</span><br><span class="line">    MyHelloWorld hello = (MyHelloWorld)classType.newInstance();</span><br><span class="line">    System.out.println(<span class="string">"name is "</span> + hello.name);</span><br><span class="line">    Field field = classType.getField(<span class="string">"name"</span>);</span><br><span class="line">    field.set(hello, <span class="string">"Zhang San"</span>);</span><br><span class="line">    System.out.println(<span class="string">"name is "</span> + hello.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name is null</span><br><span class="line">name is Zhang San</span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们成功的修改了name的值。</p>
<h2 id="Annotation探索"><a href="#Annotation探索" class="headerlink" title="Annotation探索"></a>Annotation探索</h2><p>　　一开始我们提到，反射是很多技术的基础，Annotation就是这样的，我们可以把Annotation看做是C#中的Attribute，它可以对类型、方法、属性、字段、方法参数等信息进行修饰。我们可以使用“@+Annotation名”的方式来使用Annotation。</p>
<h3 id="Annotation基本操作"><a href="#Annotation基本操作" class="headerlink" title="Annotation基本操作"></a>Annotation基本操作</h3><p>　　来看下面的代码，我们定义了基于Type、Method、Parameter和Field上面的Annotation示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@interface</span> ClassAnnotation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@interface</span> MethodAnnotation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">methodName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">returnType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.PARAMETER)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@interface</span> ParameterAnnotation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@interface</span> FieldAnnotation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着，我们定义了一个MyClass类型，使用了上述的Annotation：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ClassAnnotation</span>(<span class="string">"这是作用在类型上的Annotation"</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@MethodAnnotation</span>(methodName=<span class="string">"printInfo"</span>, returnType=<span class="string">"void"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">(String info)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(info);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MethodAnnotation</span>(methodName=<span class="string">"printError"</span>, returnType=<span class="string">"void"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printError</span><span class="params">(@ParameterAnnotation(<span class="string">"这是作用在参数上的Annotation"</span>)</span>String error)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.err.println(error);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@FieldAnnotation</span>(<span class="string">"这是作用在字段上的Annotation"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于使用了Annotation，我们可以获取其中的信息，下面两种方式都可以获取Annotation，第一种方式是通过反射遍历类型及其方法、字段，一一读取Annotation信息；第二种方式是读取指定类型的Annotation：</p>
<p>读取Annotation方式一<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">annotationTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyClass temp = <span class="keyword">new</span> MyClass();</span><br><span class="line">    </span><br><span class="line">    Annotation[] annotations = temp.getClass().getAnnotations();</span><br><span class="line">    <span class="keyword">for</span>(Annotation a : annotations)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(a.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Method[] methods = temp.getClass().getDeclaredMethods();</span><br><span class="line">    <span class="keyword">for</span>(Method method : methods)</span><br><span class="line">    &#123;</span><br><span class="line">        annotations = method.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span>(Annotation a : annotations)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(a.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Annotation[][] paraAnnotations = method.getParameterAnnotations();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paraAnnotations.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (Annotation a : paraAnnotations[i])</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(a.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Field[] fields = temp.getClass().getFields();</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields)</span><br><span class="line">    &#123;</span><br><span class="line">        annotations = field.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span>(Annotation a : annotations)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(a.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>读取Annotation方式二<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">annotationTest2</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class classType = Class.forName(<span class="string">"sample.reflection.annotation.MyClass"</span>);</span><br><span class="line">    <span class="keyword">boolean</span> flag = classType.isAnnotationPresent(ClassAnnotation.class);</span><br><span class="line">    <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">        ClassAnnotation annotation = (ClassAnnotation) classType.getAnnotation(ClassAnnotation.class);</span><br><span class="line">        System.out.println(annotation.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    Method[] methods = classType.getMethods();</span><br><span class="line">    <span class="keyword">for</span>(Method method : methods)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.isAnnotationPresent(MethodAnnotation.class))</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(((MethodAnnotation)method.getAnnotation(MethodAnnotation.class)).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Annotation[][] paraAnnotations = method.getParameterAnnotations();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paraAnnotations.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (Annotation a : paraAnnotations[i])</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(a.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Field[] fields = classType.getFields();</span><br><span class="line">    <span class="keyword">for</span> (Field field:fields)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (field.isAnnotationPresent(FieldAnnotation.class))</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(((FieldAnnotation)field.getAnnotation(FieldAnnotation.class)).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述两个方法的输出都是一样的，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@sample.reflection.annotation.ClassAnnotation(value=这是作用在类型上的Annotation)</span><br><span class="line">@sample.reflection.annotation.MethodAnnotation(methodName=printInfo, returnType=void)</span><br><span class="line">@sample.reflection.annotation.MethodAnnotation(methodName=printError, returnType=void)</span><br><span class="line">@sample.reflection.annotation.ParameterAnnotation(value=这是作用在参数上的Annotation)</span><br><span class="line">@sample.reflection.annotation.FieldAnnotation(value=这是作用在字段上的Annotation)</span><br></pre></td></tr></table></figure>
<h3 id="在WebService中使用Annotation"><a href="#在WebService中使用Annotation" class="headerlink" title="在WebService中使用Annotation"></a>在WebService中使用Annotation</h3><p>　　上述代码看上去可能有些枯燥，不能显示出Annotation的威力，那么我们接下来看WebService，在WebService中，我们可以使用WebMethod、WebParam等Annotation来声明方法或者参数。</p>
<p>　　接下来，我们来实现一个非常简单的Web服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebService</span>(targetNamespace=<span class="string">"http://test"</span>, serviceName=<span class="string">"HelloService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@WebResult</span>(name=<span class="string">"HelloString"</span>)</span><br><span class="line">    <span class="meta">@WebMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(@WebParam(name=<span class="string">"userName"</span>)</span> String name)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Oneway</span></span><br><span class="line">    <span class="meta">@WebMethod</span>(action=<span class="string">"userLogin"</span>, operationName=<span class="string">"userLogin"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"User has logged on."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> HelloServicePublisher());</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后定义一个Publisher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloServicePublisher</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Endpoint.publish(<span class="string">"http://localhost:8888/test/HelloService"</span>, <span class="keyword">new</span> HelloServiceProvider());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在命令行中，我们定位到源代码路径，执行下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsgen -cp . HelloServiceProvider</span><br></pre></td></tr></table></figure>
<p>　　wsgen位于JDK的bin目录中。</p>
<p>　　然后我们启动HelloServiceProvider，在浏览器中输入如下地址：<a href="http://localhost:8888/test/HelloService，可以看到如下信息：" target="_blank" rel="noopener">http://localhost:8888/test/HelloService，可以看到如下信息：</a></p>
<p>点击WSDL链接，可以看到：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Published by JAX-WS RI at http://jax-ws.dev.java.net. RI's version is JAX-WS RI 2.2.4-b01. --&gt;</span><span class="comment">&lt;!-- Generated by JAX-WS RI at http://jax-ws.dev.java.net. RI's version is JAX-WS RI 2.2.4-b01. --&gt;</span><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">targetNamespace</span>=<span class="string">"http://test"</span> <span class="attr">name</span>=<span class="string">"HelloService"</span>&gt;</span><span class="tag">&lt;<span class="name">types</span>&gt;</span><span class="tag">&lt;<span class="name">xsd:schema</span>&gt;</span><span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://test"</span> <span class="attr">schemaLocation</span>=<span class="string">"http://localhost:8888/test/HelloService?xsd=1"</span>/&gt;</span><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span><span class="tag">&lt;/<span class="name">types</span>&gt;</span><span class="tag">&lt;<span class="name">message</span> <span class="attr">name</span>=<span class="string">"sayHello"</span>&gt;</span><span class="tag">&lt;<span class="name">part</span> <span class="attr">name</span>=<span class="string">"parameters"</span> <span class="attr">element</span>=<span class="string">"tns:sayHello"</span>/&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span><span class="tag">&lt;<span class="name">message</span> <span class="attr">name</span>=<span class="string">"sayHelloResponse"</span>&gt;</span><span class="tag">&lt;<span class="name">part</span> <span class="attr">name</span>=<span class="string">"parameters"</span> <span class="attr">element</span>=<span class="string">"tns:sayHelloResponse"</span>/&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span><span class="tag">&lt;<span class="name">message</span> <span class="attr">name</span>=<span class="string">"userLogin"</span>&gt;</span><span class="tag">&lt;<span class="name">part</span> <span class="attr">name</span>=<span class="string">"parameters"</span> <span class="attr">element</span>=<span class="string">"tns:userLogin"</span>/&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span><span class="tag">&lt;<span class="name">portType</span> <span class="attr">name</span>=<span class="string">"HelloServiceProvider"</span>&gt;</span><span class="tag">&lt;<span class="name">operation</span> <span class="attr">name</span>=<span class="string">"sayHello"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">wsam:Action</span>=<span class="string">"http://test/HelloServiceProvider/sayHelloRequest"</span> <span class="attr">message</span>=<span class="string">"tns:sayHello"</span>/&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">wsam:Action</span>=<span class="string">"http://test/HelloServiceProvider/sayHelloResponse"</span> <span class="attr">message</span>=<span class="string">"tns:sayHelloResponse"</span>/&gt;</span><span class="tag">&lt;/<span class="name">operation</span>&gt;</span><span class="tag">&lt;<span class="name">operation</span> <span class="attr">name</span>=<span class="string">"userLogin"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">wsam:Action</span>=<span class="string">"userLogin"</span> <span class="attr">message</span>=<span class="string">"tns:userLogin"</span>/&gt;</span><span class="tag">&lt;/<span class="name">operation</span>&gt;</span><span class="tag">&lt;/<span class="name">portType</span>&gt;</span><span class="tag">&lt;<span class="name">binding</span> <span class="attr">name</span>=<span class="string">"HelloServiceProviderPortBinding"</span> <span class="attr">type</span>=<span class="string">"tns:HelloServiceProvider"</span>&gt;</span><span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span> <span class="attr">style</span>=<span class="string">"document"</span>/&gt;</span><span class="tag">&lt;<span class="name">operation</span> <span class="attr">name</span>=<span class="string">"sayHello"</span>&gt;</span><span class="tag">&lt;<span class="name">soap:operation</span> <span class="attr">soapAction</span>=<span class="string">""</span>/&gt;</span><span class="tag">&lt;<span class="name">input</span>&gt;</span><span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span><span class="tag">&lt;<span class="name">output</span>&gt;</span><span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span><span class="tag">&lt;/<span class="name">output</span>&gt;</span><span class="tag">&lt;/<span class="name">operation</span>&gt;</span><span class="tag">&lt;<span class="name">operation</span> <span class="attr">name</span>=<span class="string">"userLogin"</span>&gt;</span><span class="tag">&lt;<span class="name">soap:operation</span> <span class="attr">soapAction</span>=<span class="string">"userLogin"</span>/&gt;</span><span class="tag">&lt;<span class="name">input</span>&gt;</span><span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span><span class="tag">&lt;/<span class="name">operation</span>&gt;</span><span class="tag">&lt;/<span class="name">binding</span>&gt;</span><span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"HelloService"</span>&gt;</span><span class="tag">&lt;<span class="name">port</span> <span class="attr">name</span>=<span class="string">"HelloServiceProviderPort"</span> <span class="attr">binding</span>=<span class="string">"tns:HelloServiceProviderPortBinding"</span>&gt;</span><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://localhost:8888/test/HelloService"</span>/&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">service</span>&gt;</span><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>JDK中自带了Web服务器，我们不需要把上述代码部署到其他服务器中。</p>
<h3 id="动态代理机制"><a href="#动态代理机制" class="headerlink" title="动态代理机制"></a>动态代理机制</h3><p>　　Spring中一大特色是AOP，面向方面编程也是框架设计一个趋势。对于业务中的共通操作，诸如记录日志、维护事务等，如果和业务逻辑纠缠在一起，会造成代码职责不清，后续维护困难等问题。利用AOP，我们可以很好的分离共通操作和业务操作。</p>
<p>　　下面我们来实现一个简单的AOP框架，要实现这样一个框架，需要3部分：
　　</p>
<ol>
<li>InvocationHandler，来触发方法；</li>
<li>Interceptor，来定义拦截器；</li>
<li>DynamicProxy，来动态创建代理对象。</li>
</ol>
<p>　　首先我们看Interptor的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AOPInterceptor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterFinally</span><span class="params">(Method method, Object[] args)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是InvocationHandler：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> AOPInterceptor interceptor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicProxyInvocationHandler</span><span class="params">(Object target, AOPInterceptor interceptor)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.interceptor = interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            interceptor.before(method, args);</span><br><span class="line">            Object returnValue = method.invoke(target, args);</span><br><span class="line">            interceptor.after(method, args);</span><br><span class="line">            <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Throwable t)</span><br><span class="line">        &#123;</span><br><span class="line">            interceptor.afterThrowing(method, args);</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            interceptor.afterFinally(method, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是DynamicProxy：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyFactoryImpl</span> <span class="keyword">implements</span> <span class="title">DynamicProxyFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span><span class="params">(Class&lt;T&gt; clazz, T target, AOPInterceptor interceptor)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> DynamicProxyInvocationHandler(target, interceptor);</span><br><span class="line">        <span class="keyword">return</span> (T)Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;clazz&#125;, handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，我们构建了一个”简易“的AOP拦截器。下面我们来创建一些测试代码。</p>
<p>　　首先是实现AOPInterceptor接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">AOPInterceptor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法执行结束。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterFinally</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法体Finally执行结束。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法抛出异常。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法开始执行"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　然后利用本文一开始定义的HelloWorldService，来完成测试，需要在MyHello的sayHello方法最后，追加一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throw new RuntimeException();</span><br></pre></td></tr></table></figure>
<p>接着是测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyInterceptor interceptor = <span class="keyword">new</span> MyInterceptor();</span><br><span class="line">    HelloWorldService hello = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">    DynamicProxyFactory factory = <span class="keyword">new</span> DynamicProxyFactoryImpl();</span><br><span class="line">    HelloWorldService proxy = factory.createProxy(HelloWorldService.class, hello, interceptor);</span><br><span class="line">    proxy.sayHello(<span class="string">"Zhang San"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终，执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">方法开始执行</span><br><span class="line">Hello Zhang San.</span><br><span class="line">方法抛出异常。</span><br><span class="line">方法体Finally执行结束。</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.reflect.UndeclaredThrowableException</span><br><span class="line">    at sample.reflection.dynamicproxy.$Proxy0.sayHello(Unknown Source)</span><br><span class="line">    at sample.reflection.dynamicproxy.Sample.test(Sample.java:18)</span><br><span class="line">    at sample.reflection.dynamicproxy.Sample.main(Sample.java:9)</span><br><span class="line">Caused by: java.lang.reflect.InvocationTargetException</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">    at java.lang.reflect.Method.invoke(Unknown Source)</span><br><span class="line">    at sample.reflection.dynamicproxy.DynamicProxyInvocationHandler.invoke(Sample.java:60)</span><br><span class="line">    ... 3 more</span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们已经在业务执行的前、后、异常抛出后以及finally执行后进行了拦截，达到了我们期望的效果。</p>
<h1 id="Java一些基础概念"><a href="#Java一些基础概念" class="headerlink" title="Java一些基础概念"></a>Java一些基础概念</h1><p>地址下载：<a href="http://zangweiren.iteye.com/blog/241218" target="_blank" rel="noopener">http://zangweiren.iteye.com/blog/241218</a></p>
<p>在看上述文章的时候，随手写了一些测试代码，以便加深理解。这也就是这篇文章的来源了。</p>
<h2 id="类的初始化顺序"><a href="#类的初始化顺序" class="headerlink" title="类的初始化顺序"></a>类的初始化顺序</h2><p>　　在Java中，类里面可能包含：静态变量，静态初始化块，成员变量，初始化块，构造函数。在类之间可能存在着继承关系，那么当我们实例化一个对象时，上述各部分的加载顺序是怎样的？</p>
<p>　　首先来看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticVarible staticVarible= <span class="keyword">new</span> StaticVarible(<span class="string">"父类-静态变量1"</span>);    </span><br><span class="line">    <span class="keyword">public</span> StaticVarible instVarible= <span class="keyword">new</span> StaticVarible(<span class="string">"父类-成员变量1"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"父类-静态块"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"父类-初始化块"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticVarible staticVarible2= <span class="keyword">new</span> StaticVarible(<span class="string">"父类-静态变量2"</span>);    </span><br><span class="line">    <span class="keyword">public</span> StaticVarible instVarible2= <span class="keyword">new</span> StaticVarible(<span class="string">"父类-成员变量2"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Parent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"父类-实例构造函数"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticVarible staticVarible= <span class="keyword">new</span> StaticVarible(<span class="string">"子类-静态变量1"</span>);    </span><br><span class="line">    <span class="keyword">public</span> StaticVarible instVarible= <span class="keyword">new</span> StaticVarible(<span class="string">"子类-成员变量1"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"子类-静态块"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Child</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"子类-实例构造函数"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"子类-初始化块"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticVarible staticVarible2= <span class="keyword">new</span> StaticVarible(<span class="string">"子类-静态变量2"</span>);    </span><br><span class="line">    <span class="keyword">public</span> StaticVarible instVarible2= <span class="keyword">new</span> StaticVarible(<span class="string">"子类-成员变量2"</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticVarible</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticVarible</span><span class="params">(String info)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　然后执行下面的语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Child child = new Child();</span><br></pre></td></tr></table></figure>
<p>　　输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">父类-静态变量1</span><br><span class="line">父类-静态块</span><br><span class="line">父类-静态变量2</span><br><span class="line">子类-静态变量1</span><br><span class="line">子类-静态块</span><br><span class="line">子类-静态变量2</span><br><span class="line">父类-成员变量1</span><br><span class="line">父类-初始化块</span><br><span class="line">父类-成员变量2</span><br><span class="line">父类-实例构造函数</span><br><span class="line">子类-成员变量1</span><br><span class="line">子类-初始化块</span><br><span class="line">子类-成员变量2</span><br><span class="line">子类-实例构造函数</span><br></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论　　"></a>结论　　</h3><p>　　从上述结果可以看出，在实例化一个对象时，各部分的加载顺序如下：</p>
<p>　<strong>　父类静态成员/父类静态初始化块 -&gt; 子类静态成员/子类静态初始化块 -&gt; 父类成员变量/父类初始化块 -&gt; 父类构造函数 -&gt; 子类成员变量/子类初始化块 -&gt; 子类构造函数</strong></p>
<h2 id="和String相关的一些事儿"><a href="#和String相关的一些事儿" class="headerlink" title="和String相关的一些事儿"></a>和String相关的一些事儿</h2><p>　　首先，我们聊一聊Java中堆和栈的事儿。</p>
<ul>
<li>栈：存放基本类型，包括char/byte/short/int/long/float/double/boolean</li>
<li>堆：存放引用类型，同时一般会在栈中保留一个指向它的指针，垃圾回收判断一个对象是否可以回收，就是判断栈中是否有指针指向堆中的对象。</li>
</ul>
<p>　　String作为一种特殊的数据类型，它不完全等同于基本类型，也不是全部的引用类型，许多面试题都有它的身影。</p>
<h3 id="String类型变量的存储结构"><a href="#String类型变量的存储结构" class="headerlink" title="String类型变量的存储结构"></a>String类型变量的存储结构</h3><p>　　String的存储结构分为两部分，我们以String a = “abc”;为例，描述String类型的存储方式：</p>
<p>　　1. 在栈中创建一个char数组，值分为是’a’，’b’，’c’。<br>　　2. 在堆中创建一个String对象。</p>
<h3 id="Java中的字符串池"><a href="#Java中的字符串池" class="headerlink" title="Java中的字符串池"></a>Java中的字符串池</h3><p>　　为了节省空间和资源，JVM会维护一个字符串池，或者说会缓存一部分曾经出现过的字符串。</p>
<p>　　例如下面的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String v1 = &quot;ab&quot;;</span><br><span class="line">String v2 = &quot;ab&quot;;</span><br></pre></td></tr></table></figure></p>
<p>　　实际上，v1==v2，因为JVM在v1声明后，已经对“ab”进行了缓存。</p>
<p>　　那么JVM对字符串进行缓存的依据是什么？我们来看下面的代码，非常有意思：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String constValue = <span class="string">"ab"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String staticValue;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        staticValue=<span class="string">"ab"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String v1 = <span class="string">"ab"</span>;</span><br><span class="line">        String v2 = <span class="string">"ab"</span>;</span><br><span class="line">        System.out.println(<span class="string">"v1 == v2 : "</span> + (v1 == v2));</span><br><span class="line">        String v3 = <span class="keyword">new</span> String(<span class="string">"ab"</span>);</span><br><span class="line">        System.out.println(<span class="string">"v1 == v3 : "</span> + (v1 == v3));</span><br><span class="line">        String v4 = <span class="string">"abcd"</span>;</span><br><span class="line">        String v5 = <span class="string">"ab"</span> + <span class="string">"cd"</span>;</span><br><span class="line">        System.out.println(<span class="string">"v4 == v5 : "</span> + (v4 == v5));</span><br><span class="line">        String v6 = v1 + <span class="string">"cd"</span>;</span><br><span class="line">        System.out.println(<span class="string">"v4 == v6 : "</span> + (v4 == v6));</span><br><span class="line">        String v7 = constValue + <span class="string">"cd"</span>;</span><br><span class="line">        System.out.println(<span class="string">"v4 == v7 : "</span> + (v4 == v7));</span><br><span class="line">        String v8 = staticValue + <span class="string">"cd"</span>;</span><br><span class="line">        System.out.println(<span class="string">"v4 == v8 : "</span> + (v4 == v8));</span><br><span class="line">        String v9 = v4.intern();</span><br><span class="line">        System.out.println(<span class="string">"v4 == v9 :"</span> + (v4 == v9));</span><br><span class="line">        String v10 = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>&#125;);</span><br><span class="line">        String v11 = v10.intern();</span><br><span class="line">        System.out.println(<span class="string">"v4 == v11 :"</span> + (v4 == v11));</span><br><span class="line">        System.out.println(<span class="string">"v10 == v11 :"</span> + (v10 == v11));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意它的输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v1 == v2 : true</span><br><span class="line">v1 == v3 : false</span><br><span class="line">v4 == v5 : true</span><br><span class="line">v4 == v6 : false</span><br><span class="line">v4 == v7 : true</span><br><span class="line">v4 == v8 : false</span><br><span class="line">v4 == v9 :true</span><br><span class="line">v4 == v11 :true</span><br><span class="line">v10 == v11 :false</span><br></pre></td></tr></table></figure>
<p>　　我们会发现，并不是所有的判断都返回true，这似乎和我们上面的说法有矛盾了。其实不然，因为</p>
<p>　　结论<br>　　1. JVM只能缓存那些在编译时可以确定的常量，而非运行时常量。</p>
<p>　　　　上述代码中的constValue属于编译时常量，而staticValue则属于运行时常量。</p>
<p>　　2. 通过使用 new方式创建出来的字符串，JVM缓存的方式是不一样的。</p>
<p>　　　　所以上述代码中，v1不等同于v3。</p>
<h4 id="String的这种设计属于享元模式吗？"><a href="#String的这种设计属于享元模式吗？" class="headerlink" title="String的这种设计属于享元模式吗？"></a>String的这种设计属于享元模式吗？</h4><p>　　这个话题比较有意思，大部分讲设计模式的文章，在谈到享元时，一般就会拿String来做例子，但它属于享元模式吗？</p>
<p>　　字符串与享元的关系，大家可以参考下面的文章：<a href="http://www.cnblogs.com/winter-cn/archive/2012/01/21/2328388.html" target="_blank" rel="noopener">http://www.cnblogs.com/winter-cn/archive/2012/01/21/2328388.html</a></p>
<h4 id="字符串的反转输出"><a href="#字符串的反转输出" class="headerlink" title="字符串的反转输出"></a>字符串的反转输出</h4><p>　　这种情况下，一般会将字符串看做是字符数组，然后利用反转数组的方式来反转字符串。</p>
<h3 id="眼花缭乱的方法调用"><a href="#眼花缭乱的方法调用" class="headerlink" title="眼花缭乱的方法调用"></a>眼花缭乱的方法调用</h3><h4 id="有继承关系结构中的方法调用"><a href="#有继承关系结构中的方法调用" class="headerlink" title="有继承关系结构中的方法调用"></a>有继承关系结构中的方法调用</h4><p>　　继承是面向对象设计中的常见方式，它可以有效的实现”代码复用“，同时子类也有重写父类方法的自由，这就对到底是调用父类方法还是子类方法带来了麻烦。</p>
<p>　　来看下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ParentDef v1 = <span class="keyword">new</span> ParentDef();</span><br><span class="line">        ParentDef v2 = <span class="keyword">new</span> ChildDef();</span><br><span class="line">        ChildDef v3 = <span class="keyword">new</span> ChildDef();</span><br><span class="line">        System.out.println(<span class="string">"=====v1====="</span>);</span><br><span class="line">        System.out.println(<span class="string">"staticValue:"</span> + v1.staticValue);</span><br><span class="line">        System.out.println(<span class="string">"value:"</span> + v1.value);</span><br><span class="line">        System.out.println(<span class="string">"=====v2====="</span>);</span><br><span class="line">        System.out.println(<span class="string">"staticValue:"</span> + v2.staticValue);</span><br><span class="line">        System.out.println(<span class="string">"value:"</span> + v2.value);</span><br><span class="line">        System.out.println(<span class="string">"=====v3====="</span>);</span><br><span class="line">        System.out.println(<span class="string">"staticValue:"</span> + v3.staticValue);</span><br><span class="line">        System.out.println(<span class="string">"value:"</span> + v3.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentDef</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String staticValue = <span class="string">"父类静态变量"</span>;</span><br><span class="line">    <span class="keyword">public</span> String value = <span class="string">"父类实例变量"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildDef</span> <span class="keyword">extends</span> <span class="title">ParentDef</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String staticValue = <span class="string">"子类静态变量"</span>;</span><br><span class="line">    <span class="keyword">public</span> String value = <span class="string">"子类实例变量"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　<br>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">=====v1=====</span><br><span class="line">staticValue:父类静态变量</span><br><span class="line">value:父类实例变量</span><br><span class="line">=====v2=====</span><br><span class="line">staticValue:父类静态变量</span><br><span class="line">value:父类实例变量</span><br><span class="line">=====v3=====</span><br><span class="line">staticValue:子类静态变量</span><br><span class="line">value:子类实例变量</span><br></pre></td></tr></table></figure>
<p>结论<br><strong>对于调用父类方法还是子类方法，只与变量的声明类型有关系，与实例化的类型没有关系。</strong></p>
<h4 id="到底是值传递还是引用传递"><a href="#到底是值传递还是引用传递" class="headerlink" title="到底是值传递还是引用传递"></a>到底是值传递还是引用传递</h4><p>　　对于这个话题，我的观点是值传递，因为传递的都是存储在栈中的内容，无论是基本类型的值，还是指向堆中对象的指针，都是值而非引用。并且在值传递的过程中，JVM会将值复制一份，然后将复制后的值传递给调用方法。</p>
<p>按照这种方式，我们来看下面的代码：　　</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        value = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(Value value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Value temp = <span class="keyword">new</span> Value();</span><br><span class="line">        temp.value = <span class="number">10</span>;</span><br><span class="line">        value = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        value += <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Value value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        value.value += <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ParamTest test = <span class="keyword">new</span> ParamTest();</span><br><span class="line">        Value value = <span class="keyword">new</span> Value();</span><br><span class="line">        <span class="keyword">int</span> v = <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">"v:"</span> + v);</span><br><span class="line">        System.out.println(<span class="string">"value.value:"</span> + value.value);</span><br><span class="line">        System.out.println(<span class="string">"=====change====="</span>);</span><br><span class="line">        test.change(v);</span><br><span class="line">        test.change(value);</span><br><span class="line">        System.out.println(<span class="string">"v:"</span> + v);</span><br><span class="line">        System.out.println(<span class="string">"value.value:"</span> + value.value);</span><br><span class="line">        value = <span class="keyword">new</span> Value();</span><br><span class="line">        v = <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">"=====add====="</span>);</span><br><span class="line">        test.add(v);</span><br><span class="line">        test.add(value);</span><br><span class="line">        System.out.println(<span class="string">"v:"</span> + v);</span><br><span class="line">        System.out.println(<span class="string">"value.value:"</span> + value.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Value</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v:0</span><br><span class="line">value.value:0</span><br><span class="line">=====change=====</span><br><span class="line">v:0</span><br><span class="line">value.value:0</span><br><span class="line">=====add=====</span><br><span class="line">v:0</span><br><span class="line">value.value:10</span><br></pre></td></tr></table></figure>
<p>　　我们看到，在调用change方法时，即使我们传递进去的是指向对象的指针，但最终对象的属性也没有变，这是因为在change方法体内，我们新建了一个对象，然后将”复制过的指向原对象的指针“指向了“新对象”，并且对新对象的属性进行了调整。但是“复制前的指向原对象的指针”依然是指向“原对象”，并且属性没有任何变化。</p>
<h2 id="final-finally-finalize的区别"><a href="#final-finally-finalize的区别" class="headerlink" title="final/finally/finalize的区别"></a>final/finally/finalize的区别</h2><p>　　final可以修饰类、成员变量、方法以及方法参数。使用final修饰的类是不可以被继承的，使用final修饰的方法是不可以被重写的，使用final修饰的变量，只能被赋值一次。</p>
<p>　　使用final声明变量的赋值时机：</p>
<p>　　1. 定义声明时赋值</p>
<p>　　2. 初始化块或静态初始化块中</p>
<p>　　3. 构造函数</p>
<p>　　来看下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FinalTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String staticValue1 = <span class="string">"静态变量1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String staticValue2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        staticValue2 = <span class="string">"静态变量2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String value1 = <span class="string">"实例变量1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String value2;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String value3;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        value2 = <span class="string">"实例变量2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FinalTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        value3 = <span class="string">"实例变量3"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>finally一般是和try…catch放在一起使用，主要用来释放一些资源。</p>
<p>　　我们来看下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinallyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        finallyTest1();</span><br><span class="line">        finallyTest2();</span><br><span class="line">        finallyTest3();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">finallyTest1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Finally语句被执行"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello World"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Finally语句被执行"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">finallyTest2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line">                System.out.println(i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">"Finally语句被执行"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Test <span class="title">finallyTest3</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Test();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"Finally语句被执行"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException</span><br><span class="line">    at sample.interview.FinallyTest.finallyTest1(FinallyTest.java:16)</span><br><span class="line">    at sample.interview.FinallyTest.main(FinallyTest.java:7)</span><br><span class="line">Finally语句被执行</span><br><span class="line">Hello World</span><br><span class="line">Finally语句被执行</span><br><span class="line">0</span><br><span class="line">Finally语句被执行</span><br><span class="line">1</span><br><span class="line">Finally语句被执行</span><br><span class="line">Finally语句被执行</span><br><span class="line">Test实例被创建</span><br><span class="line">Finally语句被执行</span><br></pre></td></tr></table></figure>
<p>　　注意在循环的过程中，对于某一次循环，即使调用了break或者continue，finally也会执行。</p>
<p>　　finalize则主要用于释放资源，在调用GC方法时，该方法就会被调用。</p>
<p>　　来看下面的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FinalizeTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"finalize方法被调用"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        FinalizeTest test = <span class="keyword">new</span> FinalizeTest();</span><br><span class="line">        test = <span class="keyword">null</span>;</span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finalize方法被调用</span><br></pre></td></tr></table></figure>
<h2 id="关于基本类型的一些事儿"><a href="#关于基本类型的一些事儿" class="headerlink" title="关于基本类型的一些事儿"></a>关于基本类型的一些事儿</h2><p>　　基本类型供分为9种，包括byte/short/int/long/float/double/boolean/void，每种基本类型都对应一个“包装类”，其他一些基本信息如下：</p>
<ol>
<li>基本类型：byte 二进制位数：8</li>
<li>包装类：java.lang.Byte</li>
<li>最小值：Byte.MIN_VALUE=-128</li>
<li>最大值：Byte.MAX_VALUE=127</li>
<li>基本类型：short 二进制位数：16</li>
<li>包装类：java.lang.Short</li>
<li>最小值：Short.MIN_VALUE=-32768</li>
<li>最大值：Short.MAX_VALUE=32767</li>
<li>基本类型：int 二进制位数：32</li>
<li>包装类：java.lang.Integer</li>
<li>最小值：Integer.MIN_VALUE=-2147483648</li>
<li>最大值：Integer.MAX_VALUE=2147483647</li>
<li>基本类型：long 二进制位数：64</li>
<li>包装类：java.lang.Long</li>
<li>最小值：Long.MIN_VALUE=-9223372036854775808</li>
<li>最大值：Long.MAX_VALUE=9223372036854775807</li>
<li>基本类型：float 二进制位数：32</li>
<li>包装类：java.lang.Float</li>
<li>最小值：Float.MIN_VALUE=1.4E-45</li>
<li>最大值：Float.MAX_VALUE=3.4028235E38</li>
<li>基本类型：double 二进制位数：64</li>
<li>包装类：java.lang.Double</li>
<li>最小值：Double.MIN_VALUE=4.9E-324</li>
<li>最大值：Double.MAX_VALUE=1.7976931348623157E308</li>
<li>基本类型：char 二进制位数：16</li>
<li>包装类：java.lang.Character</li>
<li>最小值：Character.MIN_VALUE=0</li>
<li>最大值：Character.MAX_VALUE=65535</li>
</ol>
<h3 id="关于基本类型的一些结论（来自《Java面试解惑》）"><a href="#关于基本类型的一些结论（来自《Java面试解惑》）" class="headerlink" title="关于基本类型的一些结论（来自《Java面试解惑》）"></a>关于基本类型的一些结论（来自《Java面试解惑》）</h3><p>未带有字符后缀标识的整数默认为int类型；未带有字符后缀标识的浮点数默认为double类型。<br>如果一个整数的值超出了int类型能够表示的范围，则必须增加后缀“L”（不区分大小写，建议用大写，因为小写的L与阿拉伯数字1很容易混淆），表示为long型。<br>带有“F”（不区分大小写）后缀的整数和浮点数都是float类型的；带有“D”（不区分大小写）后缀的整数和浮点数都是double类型的。<br>编译器会在编译期对byte、short、int、long、float、double、char型变量的值进行检查，如果超出了它们的取值范围就会报错。<br>int型值可以赋给所有数值类型的变量；long型值可以赋给long、float、double类型的变量；float型值可以赋给float、double类型的变量；double型值只能赋给double类型变量。<br>　　关于基本类型之间的转换<br>　　下面的转换是无损精度的转换：</p>
<p>byte-&gt;short<br>short-&gt;int<br>char-&gt;int<br>int-&gt;long<br>float-&gt;double<br>　　下面的转换是会损失精度的：</p>
<p>int-&gt;float<br>long-&gt;float<br>long-&gt;double<br>　　除此之外的转换，是非法的。</p>
<h2 id="和日期相关的一些事儿"><a href="#和日期相关的一些事儿" class="headerlink" title="和日期相关的一些事儿"></a>和日期相关的一些事儿</h2><p>　　Java中，有两个类和日期相关，一个是Date，一个是Calendar。我们来看下面的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ParseException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        test1();</span><br><span class="line">        test2();</span><br><span class="line">        test3();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> ParseException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Date date = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(date);</span><br><span class="line">        DateFormat sf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">        System.out.println(sf.format(date));</span><br><span class="line">        String formatString = <span class="string">"2013-05-12"</span>;</span><br><span class="line">        System.out.println(sf.parse(formatString));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Date date = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"Year:"</span> + date.getYear());</span><br><span class="line">        System.out.println(<span class="string">"Month:"</span> + date.getMonth());</span><br><span class="line">        System.out.println(<span class="string">"Day:"</span> + date.getDate());</span><br><span class="line">        System.out.println(<span class="string">"Hour:"</span> + date.getHours());</span><br><span class="line">        System.out.println(<span class="string">"Minute:"</span> + date.getMinutes());</span><br><span class="line">        System.out.println(<span class="string">"Second:"</span> + date.getSeconds());</span><br><span class="line">        System.out.println(<span class="string">"DayOfWeek:"</span> + date.getDay());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Calendar c = Calendar.getInstance();</span><br><span class="line">        System.out.println(c.getTime());</span><br><span class="line">        System.out.println(c.getTimeZone());</span><br><span class="line">        System.out.println(<span class="string">"Year:"</span> + c.get(Calendar.YEAR));</span><br><span class="line">        System.out.println(<span class="string">"Month:"</span> + c.get(Calendar.MONTH));</span><br><span class="line">        System.out.println(<span class="string">"Day:"</span> + c.get(Calendar.DATE));</span><br><span class="line">        System.out.println(<span class="string">"Hour:"</span> + c.get(Calendar.HOUR));</span><br><span class="line">        System.out.println(<span class="string">"HourOfDay:"</span> + c.get(Calendar.HOUR_OF_DAY));</span><br><span class="line">        System.out.println(<span class="string">"Minute:"</span> + c.get(Calendar.MINUTE));</span><br><span class="line">        System.out.println(<span class="string">"Second:"</span> + c.get(Calendar.SECOND));</span><br><span class="line">        System.out.println(<span class="string">"DayOfWeek:"</span> + c.get(Calendar.DAY_OF_WEEK));</span><br><span class="line">        System.out.println(<span class="string">"DayOfMonth:"</span> + c.get(Calendar.DAY_OF_MONTH));</span><br><span class="line">        System.out.println(<span class="string">"DayOfYear:"</span> + c.get(Calendar.DAY_OF_YEAR));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Sat May 11 13:44:34 CST 2013</span><br><span class="line">2013-05-11</span><br><span class="line">Sun May 12 00:00:00 CST 2013</span><br><span class="line">Year:113</span><br><span class="line">Month:4</span><br><span class="line">Day:11</span><br><span class="line">Hour:13</span><br><span class="line">Minute:44</span><br><span class="line">Second:35</span><br><span class="line">DayOfWeek:6</span><br><span class="line">Sat May 11 13:44:35 CST 2013</span><br><span class="line">sun.util.calendar.ZoneInfo[id=&quot;Asia/Shanghai&quot;,offset=28800000,dstSavings=0,useDaylight=false,transitions=19,lastRule=null]</span><br><span class="line">Year:2013</span><br><span class="line">Month:4</span><br><span class="line">Day:11</span><br><span class="line">Hour:1</span><br><span class="line">HourOfDay:13</span><br><span class="line">Minute:44</span><br><span class="line">Second:35</span><br><span class="line">DayOfWeek:7</span><br><span class="line">DayOfMonth:11</span><br><span class="line">DayOfYear:131</span><br></pre></td></tr></table></figure>
<p>　需要注意的是，Date中的getxxx方法已经变成deprecated了，因此我们尽量使用calendar.get方法来获取日期的细节信息。</p>
<p>　　另外，注意DateFormat，它不仅可以对日期的输出进行格式化，而且可以逆向操作，将符合Format的字符串转换为日期类型。</p>
<h1 id="Java的JDBC"><a href="#Java的JDBC" class="headerlink" title="Java的JDBC"></a>Java的JDBC</h1><p>JDBC相关的话题。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>　　尽管在实际开发过程中，我们一般使用ORM框架来代替传统的JDBC，例如Hibernate或者iBatis，但JDBC是Java用来实现数据访问的基础，掌握它对于我们理解Java的数据操作流程很有帮助。</p>
<p>　　JDBC的全称是Java Database Connectivity。</p>
<p>　　JDBC对数据库进行操作的流程：</p>
<ul>
<li>连接数据库</li>
<li>发送数据请求，即传统的CRUD指令</li>
<li>返回操作结果集</li>
</ul>
<p>　<br>JDBC中常用的对象包括：</p>
<ul>
<li>ConnectionManager</li>
<li>Connection</li>
<li>Statement</li>
<li>CallableStatement</li>
<li>PreparedStatement</li>
<li>ResultSet</li>
<li>SavePoint</li>
</ul>
<h2 id="一个简单JDBC示例"><a href="#一个简单JDBC示例" class="headerlink" title="一个简单JDBC示例"></a>一个简单JDBC示例</h2><p>　　我们来看下面一个简单的示例，它使用JDK自带的Derby数据库，创建一张表，插入一些记录，然后将记录返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String driver = <span class="string">"org.apache.derby.jdbc.EmbeddedDriver"</span>;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:derby:EmbeddedDB;create=true"</span>;</span><br><span class="line">    </span><br><span class="line">    Connection con = <span class="keyword">null</span>;</span><br><span class="line">    Statement st = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        con = DriverManager.getConnection(dbURL);</span><br><span class="line">        st = con.createStatement();</span><br><span class="line">        st.execute(<span class="string">"create table foo(ID INT NOT NULL, NAME VARCHAR(30))"</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into foo(ID,NAME) values(1, 'Zhang San')"</span>);</span><br><span class="line">        </span><br><span class="line">        ResultSet rs = st.executeQuery(<span class="string">"select ID,NAME from foo"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(rs.next())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> id = rs.getInt(<span class="string">"ID"</span>);</span><br><span class="line">            String name = rs.getString(<span class="string">"NAME"</span>);</span><br><span class="line">            System.out.println(<span class="string">"ID="</span> + id + <span class="string">"; NAME="</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (st != <span class="keyword">null</span>) st.close();</span><br><span class="line">        <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何建立数据库连接"><a href="#如何建立数据库连接" class="headerlink" title="如何建立数据库连接"></a>如何建立数据库连接</h2><p>　　上面的示例代码中，建立数据库连接的部分如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String driver = &quot;org.apache.derby.jdbc.EmbeddedDriver&quot;;</span><br><span class="line">String dbURL = &quot;jdbc:derby:EmbeddedDB;create=true&quot;;</span><br><span class="line"></span><br><span class="line">Class.forName(driver);</span><br><span class="line">con = DriverManager.getConnection(dbURL);</span><br></pre></td></tr></table></figure>
<p>建立数据库连接的过程，可以分为两步：</p>
<p>　　1. 加载数据库驱动，即上文中的driver以及Class.forName(dirver)</p>
<p>　　2. 定位数据库连接字符串， 即dbURL以及DriverManager.getConnection(dbURL)</p>
<p>　　不同的数据库，对应的dirver和dbURL不同，但加载驱动和建立连接的方式是相同的，即只需要修改上面driver和dbURL的值就可以了。</p>
<h4 id="自动加载数据库驱动"><a href="#自动加载数据库驱动" class="headerlink" title="自动加载数据库驱动"></a>自动加载数据库驱动</h4><p>　　如果我们每次建立连接时，都要使用Class.forName(…)来手动加载数据库驱动，这样会很麻烦，我们可以通过配置文件的方式，来保存数据库驱动的信息。</p>
<p>　　我们可以在classpath中，即编译出来的.class的存放路径，添加如下文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">META-INF\services\java.sql.Driver</span><br></pre></td></tr></table></figure>
<p>　　对应的内容就是JDBC驱动的全路径，也就是上面driver变量的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.derby.jdbc.EmbeddedDriver</span><br></pre></td></tr></table></figure>
<p>　　接下来，我们在程序中，就不需要再显示的用Class.forName(…)来加载驱动了，它会被自动加载进来，当我们的数据库发生变化时，只需要修改这个文件就可以了，例如当我们的数据库由Derby变为MySQL时，只需要将上述的配置修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>
<p>　　但是，需要注意一点，这里只是配置了JDBC驱动的全路径，并没有包含jar文件的信息，因此，我们还是需要将包含该驱动的jar文件手动的放置到程序的classpath中。</p>
<h2 id="JDBC中的基本操作"><a href="#JDBC中的基本操作" class="headerlink" title="JDBC中的基本操作"></a>JDBC中的基本操作</h2><p>　　对于数据库操作来说，CRUD操作应该是最常见的操作了， 即我们常说的增、删、查、改。</p>
<p>　　JDBC是使用Statement和ResultSet来完成这些操作的。</p>
<h3 id="如何实现CRUD"><a href="#如何实现CRUD" class="headerlink" title="如何实现CRUD"></a>如何实现CRUD</h3><p>　　下面是JDBC实现基本的CRUD示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insertTest</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    st.execute(<span class="string">"insert into user(ID,NAME) values(1, 'Zhang San')"</span>);</span><br><span class="line">    st.execute(<span class="string">"insert into user(ID,NAME) values(2, 'Li Si')"</span>);</span><br><span class="line">    st.execute(<span class="string">"insert into user(ID,NAME) values(3, 'Wang Wu')"</span>);</span><br><span class="line">    System.out.println(<span class="string">"=====insert test====="</span>);</span><br><span class="line">    showUser(st);</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteTest</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    st.execute(<span class="string">"delete from user where ID=3"</span>);</span><br><span class="line">    System.out.println(<span class="string">"=====delete test====="</span>);</span><br><span class="line">    showUser(st);</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateTest</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    st.executeUpdate(<span class="string">"update user set NAME='TEST' where ID=2"</span>);</span><br><span class="line">    System.out.println(<span class="string">"=====update test====="</span>);</span><br><span class="line">    showUser(st);</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showUser</span><span class="params">(Statement st)</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select ID, NAME from user"</span>);</span><br><span class="line">    <span class="keyword">while</span>(rs.next())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> id = rs.getInt(<span class="string">"ID"</span>);</span><br><span class="line">        String name = rs.getString(<span class="string">"NAME"</span>);</span><br><span class="line">        System.out.println(<span class="string">"ID:"</span> + id + <span class="string">"; NAME="</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    rs.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　我们顺序调用上面的测试方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insertTest();</span><br><span class="line">deleteTest();</span><br><span class="line">updateTest();</span><br></pre></td></tr></table></figure>
<p>　　执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">=====insert test=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=Li Si</span><br><span class="line">ID:3; NAME=Wang Wu</span><br><span class="line">=====delete test=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=Li Si</span><br><span class="line">=====update test=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br></pre></td></tr></table></figure>
<p>　　上面代码中的showUser方法会把user表中的所有记录打印出来。</p>
<h3 id="如何调用存储过程"><a href="#如何调用存储过程" class="headerlink" title="如何调用存储过程"></a>如何调用存储过程</h3><p>　　存储过程是做数据库开发时经常使用的技术，它可以通过节省编译时间的方式来提升系统性能，我们这里的示例使用MySQL数据库。</p>
<h4 id="如何调用不带参数的存储过程"><a href="#如何调用不带参数的存储过程" class="headerlink" title="如何调用不带参数的存储过程"></a>如何调用不带参数的存储过程</h4><p>　　假设我们现在有一个简单的存储过程，它只是返回user表中的所有记录，存储过程如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`root`</span>@<span class="string">`localhost`</span> <span class="keyword">PROCEDURE</span> <span class="string">`GetUser`</span>()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">ID</span>,<span class="keyword">NAME</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>我们可以使用CallableStatement来调用存储过程：</p>
<p>调用存储过程示例一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execStoredProcedureTest</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    CallableStatement cst = con.prepareCall(<span class="string">"call GetUser()"</span>);</span><br><span class="line">    ResultSet rs = cst.executeQuery();</span><br><span class="line">    <span class="keyword">while</span>(rs.next())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> id = rs.getInt(<span class="string">"ID"</span>);</span><br><span class="line">        String name = rs.getString(<span class="string">"NAME"</span>);</span><br><span class="line">        System.out.println(<span class="string">"ID:"</span> + id + <span class="string">"; NAME="</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    rs.close();</span><br><span class="line">    cst.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br></pre></td></tr></table></figure>
<h4 id="如何调用带参数的存储过程"><a href="#如何调用带参数的存储过程" class="headerlink" title="如何调用带参数的存储过程"></a>如何调用带参数的存储过程</h4><p>　　MySQL的存储过程中的参数分为三种：in/out/inout，我们可以把in看做入力参数，out看做出力参数，JDBC对这两种类型的参数设置方式不同：</p>
<ol>
<li><p>in， JDBC使用类似于cst.set(1, 10)的方式来设置</p>
</li>
<li><p>out，JDBC使用类似于cst.registerOutParameter(2, Types.VARCHAR);的方式来设置</p>
</li>
</ol>
<p>　　我们来看一个in参数的示例，假设我们希望返回ID为特定值的user信息，存储过程如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`root`</span>@<span class="string">`localhost`</span> <span class="keyword">PROCEDURE</span> <span class="string">`GetUserByID`</span>(<span class="keyword">in</span> <span class="keyword">id</span> <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">set</span> @sqlstr=<span class="keyword">concat</span>(<span class="string">'select * from user where ID='</span>, <span class="keyword">id</span>);</span><br><span class="line"><span class="keyword">prepare</span> psmt <span class="keyword">from</span> @sqlstr;</span><br><span class="line"><span class="keyword">execute</span> psmt;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>　　Java的调用代码如下：<br>　　<br>JDBC调用存储过程示例二　<br>　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execStoredProcedureTest2</span><span class="params">(<span class="keyword">int</span> id)</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    CallableStatement cst = con.prepareCall(<span class="string">"call GetUserByID(?)"</span>);</span><br><span class="line">    cst.setInt(<span class="number">1</span>, id);</span><br><span class="line">    ResultSet rs = cst.executeQuery();</span><br><span class="line">    <span class="keyword">while</span>(rs.next())</span><br><span class="line">    &#123;</span><br><span class="line">        String name = rs.getString(<span class="string">"NAME"</span>);</span><br><span class="line">        System.out.println(<span class="string">"ID:"</span> + id + <span class="string">"; NAME="</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    rs.close();</span><br><span class="line">    cst.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　我们执行下面的语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execStoredProcedureTest2(1);</span><br></pre></td></tr></table></figure>
<p>　　结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ID:1; NAME=Zhang San</span><br></pre></td></tr></table></figure>
<p>　　对于out类型的参数，调用方式类似，不再赘述。</p>
<h3 id="获取数据库以及结果集的metadata信息"><a href="#获取数据库以及结果集的metadata信息" class="headerlink" title="获取数据库以及结果集的metadata信息"></a>获取数据库以及结果集的metadata信息</h3><p>　　在JDBC中，我们不仅能够对数据进行操作，我们还能获取数据库以及结果集的元数据信息，例如数据库的名称、驱动信息、表信息；结果集的列信息等。</p>
<h4 id="获取数据库的metadata信息"><a href="#获取数据库的metadata信息" class="headerlink" title="获取数据库的metadata信息"></a>获取数据库的metadata信息</h4><p>　　我们可以通过connection.getMetaData方法来获取数据库的元数据信息，它的类型是DatabaseMetaData。</p>
<p>获取数据库的元数据信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/mysql"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    </span><br><span class="line">    DatabaseMetaData dbmd = con.getMetaData();</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">"数据库："</span> + dbmd.getDatabaseProductName() + <span class="string">" "</span> + dbmd.getDatabaseProductVersion());</span><br><span class="line">    System.out.println(<span class="string">"驱动程序："</span> + dbmd.getDriverName() + <span class="string">" "</span> + dbmd.getDriverVersion());</span><br><span class="line"></span><br><span class="line">    ResultSet rs = dbmd.getTables(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(String.format(<span class="string">"|%-26s|%-9s|%-9s|%-9s|"</span>, <span class="string">"表名称"</span>,<span class="string">"表类别"</span>,<span class="string">"表类型"</span>,<span class="string">"表模式"</span>));        </span><br><span class="line">    <span class="keyword">while</span>(rs.next())</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">"|%-25s|%-10s|%-10s|%-10s|"</span>, </span><br><span class="line">                rs.getString(<span class="string">"TABLE_NAME"</span>),rs.getString(<span class="string">"TABLE_CAT"</span>),</span><br><span class="line">                rs.getString(<span class="string">"TABLE_TYPE"</span>), rs.getString(<span class="string">"TABLE_SCHEM"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们使用的数据库是MySQL中自带的默认数据库：mysql，它会记录整个数据库服务器中的一些信息。上述代码执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">数据库：MySQL 5.5.28</span><br><span class="line">驱动程序：MySQL-AB JDBC Driver mysql-connector-java-5.0.4 ( $Date: 2006-10-19 17:47:48 +0200 (Thu, 19 Oct 2006) $, $Revision: 5908 $ )</span><br><span class="line">|表名称                       |表类别      |表类型      |表模式      |</span><br><span class="line">|columns_priv             |mysql     |TABLE     |null      |</span><br><span class="line">|db                       |mysql     |TABLE     |null      |</span><br><span class="line">|event                    |mysql     |TABLE     |null      |</span><br><span class="line">|func                     |mysql     |TABLE     |null      |</span><br><span class="line">。。。</span><br></pre></td></tr></table></figure>
<p>　　由于mysql中表比较多，上述结果只截取了一部分。</p>
<h4 id="获取结果集的元数据信息"><a href="#获取结果集的元数据信息" class="headerlink" title="获取结果集的元数据信息"></a>获取结果集的元数据信息</h4><p>　　我们可以通过使用resultset.getMetaData方法来获取结果集的元数据信息，它的类型是ResultSetMetaData。</p>
<p>获取结果集的元数据信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select ID, NAME from user"</span>);</span><br><span class="line">    ResultSetMetaData rsmd = rs.getMetaData();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= rsmd.getColumnCount(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"Column Name:"</span> + rsmd.getColumnName(i) + <span class="string">"; Column Type:"</span> + rsmd.getColumnTypeName(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Column Name:ID; Column Type:INTEGER UNSIGNED</span><br><span class="line">Column Name:NAME; Column Type:VARCHAR</span><br></pre></td></tr></table></figure>
<p>　　可以看到，它返回类结果集中每一列的名称和类型。</p>
<h2 id="基于ResultSet的操作"><a href="#基于ResultSet的操作" class="headerlink" title="基于ResultSet的操作"></a>基于ResultSet的操作</h2><p>　　当我们需要对数据库进行修改时，除了上述通过Statement完成操作外，我们也可以借助ResultSet来完成。</p>
<p>　　需要注意的是，在这种情况下，我们定义Statement时，需要添加参数。</p>
<p>　　Statement构造函数可以包含3个参数：</p>
<ol>
<li><p>resultSetType，它的取值包括：ResultSet.TYPE_FORWARD_ONLY、ResultSet.TYPE_SCROLL_INSENSITIVE 或 ResultSet.TYPE_SCROLL_SENSITIVE，默认情况下，该参数的值是ResultSet.TYPE_FORWARD_ONLY。</p>
</li>
<li><p>resultSetConcurrency，它的取值包括：ResultSet.CONCUR_READ_ONLY 或 ResultSet.CONCUR_UPDATABLE，默认情况下，该参数的值是ResultSet.CONCUR_READ_ONLY。</p>
</li>
<li><p>resultSetHoldability，它的取值包括：ResultSet.HOLD_CURSORS_OVER_COMMIT 或 ResultSet.CLOSE_CURSORS_AT_COMMIT。</p>
</li>
</ol>
<p>为了使得ResultSet能够对数据进行操作我们需要：</p>
<ul>
<li>将resultSetType设置为ResultSet.TYPE_SCROLL_SENSITIVE。</li>
<li>将resultSetConcurrency设置为ResultSet.CONCUR_UPDATABLE。</li>
</ul>
<p>在通过ResultSet对数据进行调整的过程中，下面方法可能会被调用：</p>
<ul>
<li>resultset.last()</li>
<li>resultset.first()</li>
<li>resultset.moveToInsertRow()</li>
<li>resultset.absolute()</li>
<li>resultset.setxxx()</li>
<li>resultset.updateRow()</li>
<li>resultset.insertRow()</li>
</ul>
<p>下面是一个通过ResultSet对数据进行增、删、改的示例：</p>
<p>通过ResultSet对数据进行增、删、改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getResultCount</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Result Count====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY, ResultSet.CLOSE_CURSORS_AT_COMMIT);</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select * from user"</span>);</span><br><span class="line">    rs.last();</span><br><span class="line">    System.out.println(<span class="string">"返回结果的条数："</span>+ rs.getRow());</span><br><span class="line">    rs.first();</span><br><span class="line">    </span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insertDataToResultSet</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Insert====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_UPDATABLE);</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select ID,NAME from user"</span>);</span><br><span class="line">    rs.moveToInsertRow();</span><br><span class="line">    rs.updateInt(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">    rs.updateString(<span class="number">2</span>, <span class="string">"Xiao Ming"</span>);</span><br><span class="line">    rs.insertRow();</span><br><span class="line">    showUser(st);</span><br><span class="line">    </span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateDataToResultSet</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Update====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_UPDATABLE);</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select * from user"</span>);</span><br><span class="line">    rs.last();</span><br><span class="line">    <span class="keyword">int</span> count = rs.getRow();</span><br><span class="line">    rs.first();</span><br><span class="line">    rs.absolute(count);</span><br><span class="line">    rs.updateString(<span class="number">2</span>, <span class="string">"Xiao Qiang"</span>);</span><br><span class="line">    rs.updateRow();</span><br><span class="line">    showUser(st);</span><br><span class="line">    </span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delDataFromResultSet</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Delete====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_UPDATABLE, ResultSet.CLOSE_CURSORS_AT_COMMIT);</span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select * from user"</span>);</span><br><span class="line">    rs.last();</span><br><span class="line">    <span class="keyword">int</span> count = rs.getRow();</span><br><span class="line">    rs.first();</span><br><span class="line">    rs.absolute(count);</span><br><span class="line">    rs.deleteRow();</span><br><span class="line">    showUser(st);</span><br><span class="line">    </span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别调用上述方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 getResultCount();</span><br><span class="line">2 insertDataToResultSet();</span><br><span class="line">3 updateDataToResultSet();</span><br><span class="line">4 delDataFromResultSet();</span><br></pre></td></tr></table></figure>
<p>　　执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">=====Result Count=====</span><br><span class="line">返回结果的条数：2</span><br><span class="line">=====Insert=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:4; NAME=Xiao Ming</span><br><span class="line">=====Update=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:4; NAME=Xiao Qiang</span><br><span class="line">=====Delete=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br></pre></td></tr></table></figure>
<p>　　可以看到我们对ID为4的记录进行了插入、更新和删除操作。</p>
<h2 id="预处理以及批处理"><a href="#预处理以及批处理" class="headerlink" title="预处理以及批处理"></a>预处理以及批处理</h2><p>　　预处理和批处理都是用来提升系统性能的方式，一种是利用数据库的缓存机制，一种是利用数据库一次执行多条语句的方式。</p>
<h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><p>　　数据库服务器接收到Statement后，一般会解析Statement、分析是否有语法错误、定制最优的执行计划，这个过程可能会降低系统的性能。一般的数据库服务器都这对这种情况，设计了缓存机制，当数据库接收到指令时，如果缓存中已经存在，那么就不再解析，而是直接运行。</p>
<p>　　这里相同的指令是指sql语句完全一样，包括大小写。</p>
<p>　　JDBC使用PreparedStatement来完成预处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Insert a single record by PreparedStatement====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    PreparedStatement pst = con.prepareStatement(<span class="string">"insert into user(id,name) values(?,?)"</span>);</span><br><span class="line">    pst.setInt(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">    pst.setString(<span class="number">2</span>, <span class="string">"Lei Feng"</span>);</span><br><span class="line">    pst.executeUpdate();</span><br><span class="line">    showUser(pst);</span><br><span class="line">    pst.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">=====Insert a single record by PreparedStatement=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br></pre></td></tr></table></figure>
<h3 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h3><p>　　批处理是利用数据库一次执行多条语句的机制来提升性能，这样可以避免多次建立连接带来的性能损失。</p>
<p>　　批处理使用Statement的addBatch来添加指令，使用executeBatch方法来一次执行多条指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Insert multiple records by Statement &amp; Batch====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    st.addBatch(<span class="string">"insert into user(id,name) values(6,'Xiao Zhang')"</span>);</span><br><span class="line">    st.addBatch(<span class="string">"insert into user(id,name) values(7,'Xiao Liu')"</span>);</span><br><span class="line">    st.addBatch(<span class="string">"insert into user(id,name) values(8,'Xiao Zhao')"</span>);</span><br><span class="line">    st.executeBatch();</span><br><span class="line">    showUser(st);</span><br><span class="line">    st.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=====Insert multiple records by Statement &amp; Batch=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br><span class="line">ID:6; NAME=Xiao Zhang</span><br><span class="line">ID:7; NAME=Xiao Liu</span><br><span class="line">ID:8; NAME=Xiao Zhao</span><br></pre></td></tr></table></figure>
<h3 id="预处理和批处理相结合"><a href="#预处理和批处理相结合" class="headerlink" title="预处理和批处理相结合"></a>预处理和批处理相结合</h3><p>　　我们可以把预处理和批处理结合起来，利用数据库的缓存机制，一次执行多条语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Insert multiple records by PreparedStatement &amp; Batch====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    PreparedStatement pst = con.prepareStatement(<span class="string">"insert into user(id,name) values(?,?)"</span>);</span><br><span class="line">    pst.setInt(<span class="number">1</span>, <span class="number">9</span>);</span><br><span class="line">    pst.setString(<span class="number">2</span>, <span class="string">"Xiao Zhang"</span>);</span><br><span class="line">    pst.addBatch();</span><br><span class="line">    pst.setInt(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    pst.setString(<span class="number">2</span>, <span class="string">"Xiao Liu"</span>);</span><br><span class="line">    pst.addBatch();</span><br><span class="line">    pst.setInt(<span class="number">1</span>, <span class="number">11</span>);</span><br><span class="line">    pst.setString(<span class="number">2</span>, <span class="string">"Xiao Zhao"</span>);</span><br><span class="line">    pst.addBatch();</span><br><span class="line">    pst.executeBatch();</span><br><span class="line">    showUser(pst);</span><br><span class="line">    pst.close();</span><br><span class="line">    con.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　执行结果如下：<br>　<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=====Insert multiple records by PreparedStatement &amp; Batch=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br><span class="line">ID:9; NAME=Xiao Zhang</span><br><span class="line">ID:10; NAME=Xiao Liu</span><br><span class="line">ID:11; NAME=Xiao Zhao</span><br></pre></td></tr></table></figure></p>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><p>　　谈到数据库开发，事务是一个不可回避的话题，JDBC默认情况下，是每一步都自动提交的，我们可以通过设置connection.setAutoCommit(false)的方式来强制关闭自动提交，然后通过connection.commit()和connection.rollback()来实现事务提交和回滚。</p>
<h3 id="简单的数据库事务"><a href="#简单的数据库事务" class="headerlink" title="简单的数据库事务"></a>简单的数据库事务</h3><p>　　下面是一个简单的数据库事务的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">transactionTest1</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Simple Transaction test====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into user(id,name) values(12, 'Xiao Li')"</span>);</span><br><span class="line">        con.commit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        con.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">        showUser(st);</span><br><span class="line">        <span class="keyword">if</span> (st != <span class="keyword">null</span>) st.close();</span><br><span class="line">        <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　连续执行上述方法两次，我们可以得出下面的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">=====Simple Transaction test=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br><span class="line">ID:12; NAME=Xiao Li</span><br><span class="line">=====Simple Transaction test=====</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br><span class="line">ID:12; NAME=Xiao Li</span><br><span class="line">com.mysql.jdbc.exceptions.MySQLIntegrityConstraintViolationException: Duplicate entry &apos;12&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">    at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:931)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:2870)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1573)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:1665)</span><br><span class="line">    at com.mysql.jdbc.Connection.execSQL(Connection.java:3170)</span><br><span class="line">    at com.mysql.jdbc.Statement.executeUpdate(Statement.java:1316)</span><br><span class="line">    at com.mysql.jdbc.Statement.executeUpdate(Statement.java:1235)</span><br><span class="line">    at sample.jdbc.mysql.ResultSetSample.transactionTest1(ResultSetSample.java:154)</span><br><span class="line">    at sample.jdbc.mysql.ResultSetSample.main(ResultSetSample.java:17)</span><br></pre></td></tr></table></figure>
<p>　　可以看到，第一次调用时，操作成功，事务提交，向user表中插入了一条记录；第二次调用时，发生主键冲突异常，事务回滚。</p>
<h3 id="带有SavePoint的事务"><a href="#带有SavePoint的事务" class="headerlink" title="带有SavePoint的事务"></a>带有SavePoint的事务</h3><p>　　当我们的事务操作中包含多个处理，但我们有时希望一些操作完成后可以先提交，这样可以避免整个事务的回滚。JDBC使用SavePoint来实现这一点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">transactionTest2</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"=====Simple Transaction test====="</span>);</span><br><span class="line">    String dbURL = <span class="string">"jdbc:mysql://localhost/test"</span>;</span><br><span class="line">    Connection con = DriverManager.getConnection(dbURL, <span class="string">"root"</span>, <span class="string">"123"</span>);</span><br><span class="line">    Statement st = con.createStatement();</span><br><span class="line">    Savepoint svpt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into user(id,name) values(13, 'Xiao Li')"</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into user(id,name) values(14, 'Xiao Wang')"</span>);</span><br><span class="line">        svpt = con.setSavepoint(<span class="string">"roll back to here"</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into user(id,name) values(15, 'Xiao Zhao')"</span>);</span><br><span class="line">        st.executeUpdate(<span class="string">"insert into user(id,name) values(13, 'Xiao Li')"</span>);</span><br><span class="line">        con.commit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        con.rollback(svpt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">        showUser(st);</span><br><span class="line">        <span class="keyword">if</span> (st != <span class="keyword">null</span>) st.close();</span><br><span class="line">        <span class="keyword">if</span> (con != <span class="keyword">null</span>) con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=====Simple Transaction test=====</span><br><span class="line">com.mysql.jdbc.exceptions.MySQLIntegrityConstraintViolationException: Duplicate entry &apos;13&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">    at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:931)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:2870)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1573)</span><br><span class="line">    at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:1665)</span><br><span class="line">    at com.mysql.jdbc.Connection.execSQL(Connection.java:3170)</span><br><span class="line">    at com.mysql.jdbc.Statement.executeUpdate(Statement.java:1316)</span><br><span class="line">    at com.mysql.jdbc.Statement.executeUpdate(Statement.java:1235)</span><br><span class="line">    at sample.jdbc.mysql.ResultSetSample.transactionTest2(ResultSetSample.java:185)</span><br><span class="line">    at sample.jdbc.mysql.ResultSetSample.main(ResultSetSample.java:18)</span><br><span class="line">ID:1; NAME=Zhang San</span><br><span class="line">ID:2; NAME=TEST</span><br><span class="line">ID:5; NAME=Lei Feng</span><br><span class="line">ID:13; NAME=Xiao Li</span><br><span class="line">ID:14; NAME=Xiao Wang</span><br></pre></td></tr></table></figure>
<p>可以看到最终事务报出了主键冲突异常，事务回滚，但是依然向数据库中插入了ID为13和14的记录。</p>
<p>另外，在确定SavePoint后，ID为15的记录并没有被插入，它是通过事务进行了回滚。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Java" >
    <span class="tag-code">Java</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/blog/38019.html">
        <span class="nav-arrow">← </span>
        
          我36岁了，除了收费啥都不会
        
      </a>
    
    
      <a class="nav-right" href="/blog/37268.html">
        
          hibernate框架技术
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#JavaI-O"><span class="toc-nav-text">JavaI/O</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#InputStream的结构"><span class="toc-nav-text">InputStream的结构</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#OutputStream的结构"><span class="toc-nav-text">OutputStream的结构</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用InputStream读取文件"><span class="toc-nav-text">使用InputStream读取文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用BufferedInputStream读取文件"><span class="toc-nav-text">使用BufferedInputStream读取文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用OutputStream复制文件"><span class="toc-nav-text">使用OutputStream复制文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用BufferedOutputStream复制文件"><span class="toc-nav-text">使用BufferedOutputStream复制文件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Reader的结构"><span class="toc-nav-text">Reader的结构</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Writer的结构"><span class="toc-nav-text">Writer的结构</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用Writer复制文件"><span class="toc-nav-text">使用Writer复制文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#创建一个大小固定的文件"><span class="toc-nav-text">创建一个大小固定的文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#向文件中随机写入数据"><span class="toc-nav-text">向文件中随机写入数据</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#移动文件"><span class="toc-nav-text">移动文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#复制文件"><span class="toc-nav-text">复制文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#复制文件夹"><span class="toc-nav-text">复制文件夹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#删除文件夹"><span class="toc-nav-text">删除文件夹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#获取文件夹大小"><span class="toc-nav-text">获取文件夹大小</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#将大文件切分成多个小文件"><span class="toc-nav-text">将大文件切分成多个小文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#将多个小文件合并成一个大文件"><span class="toc-nav-text">将多个小文件合并成一个大文件</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#执行外部命令"><span class="toc-nav-text">执行外部命令</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java网络通信"><span class="toc-nav-text">Java网络通信</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#TCP连接"><span class="toc-nav-text">TCP连接</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#简单的TCP客户端"><span class="toc-nav-text">简单的TCP客户端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#简单版本TCP服务器端"><span class="toc-nav-text">简单版本TCP服务器端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#多线程版本的TCP服务器端"><span class="toc-nav-text">多线程版本的TCP服务器端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#一个简单的TCP连接池"><span class="toc-nav-text">一个简单的TCP连接池</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#UDP连接"><span class="toc-nav-text">UDP连接</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#UDP通信客户端"><span class="toc-nav-text">UDP通信客户端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#UDP通信服务器端"><span class="toc-nav-text">UDP通信服务器端</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#多播（Multicast）"><span class="toc-nav-text">多播（Multicast）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#多播通信客户端"><span class="toc-nav-text">多播通信客户端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#多播通信服务器端"><span class="toc-nav-text">多播通信服务器端</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#NIO（New-IO）"><span class="toc-nav-text">NIO（New IO）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#NIO例子"><span class="toc-nav-text">NIO例子</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java多线程"><span class="toc-nav-text">Java多线程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程基本信息"><span class="toc-nav-text">线程基本信息</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#查看并修改当前线程的属性"><span class="toc-nav-text">查看并修改当前线程的属性</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#线程优先级示例"><span class="toc-nav-text">线程优先级示例</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#IsDaemon-示例"><span class="toc-nav-text">IsDaemon 示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#如何创建线程"><span class="toc-nav-text">如何创建线程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用内部类来创建线程"><span class="toc-nav-text">使用内部类来创建线程</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#继承Thread以创建线程"><span class="toc-nav-text">继承Thread以创建线程</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#实现Runnable接口以创建线程"><span class="toc-nav-text">实现Runnable接口以创建线程</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#notify示例"><span class="toc-nav-text">notify示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程的状态切换"><span class="toc-nav-text">线程的状态切换</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程等待与唤醒"><span class="toc-nav-text">线程等待与唤醒</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程的休眠与唤醒"><span class="toc-nav-text">线程的休眠与唤醒</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Thread-sleep实例"><span class="toc-nav-text">Thread.sleep实例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程的终止"><span class="toc-nav-text">线程的终止</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Thread-interrupt示例"><span class="toc-nav-text">Thread.interrupt示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程的同步等待"><span class="toc-nav-text">线程的同步等待</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Thread-join示例"><span class="toc-nav-text">Thread.join示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#线程间通信"><span class="toc-nav-text">线程间通信</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#PipeInputStream-PipedOutpueStream-示例"><span class="toc-nav-text">PipeInputStream/PipedOutpueStream 示例</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#PipedReader-PipedWriter-示例"><span class="toc-nav-text">PipedReader/PipedWriter 示例</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java多线程同步"><span class="toc-nav-text">Java多线程同步</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#为什么要线程同步？"><span class="toc-nav-text">为什么要线程同步？</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#共享变量"><span class="toc-nav-text">共享变量</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#共享变量造成同步问题"><span class="toc-nav-text">共享变量造成同步问题</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#执行步骤"><span class="toc-nav-text">执行步骤</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#执行步骤混乱带来的同步问题"><span class="toc-nav-text">执行步骤混乱带来的同步问题</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#如何控制线程同步"><span class="toc-nav-text">如何控制线程同步</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#控制共享变量"><span class="toc-nav-text">控制共享变量</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#将“单对象多线程”修改成“多对象多线程”"><span class="toc-nav-text">将“单对象多线程”修改成“多对象多线程”　　</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#解决共享变量问题方案一"><span class="toc-nav-text">解决共享变量问题方案一</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#将“全局变量”降级为“局部变量”"><span class="toc-nav-text">将“全局变量”降级为“局部变量”</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#解决共享变量问题方案二"><span class="toc-nav-text">解决共享变量问题方案二</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#使用ThreadLocal机制"><span class="toc-nav-text">使用ThreadLocal机制</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#解决共享变量问题方案三"><span class="toc-nav-text">解决共享变量问题方案三</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#控制执行步骤"><span class="toc-nav-text">控制执行步骤</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#执行步骤问题解决方案"><span class="toc-nav-text">执行步骤问题解决方案</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#synchronized示例"><span class="toc-nav-text">synchronized示例</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#构造线程池"><span class="toc-nav-text">构造线程池</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#定义线程对象"><span class="toc-nav-text">定义线程对象</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#定义线程池管理对象"><span class="toc-nav-text">定义线程池管理对象</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#定义服务器端线程池对象"><span class="toc-nav-text">定义服务器端线程池对象</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#探索JDK中的concurrent工具包"><span class="toc-nav-text">探索JDK中的concurrent工具包</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#线程池"><span class="toc-nav-text">线程池　　</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#定义Runnable对象"><span class="toc-nav-text">定义Runnable对象</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ScheduledThreadPool"><span class="toc-nav-text">ScheduledThreadPool</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ScheduledThreadPool示例"><span class="toc-nav-text">ScheduledThreadPool示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#FixedThreadPool"><span class="toc-nav-text">FixedThreadPool</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#FixedThreadPool示例"><span class="toc-nav-text">FixedThreadPool示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CachedThreadPool"><span class="toc-nav-text">CachedThreadPool</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#CachedThreadPool示例"><span class="toc-nav-text">CachedThreadPool示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#处理线程返回值"><span class="toc-nav-text">处理线程返回值</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#返回单个线程的结果"><span class="toc-nav-text">返回单个线程的结果</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Callable示例"><span class="toc-nav-text">Callable示例</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#CompletionService示例"><span class="toc-nav-text">CompletionService示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#实现生产者-消费者模型"><span class="toc-nav-text">实现生产者-消费者模型</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#BlockingQueue示例"><span class="toc-nav-text">BlockingQueue示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#使用信号量来控制线程"><span class="toc-nav-text">使用信号量来控制线程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#SemaPhore示例"><span class="toc-nav-text">SemaPhore示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#控制线程池中所有线程的执行步骤"><span class="toc-nav-text">控制线程池中所有线程的执行步骤</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#CyclicBarrier示例"><span class="toc-nav-text">CyclicBarrier示例</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#CountDownLatch示例"><span class="toc-nav-text">CountDownLatch示例</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java集合"><span class="toc-nav-text">Java集合</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Collection概述"><span class="toc-nav-text">Collection概述</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#List"><span class="toc-nav-text">List</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Vector"><span class="toc-nav-text">Vector</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#LinkedList"><span class="toc-nav-text">LinkedList</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Set"><span class="toc-nav-text">Set</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#HashSet"><span class="toc-nav-text">HashSet</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TreeSet"><span class="toc-nav-text">TreeSet</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#定义MyInteger2对象"><span class="toc-nav-text">定义MyInteger2对象</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Map"><span class="toc-nav-text">Map</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#非排序Map"><span class="toc-nav-text">非排序Map</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Hashtable示例"><span class="toc-nav-text">Hashtable示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#排序Map"><span class="toc-nav-text">排序Map</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java序列化"><span class="toc-nav-text">Java序列化</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#序列化概述"><span class="toc-nav-text">序列化概述</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#简单的序列化示例"><span class="toc-nav-text">简单的序列化示例</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#隐藏非序列化信息"><span class="toc-nav-text">隐藏非序列化信息</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#自定义序列化过程"><span class="toc-nav-text">自定义序列化过程</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#探讨serialVersionUID"><span class="toc-nav-text">探讨serialVersionUID</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#有继承结构的序列化"><span class="toc-nav-text">有继承结构的序列化</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java反射"><span class="toc-nav-text">Java反射</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#反射简单示例"><span class="toc-nav-text">反射简单示例</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#获取方法及字段信息"><span class="toc-nav-text">获取方法及字段信息　　</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#实例化对象"><span class="toc-nav-text">实例化对象</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#调用对象的方法"><span class="toc-nav-text">调用对象的方法</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#修改字段的值"><span class="toc-nav-text">修改字段的值</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Annotation探索"><span class="toc-nav-text">Annotation探索</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Annotation基本操作"><span class="toc-nav-text">Annotation基本操作</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#在WebService中使用Annotation"><span class="toc-nav-text">在WebService中使用Annotation</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#动态代理机制"><span class="toc-nav-text">动态代理机制</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java一些基础概念"><span class="toc-nav-text">Java一些基础概念</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#类的初始化顺序"><span class="toc-nav-text">类的初始化顺序</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#结论"><span class="toc-nav-text">结论　　</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#和String相关的一些事儿"><span class="toc-nav-text">和String相关的一些事儿</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#String类型变量的存储结构"><span class="toc-nav-text">String类型变量的存储结构</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Java中的字符串池"><span class="toc-nav-text">Java中的字符串池</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#String的这种设计属于享元模式吗？"><span class="toc-nav-text">String的这种设计属于享元模式吗？</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#字符串的反转输出"><span class="toc-nav-text">字符串的反转输出</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#眼花缭乱的方法调用"><span class="toc-nav-text">眼花缭乱的方法调用</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#有继承关系结构中的方法调用"><span class="toc-nav-text">有继承关系结构中的方法调用</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#到底是值传递还是引用传递"><span class="toc-nav-text">到底是值传递还是引用传递</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#final-finally-finalize的区别"><span class="toc-nav-text">final/finally/finalize的区别</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#关于基本类型的一些事儿"><span class="toc-nav-text">关于基本类型的一些事儿</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#关于基本类型的一些结论（来自《Java面试解惑》）"><span class="toc-nav-text">关于基本类型的一些结论（来自《Java面试解惑》）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#和日期相关的一些事儿"><span class="toc-nav-text">和日期相关的一些事儿</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Java的JDBC"><span class="toc-nav-text">Java的JDBC</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#概述"><span class="toc-nav-text">概述</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#一个简单JDBC示例"><span class="toc-nav-text">一个简单JDBC示例</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#如何建立数据库连接"><span class="toc-nav-text">如何建立数据库连接</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#自动加载数据库驱动"><span class="toc-nav-text">自动加载数据库驱动</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#JDBC中的基本操作"><span class="toc-nav-text">JDBC中的基本操作</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#如何实现CRUD"><span class="toc-nav-text">如何实现CRUD</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#如何调用存储过程"><span class="toc-nav-text">如何调用存储过程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何调用不带参数的存储过程"><span class="toc-nav-text">如何调用不带参数的存储过程</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何调用带参数的存储过程"><span class="toc-nav-text">如何调用带参数的存储过程</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#获取数据库以及结果集的metadata信息"><span class="toc-nav-text">获取数据库以及结果集的metadata信息</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#获取数据库的metadata信息"><span class="toc-nav-text">获取数据库的metadata信息</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#获取结果集的元数据信息"><span class="toc-nav-text">获取结果集的元数据信息</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#基于ResultSet的操作"><span class="toc-nav-text">基于ResultSet的操作</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#预处理以及批处理"><span class="toc-nav-text">预处理以及批处理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#预处理"><span class="toc-nav-text">预处理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#批处理"><span class="toc-nav-text">批处理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#预处理和批处理相结合"><span class="toc-nav-text">预处理和批处理相结合</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#数据库事务"><span class="toc-nav-text">数据库事务</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#简单的数据库事务"><span class="toc-nav-text">简单的数据库事务</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#带有SavePoint的事务"><span class="toc-nav-text">带有SavePoint的事务</span></a></li></ol></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://m.iskei.cn/blog/44393.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "imcco";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Java技术重点回顾",
        owner: "imcco",
        repo: "m.github.io",
        oauth: {
          client_id: "ee7ec372a862879e3f2c",
          client_secret: "00a58ccb1a0555f87a87dc3a1b779ee8d12ded80"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2018 | Proudly powered by <a href="https://vuejs.io" target="_blank">vueJs</a>
    <br>
    Theme by <a href="https://github.com/imcco">Imcco</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>

  </body>
</html>